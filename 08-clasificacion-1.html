<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Aprendizaje Máquina - 8&nbsp; Clasificación y probabilidad</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./09-clasificacion-2.html" rel="next">
<link href="./07-intervalos-predictivos.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./08-clasificacion-1.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Clasificación y probabilidad</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Buscar" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Aprendizaje Máquina</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Buscar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temario y referencias</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduccion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-principios-supervisado.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Principios de aprendizaje supervisado</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-metodos-locales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Métodos locales no estructurados</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-lineales-ingenieria.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Métodos lineales e ingenería de entradas</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-regularizacion-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Regularización y variabilidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-redes-neuronales-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Redes neuronales (intro)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-intervalos-predictivos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Incertidumbre en las predicciones</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-clasificacion-1.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Clasificación y probabilidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-clasificacion-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Decisiones de clasificación</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-clasificacion-calibracion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Calibración de probabilidades</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-val-cruzada.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Entrenamiento, Validación y Prueba</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-arboles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Métodos basados en árboles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-arboles-boosting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Métodos basados en árboles: boosting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-interpretacion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Interpretación de modelos</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./81-apendice-descenso.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Apéndice 1: descenso en gradiente</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./82-apendice-descenso-estocastico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Apéndice 2: Descenso estocástico</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-referencias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referencias</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#qué-estimar-en-problemas-de-clasificación" id="toc-qué-estimar-en-problemas-de-clasificación" class="nav-link active" data-scroll-target="#qué-estimar-en-problemas-de-clasificación"><span class="header-section-number">8.1</span> ¿Qué estimar en problemas de clasificación?</a></li>
  <li><a href="#estimación-de-probabilidades-de-clase" id="toc-estimación-de-probabilidades-de-clase" class="nav-link" data-scroll-target="#estimación-de-probabilidades-de-clase"><span class="header-section-number">8.2</span> Estimación de probabilidades de clase</a></li>
  <li><a href="#k-vecinos-más-cercanos" id="toc-k-vecinos-más-cercanos" class="nav-link" data-scroll-target="#k-vecinos-más-cercanos"><span class="header-section-number">8.3</span> k-vecinos más cercanos</a></li>
  <li><a href="#ejemplo-diabetes" id="toc-ejemplo-diabetes" class="nav-link" data-scroll-target="#ejemplo-diabetes"><span class="header-section-number">8.4</span> Ejemplo: diabetes</a></li>
  <li><a href="#pérdida-logarítmica" id="toc-pérdida-logarítmica" class="nav-link" data-scroll-target="#pérdida-logarítmica"><span class="header-section-number">8.5</span> Pérdida logarítmica</a></li>
  <li><a href="#clasificación-multinomial" id="toc-clasificación-multinomial" class="nav-link" data-scroll-target="#clasificación-multinomial"><span class="header-section-number">8.6</span> Clasificación multinomial</a></li>
  <li><a href="#regresión-logística" id="toc-regresión-logística" class="nav-link" data-scroll-target="#regresión-logística"><span class="header-section-number">8.7</span> Regresión logística</a></li>
  <li><a href="#ejercicio-datos-de-diabetes" id="toc-ejercicio-datos-de-diabetes" class="nav-link" data-scroll-target="#ejercicio-datos-de-diabetes"><span class="header-section-number">8.8</span> Ejercicio: datos de diabetes</a></li>
  <li><a href="#probabilidades-y-pérdida-0-1" id="toc-probabilidades-y-pérdida-0-1" class="nav-link" data-scroll-target="#probabilidades-y-pérdida-0-1"><span class="header-section-number">8.9</span> Probabilidades y pérdida 0-1</a></li>
  <li><a href="#regresión-logística-multinomial" id="toc-regresión-logística-multinomial" class="nav-link" data-scroll-target="#regresión-logística-multinomial"><span class="header-section-number">8.10</span> Regresión logística multinomial</a></li>
  <li><a href="#ejemplo-clasificación-de-ropa" id="toc-ejemplo-clasificación-de-ropa" class="nav-link" data-scroll-target="#ejemplo-clasificación-de-ropa"><span class="header-section-number">8.11</span> Ejemplo: clasificación de ropa</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Clasificación y probabilidad</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Una variable <span class="math inline">\(g\)</span> <strong>categórica</strong> o <strong>cualitativa</strong> toma valores que no son numéricos. Por ejemplo, si <span class="math inline">\(g\)</span> denota el estado del contrato de celular de un cliente dentro de un año, podríamos tener <span class="math inline">\(g\in \{ activo, cancelado\}\)</span>.</p>
<p>En un <strong>problema de clasificación</strong> buscamos predecir una variable respuesta categórica <span class="math inline">\(g\)</span> en función de otras variables de entrada <span class="math inline">\(x=(x_1,x_2,\ldots, x_p)\)</span>.</p>
<section id="ejemplos" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplos">Ejemplos</h4>
<ul>
<li><p>Predecir si un cliente cae en impago de una tarjeta de crédito, de forma que podemos tener <span class="math inline">\(g=corriente\)</span> o <span class="math inline">\(g=impago\)</span>. Variables de entrada podrían ser <span class="math inline">\(x_1=\)</span> porcentaje de saldo usado, <span class="math inline">\(x_2=\)</span> atrasos en los últimos 3 meses, <span class="math inline">\(x_3=\)</span> edad, etc</p></li>
<li><p>En reconocimiento de imágenes quiza tenemos que <span class="math inline">\(g\)</span> pertenece a un conjunto que típicamente contiene hasta cientos de valores (manzana, árbol, pluma, perro, coche, persona, cara, etc.). Las <span class="math inline">\(x_j\)</span> son valores de pixeles de la imagen para tres canales (rojo, verde y azul). Si las imágenes son de 100x100, tendríamos 30,000 variables de entrada.</p></li>
</ul>
</section>
<section id="qué-estimar-en-problemas-de-clasificación" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="qué-estimar-en-problemas-de-clasificación"><span class="header-section-number">8.1</span> ¿Qué estimar en problemas de clasificación?</h2>
<p>Cuando clasificamos según entradas <span class="math inline">\(x\)</span> en una clase, podemos estar más o menos seguros de la clasificación. Por ejemplo: puede ser que la la decisión es clasificar a un cliente dado como “impago en los próximos tres meses”. La incertidumbe está en que quizá la probabilidad de impago es de 95%, pero existe una probabilidad de 5% de que el cliente se mantenga al corriente. Esto es muy diferente a un cliente con probabilidades respectivas de 60% y 40%. En general, cualquier tipo de análisis costo-beneficio que utilice el modelo debe intentar tomar en cuenta que estos dos clientes son muy diferentes.</p>
<p>Consideramos primero un problema de clasificación binaria, y denotamos por <span class="math inline">\(y\in \{0,1\}\)</span> la indicadora de una de las dos de las categorías. Sea <span class="math inline">\(p(x)\)</span> una función que mide qué tan seguros estamos que la observación es de clase <span class="math inline">\(y=1\)</span>. Supondremos que <span class="math inline">\(p(x)\)</span> es una función que toma valores entre <span class="math inline">\(0\)</span> y <span class="math inline">\(1\)</span>.</p>
<p>Ahora necesitamos una función de pérdida <span class="math inline">\(L(y, p)\)</span> que evalúa el error cuando nuestra medida de confianza es <span class="math inline">\(p\)</span> y la clase observada es <span class="math inline">\(y\)</span>. Podemos usar por ejemplo la pérdida cuadrática:</p>
<p><span class="math display">\[L(y, p) = (y - p)^2,\]</span> que también se llama pérdida de Brier en este contexto. Igual que en regresión, dada una población, podemos encontrar la función <span class="math inline">\(p^*(x)\)</span> que minimiza la pérdida esperada sobre toda la población. En este caso, <span class="math display">\[p^*(x) = E(y|x) = P(y=1|x)\]</span> es decir, la verdadera probabilidad de que la clase sea 1 es la función <span class="math inline">\(p^*(x)\)</span> que minimiza la pérdida cuadrática. Si usamos por ejemplo la pérdida absoluta, entonces la solucion es tomar como <span class="math inline">\(p^* (x) = 1\)</span> si <span class="math inline">\(P(y= 1|x) &gt; 0.5\)</span>, y <span class="math inline">\(p^*(x)= 0\)</span> en otro caso (muestra por qué).</p>
<p>Aunque utilizaremos otras pérdidas mejor adaptadas para el problema del clasificación, por el momento notemos que igual que planteamos el problema aprendizaje en regresión como un problema de aproximar una curva <span class="math inline">\(f^*(x)\)</span> óptima con una función <span class="math inline">\(\hat{f}(x)\)</span> construida a partir de datos, igualmente podemos plantear el problema de clasificación binaria como sigue:</p>
<ul>
<li>Buscamos algoritmos <span class="math inline">\({\mathcal L} \to \hat{p}(x)\)</span> tal que <span class="math inline">\(\hat{p}(x)\)</span> está cercana a la probabilidad de clase <span class="math inline">\(p^* (x) = P(y=1 |x)\)</span>.</li>
<li>Los argumentos de error irreducible, sesgo y variabilidad aplican también en esta situación bajo la pérdida de Brier y puede darse un argumento para cada clase (considerando <span class="math inline">\(y_k - \hat{p}_k(x)\)</span> como residual). En este caso, el error irreducible proviene del hecho de que <span class="math inline">\(p^*_k(x)\)</span> no necesariamente toman solo los valores 0 o 1, y dadas las <span class="math inline">\(x\)</span>, existe incertidumbre en la clase que vamos a observar.</li>
</ul>
<section id="ejemplo" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo">Ejemplo</h4>
<p>(Impago de tarjetas de crédito) Supongamos que <span class="math inline">\(x=\)</span> porcentaje del crédito máximo usado, y <span class="math inline">\(y\in\{0, 1\}\)</span>, donde <span class="math inline">\(1\)</span> corresponde al corriente y <span class="math inline">\(0\)</span> representa impago. Las probabilidades condicionales de clase para la clase <em>al corriente</em> podrían ser, por ejemplo:</p>
<ul>
<li><span class="math inline">\(p(x) = P(y=1|x) =0.95\)</span> si <span class="math inline">\(x &lt; 0.15\)</span></li>
<li><span class="math inline">\(p(x) = P(y=1|x) = 0.95 - 0.7(x - 0.15)\)</span> si <span class="math inline">\(x&gt;=0.15\)</span></li>
</ul>
<p>Estas son probabilidades y no determinan el resultado, pues hay otras variables que influyen en que un cliente permanezca al corriente o no en sus pagos más allá de información contenida en el porcentaje de crédito usado. Nótese que estas probabilidades son diferentes a las no condicionadas, por ejempo, podríamos tener que a total <span class="math inline">\(P(y=1)=0.83\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>p_1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(x <span class="sc">&lt;</span> <span class="fl">0.15</span>, <span class="fl">0.95</span>, <span class="fl">0.95</span> <span class="sc">-</span> <span class="fl">0.7</span> <span class="sc">*</span> (x <span class="sc">-</span> <span class="fl">0.15</span>))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.01</span>)), <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> p_1)  <span class="sc">+</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Prob al corriente"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="384"></p>
</div>
</div>
</section>
</section>
<section id="estimación-de-probabilidades-de-clase" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="estimación-de-probabilidades-de-clase"><span class="header-section-number">8.2</span> Estimación de probabilidades de clase</h2>
<p>¿Cómo estimamos ahora las probabilidades de clase a partir de una muestra de entrenamiento? Veremos por ahora dos métodos: k-vecinos más cercanos y regresión logística.</p>
<section id="ejemplo-1" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-1">Ejemplo</h4>
<p>Vamos a generar unos datos con el modelo simple del ejemplo anterior:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>simular_impago <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">500</span>){</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># suponemos que los valores de x están concentrados en valores bajos,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># quizá la manera en que los créditos son otorgados</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    clases <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"al_corriente"</span>, <span class="st">"impago"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">rexp</span>(n, <span class="dv">100</span> <span class="sc">/</span> <span class="dv">40</span>), <span class="dv">1</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># las probabilidades de estar al corriente:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">&lt;-</span> <span class="fu">p_1</span>(x)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># finalmente, simulamos cuáles clientes siguen al corriente y cuales no:</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="fu">map_chr</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x), <span class="sc">~</span> <span class="fu">sample</span>(clases, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">c</span>(prob[.x], <span class="dv">1</span><span class="sc">-</span> prob[.x])))</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="fu">factor</span>(g, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"al_corriente"</span>, <span class="st">"impago"</span>))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    datos <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> x, <span class="at">p_1 =</span> prob, <span class="at">g =</span> g) <span class="sc">|&gt;</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">ifelse</span>(g <span class="sc">==</span> <span class="st">"al_corriente"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    datos</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">193</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>dat_ent  <span class="ot">&lt;-</span> <span class="fu">simular_impago</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(x, g, y) </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>dat_ent <span class="sc">|&gt;</span> <span class="fu">sample_n</span>(<span class="dv">20</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 3
         x g                y
     &lt;dbl&gt; &lt;fct&gt;        &lt;dbl&gt;
 1 0.118   al_corriente     1
 2 0.109   al_corriente     1
 3 0.444   al_corriente     1
 4 0.153   al_corriente     1
 5 0.100   al_corriente     1
 6 0.0109  al_corriente     1
 7 0.216   al_corriente     1
 8 1       impago           0
 9 0.0846  al_corriente     1
10 0.144   al_corriente     1
11 0.377   impago           0
12 0.0908  al_corriente     1
13 0.128   al_corriente     1
14 0.00262 al_corriente     1
15 0.411   al_corriente     1
16 0.545   al_corriente     1
17 0.402   al_corriente     1
18 0.0544  al_corriente     1
19 0.00265 al_corriente     1
20 0.0927  al_corriente     1</code></pre>
</div>
</div>
<p>Como este problema es de dos clases, podemos graficar como sigue (agregamos variación artificial en <span class="math inline">\(y\)</span> para evitar traslape de los puntos):</p>
<div class="cell" data-fig.asp="0.7">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>graf_1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dat_ent, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="fu">aes</span>(<span class="at">colour =</span> <span class="fu">factor</span>(g), <span class="at">y =</span> y), </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">width=</span><span class="fl">0.02</span>, <span class="at">height=</span><span class="fl">0.1</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">colour =</span> <span class="st">"Clase"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>graf_1 </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
</section>
<section id="k-vecinos-más-cercanos" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="k-vecinos-más-cercanos"><span class="header-section-number">8.3</span> k-vecinos más cercanos</h2>
<p>Para usar <span class="math inline">\(k\)</span>-vecinos más cercanos para estimar la probabilidades de clase para cada <span class="math inline">\(x\)</span>, podemos tomar una vecindad de la <span class="math inline">\(x\)</span> donde queremos predecir, y tomar el siguiente promedio:</p>
<p><span class="math display">\[\hat{p}(x) = \frac{1}{k}\sum_{x^{(i)} \in N_k(x)} y^{(i)},\]</span></p>
<p>que es la proporción de unos en una vecindad <span class="math inline">\(N_k(x)\)</span> de <span class="math inline">\(x\)</span>.</p>
<section id="ejemplo-2" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-2">Ejemplo</h4>
<p>Vamos a intentar estimar la probabilidad condicional de estar al corriente usando k vecinos más cercanos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>vmc_modelo <span class="ot">&lt;-</span> <span class="fu">nearest_neighbor</span>(<span class="at">neighbors =</span> <span class="dv">100</span>, <span class="at">weight_func =</span> <span class="st">"gaussian"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>ajuste_vmc <span class="ot">&lt;-</span> vmc_modelo <span class="sc">|&gt;</span> <span class="fu">fit</span>(g <span class="sc">~</span> x, dat_ent)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># para graficar:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>graf_kvmc <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.01</span>))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>graf_kvmc <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste_vmc, graf_kvmc, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(graf_kvmc) <span class="sc">|&gt;</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(x, .pred_al_corriente)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>graf_kvmc <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
      x .pred_al_corriente
  &lt;dbl&gt;              &lt;dbl&gt;
1  0                 0.947
2  0.01              0.946
3  0.02              0.948
4  0.03              0.954
5  0.04              0.973
6  0.05              0.985</code></pre>
</div>
</div>
<p>Y la curva roja da nuestra estimación de probabilidad de impago para cada $x4:</p>
<div class="cell" data-fig.asp="0.7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>graf_verdadero <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.01</span>), <span class="at">p_1 =</span> <span class="fu">p_1</span>(x))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>graf_2 <span class="ot">&lt;-</span> graf_1 <span class="sc">+</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graf_kvmc, <span class="fu">aes</span>(<span class="at">y =</span> .pred_al_corriente), <span class="at">colour =</span> <span class="st">'red'</span>, <span class="at">size=</span><span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graf_verdadero, <span class="fu">aes</span>(<span class="at">y =</span> p_1)) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Prob al corriente'</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">'% crédito usado'</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>graf_2</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Ahora podríamos usar una muestra de prueba para evaluar nuestra estimación, pues no tenemos la curva negra óptima para comparar.</p>
</section>
</section>
<section id="ejemplo-diabetes" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="ejemplo-diabetes"><span class="header-section-number">8.4</span> Ejemplo: diabetes</h2>
<p>Consideremos datos de diabetes en mujeres Pima:</p>
<p>A population of women who were at least 21 years old, of Pima Indian heritage and living near Phoenix, Arizona, was tested for diabetes according to World Health Organization criteria. The data were collected by the US National Institute of Diabetes and Digestive and Kidney Diseases. We used the 532 complete records after dropping the (mainly missing) data on serum insulin.</p>
<ul>
<li>npreg number of pregnancies.</li>
<li>glu plasma glucose concentration in an oral glucose tolerance test.</li>
<li>bp diastolic blood pressure (mm Hg).</li>
<li>skin triceps skin fold thickness (mm).</li>
<li>bmi body mass index (weight in kg/(height in m)^2).</li>
<li>ped diabetes pedigree function.</li>
<li>age age in years.</li>
<li>type Yes or No, for diabetic according to WHO criteria.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>diabetes_ent <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(MASS<span class="sc">::</span>Pima.tr)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>diabetes_pr <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(MASS<span class="sc">::</span>Pima.te)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>diabetes_ent</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 200 × 8
   npreg   glu    bp  skin   bmi   ped   age type 
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;
 1     5    86    68    28  30.2 0.364    24 No   
 2     7   195    70    33  25.1 0.163    55 Yes  
 3     5    77    82    41  35.8 0.156    35 No   
 4     0   165    76    43  47.9 0.259    26 No   
 5     0   107    60    25  26.4 0.133    23 No   
 6     5    97    76    27  35.6 0.378    52 Yes  
 7     3    83    58    31  34.3 0.336    25 No   
 8     1   193    50    16  25.9 0.655    24 No   
 9     3   142    80    15  32.4 0.2      63 No   
10     2   128    78    37  43.3 1.22     31 Yes  
# ℹ 190 more rows</code></pre>
</div>
</div>
<p>Intentaremos predecir diabetes dependiendo del una medición de glucosa en la sangre:</p>
<div class="cell" data-fig.asp="0.7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diabetes_ent, <span class="fu">aes</span>(<span class="at">x =</span> glu, <span class="at">y=</span> <span class="fu">ifelse</span>(type<span class="sc">==</span><span class="st">'Yes'</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="at">colour =</span> type)) <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="fl">0.05</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Usamos <span class="math inline">\(30\)</span> vecinos más cercanos para estimar <span class="math inline">\(p(x)\)</span>:</p>
<div class="cell" data-fig.asp="0.7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>graf_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">glu =</span> <span class="fu">seq</span>(<span class="dv">50</span>, <span class="dv">200</span>, <span class="dv">1</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ajustar modelo</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ajuste_vmc_diabetes <span class="ot">&lt;-</span> vmc_modelo <span class="sc">|&gt;</span> <span class="fu">set_args</span>(<span class="at">neighbors =</span> <span class="dv">50</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(type <span class="sc">~</span> glu, diabetes_ent)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># graficar</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>graf_data <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste_vmc_diabetes, graf_data, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(graf_data) <span class="sc">|&gt;</span> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(glu, .pred_Yes)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diabetes_ent, <span class="fu">aes</span>(<span class="at">x =</span> glu)) <span class="sc">+</span> </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">as.numeric</span>(type <span class="sc">==</span> <span class="st">"Yes"</span>), <span class="at">colour =</span> type)) <span class="sc">+</span> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> graf_data, <span class="fu">aes</span>(<span class="at">y =</span> .pred_Yes)) <span class="sc">+</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Probabilidad diabetes'</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Finalmente, evaluamos por ejemplo con la pérdida de Brier:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>preds_tbl <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste_vmc_diabetes, diabetes_pr, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(diabetes_pr <span class="sc">|&gt;</span> <span class="fu">select</span>(type)) <span class="sc">|&gt;</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">as.numeric</span>(type <span class="sc">==</span> <span class="st">"Yes"</span>)) </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>preds_tbl <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  .pred_No .pred_Yes type      y
     &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt; &lt;dbl&gt;
1    0.482    0.518  Yes       1
2    0.921    0.0793 No        0
3    0.902    0.0980 No        0
4    0.925    0.0752 Yes       1
5    0.250    0.750  Yes       1
6    0.342    0.658  Yes       1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>preds_tbl <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(<span class="at">truth =</span> y, <span class="at">estimate =</span> .pred_Yes)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard       0.405</code></pre>
</div>
</div>
<p>Podemos comparar este error con la predicción que haríamos usando la proporción de unos en los datos, por ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>promedio_ent <span class="ot">&lt;-</span> diabetes_ent <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">y =</span> type <span class="sc">==</span> <span class="st">"Yes"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(y) <span class="sc">|&gt;</span> <span class="fu">mean</span>()</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>preds_tbl <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">promedio =</span> promedio_ent) <span class="sc">|&gt;</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(<span class="at">truth =</span> y, <span class="at">estimate =</span> promedio)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard       0.470</code></pre>
</div>
</div>
<p>Finalmente, probemos usando todas las variables, teniendo cuidado de estandarizar las variables de entranda:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>receta_diabetes <span class="ot">&lt;-</span> <span class="fu">recipe</span>(type <span class="sc">~</span> ., diabetes_ent) <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>modelo_vmc <span class="ot">&lt;-</span> vmc_modelo <span class="sc">|&gt;</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_args</span>(<span class="at">neighbors =</span> <span class="dv">50</span>) </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>flujo_vmc_diabetes <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(receta_diabetes) <span class="sc">|&gt;</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(modelo_vmc)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>preds_todas <span class="ot">&lt;-</span> <span class="fu">fit</span>(flujo_vmc_diabetes, diabetes_ent) <span class="sc">|&gt;</span> </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(diabetes_pr, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(diabetes_pr <span class="sc">|&gt;</span> <span class="fu">select</span>(type)) <span class="sc">|&gt;</span> </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">as.numeric</span>(type <span class="sc">==</span> <span class="st">"Yes"</span>)) </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>preds_todas <span class="sc">|&gt;</span> </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(<span class="at">truth =</span> y, <span class="at">estimate =</span> .pred_Yes)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard       0.396</code></pre>
</div>
</div>
</section>
<section id="pérdida-logarítmica" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="pérdida-logarítmica"><span class="header-section-number">8.5</span> Pérdida logarítmica</h2>
<p>La pérdida de Brier es una medida útil para evaluar modelos, pero tiene algunos defectos cuando se usa en el ajuste de probabilidades de clase. Uno importante es que es penaliza relativamente poco a errores donde predecimos por ejemplo <span class="math inline">\(\hat{p}_1(x) = 0.0001\)</span>, y resulta que observamos <span class="math inline">\(g=1\)</span>. La penalización es similar que cuando <span class="math inline">\(\hat{p}_1(x) = 0.01\)</span>, pero se puede argumentar que el primero de los errores es considerablemente más grave que el segundo.</p>
<p>Consideremos entonces que tenemos una estimación <span class="math inline">\(\hat{p}_g(x)\)</span> de las probabilidad de clase. Supongamos que observamos ahora <span class="math inline">\((x, g)\)</span> (la clase verdadera es <span class="math inline">\(g\)</span>).</p>
<ul>
<li>Si <span class="math inline">\(\hat{p}_{g}(x)\)</span> es muy cercana a uno, deberíamos penalizar poco, pues dimos probabilidad alta a la clase <span class="math inline">\(g\)</span> que ocurrió.</li>
<li>Si <span class="math inline">\(\hat{p}_{g}(x)\)</span> es chica, deberíamos penalizar más, pues dimos probabilidad baja a observar la clase <span class="math inline">\(g\)</span>.</li>
<li>Si <span class="math inline">\(\hat{p}_{g}(x)\)</span> es muy cercana a cero, y observamos <span class="math inline">\(g\)</span>, deberíamos hacer una penalización muy alta (convergiendo a <span class="math inline">\(\infty\)</span>, pues no es aceptable que sucedan eventos con probabilidad estimada extremadamente baja).</li>
</ul>
<p>Quisiéramos encontrar una función <span class="math inline">\(h\)</span> apropiada, de forma que la pérdida al observar <span class="math inline">\((x, g)\)</span> sea <span class="math display">\[s(\hat{p}_{g}(x)),\]</span> y que cumpla con los puntos arriba señalados. Entonces tenemos que</p>
<ul>
<li><span class="math inline">\(s\)</span> debe ser una función continua y decreciente en <span class="math inline">\([0,1]\)</span></li>
<li>Podemos poner <span class="math inline">\(s(1)=0\)</span> (no hay pérdida si ocurre algo con que dijimos tiene probabilidad 1)</li>
<li><span class="math inline">\(s(p)\)</span> debe ser muy grande is <span class="math inline">\(p\)</span> es muy chica.</li>
</ul>
<p>Una opción analíticamente conveniente es la <strong>pérdida logarítmica</strong>: <span class="math display">\[s(p) = - \log(p)\]</span></p>
<div class="cell" data-fig.asp="0.7">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>perdidas_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p =</span> <span class="fu">seq</span>(<span class="fl">0.01</span>, <span class="dv">1</span>, <span class="fl">0.001</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(logarítmica <span class="ot">=</span> <span class="sc">-</span> <span class="fu">log</span>(p), <span class="at">brier  =</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> logarítmica<span class="sc">:</span>brier, <span class="at">names_to =</span> <span class="st">"tipo"</span>, <span class="at">values_to =</span> <span class="st">"perdida"</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(perdidas_tbl, <span class="fu">aes</span>(<span class="at">x =</span> p, <span class="at">y =</span> perdida, <span class="at">colour =</span> tipo)) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.1</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Así que la pérdida para un caso con entradas <span class="math inline">\(x\)</span> y clase <span class="math inline">\(g\)</span> es</p>
<p><span class="math display">\[-\log \hat{p}_g (x)\]</span> Se puede demostrar que, igual que la pérdida de Brier, si queremos minimizar la pérdida logarítmica sobre toda la población, la solución está dada por las verdaderas probabilidades de clase</p>
<p><span class="math display">\[p^*(x) = E(y|x) = P(y = 1|x).\]</span></p>
<p>De modo que la función que queremos estimar es la misma en ambos casos. La pérdida de Brier sin embargo, es menos sensible a errores en los extremos de la escala de probabilidad, y puede producir estimaciones distintas cuando se usa en entrenamiento.</p>
<p><strong>Observaciones</strong>:</p>
<ul>
<li><p>La pérdida logarítmica también se llama <strong>devianza binomial</strong> o <strong>devianza multinomial</strong> en otros lugares, usualmente multipicada por 2 (lo cual no cambia sus propiedades).</p></li>
<li><p>Una razón importante para usar la pérdida logarítmica como el objetivo a minimizar es que equivale a la estimación por máxima verosimilitud (intenta demostrarlo).</p></li>
<li><p>No es fácil interpretar la pérdida logarítmica, pero es útil para ajustar y comparar modelos. Veremos otras medidas más fáciles de interpretar más adelante.</p></li>
</ul>
<p>Compara la siguiente definición con la que vimos para modelos de regresión:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pérdida logarítmica
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sea <span class="math display">\[{\mathcal L}=\{ (x^{(1)},g^{(1)}),(x^{(2)},g^{(2)}), \ldots, (x^{(N)}, g^{(N)}) \}\]</span> una muestra de entrenamiento, a partir de las cuales construimos mediante un algoritmo funciones estimadas <span class="math inline">\(\hat{p}_{g} (x)\)</span> para <span class="math inline">\(g=1,\ldots, K\)</span>. La <strong>pérdida logarítmica de entrenamiento</strong> está dada por <span class="math display">\[\begin{equation}
\overline{err} = - \frac{1}{N}\sum_{i=1}^N log(\hat{p}_{g^{(i)}} (x^{(i)}))
\end {equation}\]</span> Sea <span class="math display">\[{\mathcal T}=\{ (\mathbf{x}^{(1)},\mathbf{g}^{(1)}),(\mathbf{x}^{(2)},\mathbf{g}^{(2)}), \ldots, (\mathbf{x}^{(m)}, \mathbf{g}^{(m)}) \}\]</span> una muestra de prueba. La <strong>pérdida logarítmica de prueba</strong> es <span class="math display">\[\begin{equation}
\hat{Err} = - \frac{1}{m}\sum_{i=1}^m log(\hat{p}_{\mathbf{g}^{(i)}} (\mathbf{x}^{(i)}))
\end {equation}\]</span> que es una estimación de la devianza de predicción <span class="math display">\[-E\left [ \log(\hat{p}_g(x)) \right ],\]</span> donde el promedia se toma sobre todos los valores <span class="math inline">\((\mathbf{x}, \mathbf{g})\)</span> de la población.</p>
</div>
</div>
<section id="ejemplo-3" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-3">Ejemplo</h4>
<p>Regresamos a nuestros ejemplo simulado de impago de tarjetas de crédito. Primero calculamos la pérdida logarítmica de entrenamiento</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> \(x) <span class="sc">-</span><span class="fu">log</span>(x)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dat_log_loss <span class="ot">&lt;-</span> ajuste_vmc <span class="sc">|&gt;</span>  </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(dat_ent, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(dat_ent) <span class="sc">|&gt;</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(x, g, .pred_impago, .pred_al_corriente)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>dat_log_loss <span class="ot">&lt;-</span> dat_log_loss <span class="sc">|&gt;</span>  </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hat_p_g =</span> <span class="fu">ifelse</span>(g<span class="sc">==</span><span class="st">"impago"</span>, .pred_impago, .pred_al_corriente))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Nótese que dependiendo de qué clase observamos (columna <span class="math inline">\(g\)</span>), extraemos la probabilidad correspondiente a la columna hat_p_g:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">125</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>dat_log_loss <span class="sc">|&gt;</span> <span class="fu">sample_n</span>(<span class="dv">20</span>) <span class="sc">|&gt;</span> <span class="fu">gt</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="qizcdrjzgs" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#qizcdrjzgs table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#qizcdrjzgs thead, #qizcdrjzgs tbody, #qizcdrjzgs tfoot, #qizcdrjzgs tr, #qizcdrjzgs td, #qizcdrjzgs th {
  border-style: none;
}

#qizcdrjzgs p {
  margin: 0;
  padding: 0;
}

#qizcdrjzgs .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#qizcdrjzgs .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#qizcdrjzgs .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#qizcdrjzgs .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#qizcdrjzgs .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#qizcdrjzgs .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qizcdrjzgs .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#qizcdrjzgs .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#qizcdrjzgs .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#qizcdrjzgs .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#qizcdrjzgs .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#qizcdrjzgs .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#qizcdrjzgs .gt_spanner_row {
  border-bottom-style: hidden;
}

#qizcdrjzgs .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#qizcdrjzgs .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#qizcdrjzgs .gt_from_md > :first-child {
  margin-top: 0;
}

#qizcdrjzgs .gt_from_md > :last-child {
  margin-bottom: 0;
}

#qizcdrjzgs .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#qizcdrjzgs .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#qizcdrjzgs .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#qizcdrjzgs .gt_row_group_first td {
  border-top-width: 2px;
}

#qizcdrjzgs .gt_row_group_first th {
  border-top-width: 2px;
}

#qizcdrjzgs .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#qizcdrjzgs .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#qizcdrjzgs .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#qizcdrjzgs .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qizcdrjzgs .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#qizcdrjzgs .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#qizcdrjzgs .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#qizcdrjzgs .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#qizcdrjzgs .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qizcdrjzgs .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#qizcdrjzgs .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#qizcdrjzgs .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#qizcdrjzgs .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#qizcdrjzgs .gt_left {
  text-align: left;
}

#qizcdrjzgs .gt_center {
  text-align: center;
}

#qizcdrjzgs .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#qizcdrjzgs .gt_font_normal {
  font-weight: normal;
}

#qizcdrjzgs .gt_font_bold {
  font-weight: bold;
}

#qizcdrjzgs .gt_font_italic {
  font-style: italic;
}

#qizcdrjzgs .gt_super {
  font-size: 65%;
}

#qizcdrjzgs .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#qizcdrjzgs .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#qizcdrjzgs .gt_indent_1 {
  text-indent: 5px;
}

#qizcdrjzgs .gt_indent_2 {
  text-indent: 10px;
}

#qizcdrjzgs .gt_indent_3 {
  text-indent: 15px;
}

#qizcdrjzgs .gt_indent_4 {
  text-indent: 20px;
}

#qizcdrjzgs .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="x">x</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="g">g</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id=".pred_impago">.pred_impago</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id=".pred_al_corriente">.pred_al_corriente</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="hat_p_g">hat_p_g</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="x" class="gt_row gt_right">0.19852287</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.14038901</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.8596110</td>
<td headers="hat_p_g" class="gt_row gt_right">0.85961099</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.67376004</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.50190033</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.4980997</td>
<td headers="hat_p_g" class="gt_row gt_right">0.49809967</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.05182251</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.01304586</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9869541</td>
<td headers="hat_p_g" class="gt_row gt_right">0.98695414</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.78516363</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.53011453</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.4698855</td>
<td headers="hat_p_g" class="gt_row gt_right">0.46988547</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.51357278</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.32252677</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.6774732</td>
<td headers="hat_p_g" class="gt_row gt_right">0.67747323</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.11636840</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.08958375</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9104162</td>
<td headers="hat_p_g" class="gt_row gt_right">0.91041625</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.50414410</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.30908738</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.6909126</td>
<td headers="hat_p_g" class="gt_row gt_right">0.30908738</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.68843401</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.50778339</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.4922166</td>
<td headers="hat_p_g" class="gt_row gt_right">0.50778339</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.74915741</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.52349703</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.4765030</td>
<td headers="hat_p_g" class="gt_row gt_right">0.52349703</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.15106073</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.06850996</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9314900</td>
<td headers="hat_p_g" class="gt_row gt_right">0.93149004</td></tr>
    <tr><td headers="x" class="gt_row gt_right">1.00000000</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.57659107</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.4234089</td>
<td headers="hat_p_g" class="gt_row gt_right">0.57659107</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.07148778</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.02543890</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9745611</td>
<td headers="hat_p_g" class="gt_row gt_right">0.97456110</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.08934583</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.06888669</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9311133</td>
<td headers="hat_p_g" class="gt_row gt_right">0.93111331</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.32848650</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.21323646</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.7867635</td>
<td headers="hat_p_g" class="gt_row gt_right">0.78676354</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.20386137</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.14978783</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.8502122</td>
<td headers="hat_p_g" class="gt_row gt_right">0.85021217</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.67871350</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.50258385</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.4974162</td>
<td headers="hat_p_g" class="gt_row gt_right">0.50258385</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.19050443</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.12406591</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.8759341</td>
<td headers="hat_p_g" class="gt_row gt_right">0.87593409</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.18182276</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.10562898</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.8943710</td>
<td headers="hat_p_g" class="gt_row gt_right">0.89437102</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.26726265</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.16922039</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.8307796</td>
<td headers="hat_p_g" class="gt_row gt_right">0.83077961</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.02035980</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.05230648</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9476935</td>
<td headers="hat_p_g" class="gt_row gt_right">0.05230648</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>Ahora aplicamos la función <span class="math inline">\(s\)</span> que describimos arriba, y promediamos sobre el conjunto de entrenamiento:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>dat_log_loss <span class="ot">&lt;-</span> dat_log_loss <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">dev =</span> <span class="fu">s</span>(hat_p_g))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>dat_log_loss <span class="sc">|&gt;</span> <span class="fu">sample_n</span>(<span class="dv">20</span>) <span class="sc">|&gt;</span> <span class="fu">gt</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="efaeqjgpdl" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#efaeqjgpdl table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#efaeqjgpdl thead, #efaeqjgpdl tbody, #efaeqjgpdl tfoot, #efaeqjgpdl tr, #efaeqjgpdl td, #efaeqjgpdl th {
  border-style: none;
}

#efaeqjgpdl p {
  margin: 0;
  padding: 0;
}

#efaeqjgpdl .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#efaeqjgpdl .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#efaeqjgpdl .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#efaeqjgpdl .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#efaeqjgpdl .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#efaeqjgpdl .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#efaeqjgpdl .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#efaeqjgpdl .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#efaeqjgpdl .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#efaeqjgpdl .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#efaeqjgpdl .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#efaeqjgpdl .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#efaeqjgpdl .gt_spanner_row {
  border-bottom-style: hidden;
}

#efaeqjgpdl .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#efaeqjgpdl .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#efaeqjgpdl .gt_from_md > :first-child {
  margin-top: 0;
}

#efaeqjgpdl .gt_from_md > :last-child {
  margin-bottom: 0;
}

#efaeqjgpdl .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#efaeqjgpdl .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#efaeqjgpdl .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#efaeqjgpdl .gt_row_group_first td {
  border-top-width: 2px;
}

#efaeqjgpdl .gt_row_group_first th {
  border-top-width: 2px;
}

#efaeqjgpdl .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#efaeqjgpdl .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#efaeqjgpdl .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#efaeqjgpdl .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#efaeqjgpdl .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#efaeqjgpdl .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#efaeqjgpdl .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#efaeqjgpdl .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#efaeqjgpdl .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#efaeqjgpdl .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#efaeqjgpdl .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#efaeqjgpdl .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#efaeqjgpdl .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#efaeqjgpdl .gt_left {
  text-align: left;
}

#efaeqjgpdl .gt_center {
  text-align: center;
}

#efaeqjgpdl .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#efaeqjgpdl .gt_font_normal {
  font-weight: normal;
}

#efaeqjgpdl .gt_font_bold {
  font-weight: bold;
}

#efaeqjgpdl .gt_font_italic {
  font-style: italic;
}

#efaeqjgpdl .gt_super {
  font-size: 65%;
}

#efaeqjgpdl .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#efaeqjgpdl .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#efaeqjgpdl .gt_indent_1 {
  text-indent: 5px;
}

#efaeqjgpdl .gt_indent_2 {
  text-indent: 10px;
}

#efaeqjgpdl .gt_indent_3 {
  text-indent: 15px;
}

#efaeqjgpdl .gt_indent_4 {
  text-indent: 20px;
}

#efaeqjgpdl .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="x">x</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="g">g</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id=".pred_impago">.pred_impago</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id=".pred_al_corriente">.pred_al_corriente</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="hat_p_g">hat_p_g</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="dev">dev</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="x" class="gt_row gt_right">0.32253044</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.21043820</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.7895618</td>
<td headers="hat_p_g" class="gt_row gt_right">0.7895618</td>
<td headers="dev" class="gt_row gt_right">0.23627717</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.10851963</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.09528056</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9047194</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9047194</td>
<td headers="dev" class="gt_row gt_right">0.10013039</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.11801945</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.08830654</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9116935</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9116935</td>
<td headers="dev" class="gt_row gt_right">0.09245146</td></tr>
    <tr><td headers="x" class="gt_row gt_right">1.00000000</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.57659107</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.4234089</td>
<td headers="hat_p_g" class="gt_row gt_right">0.5765911</td>
<td headers="dev" class="gt_row gt_right">0.55062199</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.11771241</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.08871380</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9112862</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9112862</td>
<td headers="dev" class="gt_row gt_right">0.09289827</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.03576024</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.03671995</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9632800</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9632800</td>
<td headers="dev" class="gt_row gt_right">0.03741110</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.02947193</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.04638861</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9536114</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9536114</td>
<td headers="dev" class="gt_row gt_right">0.04749904</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.06708467</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.01865320</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9813468</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9813468</td>
<td headers="dev" class="gt_row gt_right">0.01882937</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.52670471</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.34240787</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.6575921</td>
<td headers="hat_p_g" class="gt_row gt_right">0.6575921</td>
<td headers="dev" class="gt_row gt_right">0.41917040</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.48074458</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.27713415</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.7228659</td>
<td headers="hat_p_g" class="gt_row gt_right">0.2771341</td>
<td headers="dev" class="gt_row gt_right">1.28325360</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.75320749</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.52403777</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.4759622</td>
<td headers="hat_p_g" class="gt_row gt_right">0.5240378</td>
<td headers="dev" class="gt_row gt_right">0.64619152</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.28789759</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.18845940</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.8115406</td>
<td headers="hat_p_g" class="gt_row gt_right">0.8115406</td>
<td headers="dev" class="gt_row gt_right">0.20882086</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.50724729</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.31267931</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.6873207</td>
<td headers="hat_p_g" class="gt_row gt_right">0.6873207</td>
<td headers="dev" class="gt_row gt_right">0.37495430</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.65972691</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.49530580</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.5046942</td>
<td headers="hat_p_g" class="gt_row gt_right">0.4953058</td>
<td headers="dev" class="gt_row gt_right">0.70257994</td></tr>
    <tr><td headers="x" class="gt_row gt_right">1.00000000</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.57659107</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.4234089</td>
<td headers="hat_p_g" class="gt_row gt_right">0.4234089</td>
<td headers="dev" class="gt_row gt_right">0.85941682</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.03525545</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.03771126</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9622887</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9622887</td>
<td headers="dev" class="gt_row gt_right">0.03844073</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.53221265</td>
<td headers="g" class="gt_row gt_center">impago</td>
<td headers=".pred_impago" class="gt_row gt_right">0.35093998</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.6490600</td>
<td headers="hat_p_g" class="gt_row gt_right">0.3509400</td>
<td headers="dev" class="gt_row gt_right">1.04714008</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.12557127</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.08047375</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9195263</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9195263</td>
<td headers="dev" class="gt_row gt_right">0.08389669</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.12686269</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.07830790</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9216921</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9216921</td>
<td headers="dev" class="gt_row gt_right">0.08154406</td></tr>
    <tr><td headers="x" class="gt_row gt_right">0.11702054</td>
<td headers="g" class="gt_row gt_center">al_corriente</td>
<td headers=".pred_impago" class="gt_row gt_right">0.08882314</td>
<td headers=".pred_al_corriente" class="gt_row gt_right">0.9111769</td>
<td headers="hat_p_g" class="gt_row gt_right">0.9111769</td>
<td headers="dev" class="gt_row gt_right">0.09301826</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dat_log_loss <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> <span class="fu">summarise</span>(<span class="at">lloss_entrena =</span> <span class="fu">mean</span>(dev))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  lloss_entrena
          &lt;dbl&gt;
1         0.421</code></pre>
</div>
</div>
<p>Que también podemos calcular como sigue:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>dat_log_loss <span class="sc">|&gt;</span> <span class="fu">mn_log_loss</span>(g, .pred_al_corriente) <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.estimate =</span> .estimate )</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 mn_log_loss binary         0.421</code></pre>
</div>
</div>
<p>Recordemos que la devianza de entrenamiento no es la cantidad que evalúa el desempeño del modelo. Hagamos el cálculo entonces para una muestra de prueba:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1213</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>dat_prueba <span class="ot">&lt;-</span> <span class="fu">simular_impago</span>(<span class="at">n =</span> <span class="dv">5000</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(x, g)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="do">## calcular para muestra de prueba</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>dat_log_loss_prueba <span class="ot">&lt;-</span> ajuste_vmc <span class="sc">|&gt;</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(dat_prueba, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(dat_prueba) <span class="sc">|&gt;</span> </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(x, g, .pred_impago, .pred_al_corriente)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>dat_log_loss_prueba <span class="ot">&lt;-</span> dat_log_loss_prueba <span class="sc">|&gt;</span> </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hat_p_g =</span> <span class="fu">ifelse</span>(g <span class="sc">==</span> <span class="st">"al_corriente"</span>, .pred_al_corriente, .pred_impago))</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>dat_log_loss_prueba <span class="ot">&lt;-</span> dat_log_loss_prueba <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">log_loss =</span> <span class="fu">s</span>(hat_p_g))</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>dat_log_loss_prueba <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> <span class="fu">summarise</span>(<span class="at">log_loss_prueba =</span> <span class="fu">mean</span>(log_loss))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  log_loss_prueba
            &lt;dbl&gt;
1           0.434</code></pre>
</div>
</div>
</section>
</section>
<section id="clasificación-multinomial" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="clasificación-multinomial"><span class="header-section-number">8.6</span> Clasificación multinomial</h2>
<p>Cuando tenemos sólo dos clases (clasificación binaria), basta con estimar una probabilidad de clase, pues la segunda es complemento de la primera. Para tres o más clases introducimos notación adicional:</p>
<ul>
<li><p>Consideramos un problema donde <span class="math inline">\(g\)</span> puede ser una de <span class="math inline">\(K\)</span> clases posibles. Tenemos <span class="math inline">\(K\)</span> probabilidades de clase <span class="math inline">\(p(x) = (p_1(x), p_2(x), \ldots p_K(x))\)</span> que deben sumar 1 (de forma que una de ellas es redundante dadas las otras).</p></li>
<li><p>Definimos <span class="math inline">\((y_1,y_2, \ldots, y_k)\)</span> variables indicadoras de las categorías, donde <span class="math inline">\(y_k = 1\)</span> cuando <span class="math inline">\(g = k\)</span> y <span class="math inline">\(y_k = 0\)</span> en otro caso.</p></li>
</ul>
<p>La pérdida de Brier en este caso se puede definir como</p>
<p><span class="math display">\[L(g, p(x)) = \sum_{k=1}^K (y_k - p_k(x))^2 = (1 - p_g(x))^2 + \sum_{k\neq g} (p_k(x))^2\]</span> Esto quiere decir que el score de Brier es chico cuando <span class="math inline">\(p_g(x)\)</span>, la probabilidad de la clase <span class="math inline">\(g\)</span>, es cercana a uno y el resto de las probabilidades son cercanas a 0 (verifica que esta definición es equivalente para dos clases según la definición mostrada arriba para clasificación binaria). En este caso, la solución teórica que minimiza esta pérdida promediada sobre toda la población es</p>
<p><span class="math display">\[p_k^*(x) = E(y_k | x) = P(g = k| x)\]</span></p>
<p>Si usamos la pérdida logarítmica, entonces la pérdida es</p>
<p><span class="math display">\[L(g, p(x)) = -\log p_g (x),\]</span> que en nuestra notación con indicadoras se escribe como</p>
<p><span class="math display">\[L(y, p(x)) = -\sum_{k=1}^K y_k\log p_k (x),\]</span></p>
<p><strong>Ejercicio</strong>: escribe las estimaciones de clase de <span class="math inline">\(k\)</span>-vecinos más cercanos para clasificación multinomial.</p>
</section>
<section id="regresión-logística" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="regresión-logística"><span class="header-section-number">8.7</span> Regresión logística</h2>
<p>En <span class="math inline">\(k\)</span> vecinos más cercanos, intentamos estimar directamente con promedios las probabilidades de clase, sin considerar ninguna estructura. Ahora consideramos modelos más estructurados, definidos por parámetros, e intentaremos ajustarlos minimizando la pérdida logarítmica.</p>
<p>Igual que en regresión lineal, algunos de los modelos más simples que podemos imaginar son modelos lineales. Solo es necesario hacer una adaptación.</p>
<p>Supongamos que nuestra variable respuesta es <span class="math inline">\(y\)</span>, que toma valores 0 o 1.</p>
<p>Ahora queremos definir <span class="math inline">\(p(x) = p_1(x)\)</span> (probabilidad de que ocurra la clase 1) en términos de un promedio ponderado de las variables de entrada, como en regresión lineal:</p>
<p><span class="math display">\[\beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots + \beta_px_p.\]</span></p>
<p>Sin embargo, observamos que esta expresión puede dar valores negativos o mayores a uno, de forma que no necesariamente puede interpetarse como una probabilidad <span class="math inline">\(p(x)\)</span>. Una de las formas más sencillas de resolver este problema es transformar esta expresión para que necesariamente esté en <span class="math inline">\([0,1]\)</span> por medio de una función fija <span class="math inline">\(h\)</span>:</p>
<p><span class="math display">\[p_{\beta}(x) = h(\beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots + \beta_px_p),\]</span> donde <span class="math inline">\(h\)</span> debe ser una función que mapea valores reales a valores en <span class="math inline">\([0,1]\)</span>.</p>
<p>En este punto hay muchas funciones que podríamos usar. Para simplificar la interpretación y uso de este modelo, podemos escoger entre funciones que satisfagan, por ejemplo:</p>
<ol type="1">
<li><span class="math inline">\(h\)</span> toma valores en <span class="math inline">\([0,1]\)</span> es creciente y diferenciable</li>
<li><span class="math inline">\(h(0) = 0.5\)</span> (0 equivale a probabilidad 0.5, negativos dan probabilidades menores a 0.5 y positivos dan probabilidades mayores a 0.5)</li>
<li><span class="math inline">\(h(-x)=1-h(x)\)</span> (simetría). Por ejemplo, si <span class="math inline">\(h(-2)=0.16\)</span> entonces <span class="math inline">\(h(2)= 1-0.16=0.84\)</span>.</li>
</ol>
<p>Hay todavía muchas opciones. Una de las más simples es usar la función logística</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>La función logística está dada por <span class="math display">\[h(x)=\frac{e^x}{1+e^x}\]</span></p>
</div>
</div>
<div class="cell" data-fig.asp="0.5">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">exp</span>(x)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(x)) }</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">6</span>, <span class="fl">0.01</span>)), <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> <span class="fu">stat_function</span>(<span class="at">fun =</span> h)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>Esta función comprime adecuadamente (para nuestros propósitos) el rango de todos los reales dentro del intervalo <span class="math inline">\([0,1]\)</span>. Si aplicamos al predictor lineal que consideramos, obtenemos:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Regresión logística
</div>
</div>
<div class="callout-body-container callout-body">
<p>El <strong>modelo de regresión logística</strong> está dado por <span class="math display">\[p_1(x)=p_1(x;\beta)= h(\beta_0+\beta_1x_1 + \beta_2 x_2 + \cdots + \beta_p x_p)\]</span></p>
<p>y <span class="math display">\[p_0(x)=p_0(x;\beta)=1-p_1(x;\beta),\]</span> donde <span class="math inline">\(\beta=(\beta_0,\beta_1, \beta_2, \cdots, \beta_p)\)</span>.</p>
</div>
</div>
<section id="ejemplo-4" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-4">Ejemplo</h4>
<p>Consideremos nuestro ejemplo de impago. Podemos examinar qué tipo de probilidades obtendríamos con regresión logística y distintos parametros beta:</p>
<div class="cell" data-fig.asp="0.5">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>crear_p <span class="ot">&lt;-</span> <span class="cf">function</span>(beta_0, beta_1){</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x){</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">h</span>(beta_0 <span class="sc">+</span> beta_1 <span class="sc">*</span> x)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>df_grid <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.01</span>))</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>betas <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">beta_0 =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">2.5</span>),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">beta_1 =</span> <span class="fu">c</span>(<span class="dv">10</span>,   <span class="sc">-</span><span class="dv">2</span>, <span class="sc">-</span><span class="dv">4</span>))</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>betas <span class="ot">&lt;-</span> betas <span class="sc">|&gt;</span> </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">map2</span>(beta_0, beta_1, crear_p)) <span class="sc">|&gt;</span> </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">grid =</span> <span class="fu">map</span>(p, <span class="sc">~</span> df_grid <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">p_1 =</span> .(x)))) <span class="sc">|&gt;</span> </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>p) <span class="sc">|&gt;</span> </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">fun_nom =</span> <span class="fu">paste</span>(beta_0, <span class="st">"+"</span>, beta_1, <span class="st">"x"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(grid))</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>graf_1 <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="at">data =</span> betas, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> p_1)) <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>fun_nom) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>Experimenta con otros valores de <span class="math inline">\(\beta_0\)</span> y <span class="math inline">\(\beta_1\)</span>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Encontramos los coeficientes de la regresión logística minimizando la pérdida logarítmica de entrenamiento.</p>
</div>
</div>
<p>Esto se puede hacer de diversas maneras. Tradicionalmente, se utiliza el método de Newton-Raphson, pero resulta más fácil escalar métodos derivados de descenso máximo. Es decir, calculamos el gradiente de la pérdida y tomamos un paso en la dirección contraria al gradiente, que es la dirección local de descenso máximo.</p>
</section>
</section>
<section id="ejercicio-datos-de-diabetes" class="level2" data-number="8.8">
<h2 data-number="8.8" class="anchored" data-anchor-id="ejercicio-datos-de-diabetes"><span class="header-section-number">8.8</span> Ejercicio: datos de diabetes</h2>
<p>Ya están divididos los datos en entrenamiento y prueba</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>diabetes_ent <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(MASS<span class="sc">::</span>Pima.tr)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>diabetes_pr <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(MASS<span class="sc">::</span>Pima.te)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>diabetes_ent <span class="sc">|&gt;</span> <span class="fu">head</span>() <span class="sc">|&gt;</span> <span class="fu">gt</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="npflzhkbii" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#npflzhkbii table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#npflzhkbii thead, #npflzhkbii tbody, #npflzhkbii tfoot, #npflzhkbii tr, #npflzhkbii td, #npflzhkbii th {
  border-style: none;
}

#npflzhkbii p {
  margin: 0;
  padding: 0;
}

#npflzhkbii .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#npflzhkbii .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#npflzhkbii .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#npflzhkbii .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#npflzhkbii .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#npflzhkbii .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#npflzhkbii .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#npflzhkbii .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#npflzhkbii .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#npflzhkbii .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#npflzhkbii .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#npflzhkbii .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#npflzhkbii .gt_spanner_row {
  border-bottom-style: hidden;
}

#npflzhkbii .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#npflzhkbii .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#npflzhkbii .gt_from_md > :first-child {
  margin-top: 0;
}

#npflzhkbii .gt_from_md > :last-child {
  margin-bottom: 0;
}

#npflzhkbii .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#npflzhkbii .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#npflzhkbii .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#npflzhkbii .gt_row_group_first td {
  border-top-width: 2px;
}

#npflzhkbii .gt_row_group_first th {
  border-top-width: 2px;
}

#npflzhkbii .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#npflzhkbii .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#npflzhkbii .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#npflzhkbii .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#npflzhkbii .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#npflzhkbii .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#npflzhkbii .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#npflzhkbii .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#npflzhkbii .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#npflzhkbii .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#npflzhkbii .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#npflzhkbii .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#npflzhkbii .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#npflzhkbii .gt_left {
  text-align: left;
}

#npflzhkbii .gt_center {
  text-align: center;
}

#npflzhkbii .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#npflzhkbii .gt_font_normal {
  font-weight: normal;
}

#npflzhkbii .gt_font_bold {
  font-weight: bold;
}

#npflzhkbii .gt_font_italic {
  font-style: italic;
}

#npflzhkbii .gt_super {
  font-size: 65%;
}

#npflzhkbii .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#npflzhkbii .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#npflzhkbii .gt_indent_1 {
  text-indent: 5px;
}

#npflzhkbii .gt_indent_2 {
  text-indent: 10px;
}

#npflzhkbii .gt_indent_3 {
  text-indent: 15px;
}

#npflzhkbii .gt_indent_4 {
  text-indent: 20px;
}

#npflzhkbii .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="npreg">npreg</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="glu">glu</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="bp">bp</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="skin">skin</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="bmi">bmi</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="ped">ped</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="age">age</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="type">type</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="npreg" class="gt_row gt_right">5</td>
<td headers="glu" class="gt_row gt_right">86</td>
<td headers="bp" class="gt_row gt_right">68</td>
<td headers="skin" class="gt_row gt_right">28</td>
<td headers="bmi" class="gt_row gt_right">30.2</td>
<td headers="ped" class="gt_row gt_right">0.364</td>
<td headers="age" class="gt_row gt_right">24</td>
<td headers="type" class="gt_row gt_center">No</td></tr>
    <tr><td headers="npreg" class="gt_row gt_right">7</td>
<td headers="glu" class="gt_row gt_right">195</td>
<td headers="bp" class="gt_row gt_right">70</td>
<td headers="skin" class="gt_row gt_right">33</td>
<td headers="bmi" class="gt_row gt_right">25.1</td>
<td headers="ped" class="gt_row gt_right">0.163</td>
<td headers="age" class="gt_row gt_right">55</td>
<td headers="type" class="gt_row gt_center">Yes</td></tr>
    <tr><td headers="npreg" class="gt_row gt_right">5</td>
<td headers="glu" class="gt_row gt_right">77</td>
<td headers="bp" class="gt_row gt_right">82</td>
<td headers="skin" class="gt_row gt_right">41</td>
<td headers="bmi" class="gt_row gt_right">35.8</td>
<td headers="ped" class="gt_row gt_right">0.156</td>
<td headers="age" class="gt_row gt_right">35</td>
<td headers="type" class="gt_row gt_center">No</td></tr>
    <tr><td headers="npreg" class="gt_row gt_right">0</td>
<td headers="glu" class="gt_row gt_right">165</td>
<td headers="bp" class="gt_row gt_right">76</td>
<td headers="skin" class="gt_row gt_right">43</td>
<td headers="bmi" class="gt_row gt_right">47.9</td>
<td headers="ped" class="gt_row gt_right">0.259</td>
<td headers="age" class="gt_row gt_right">26</td>
<td headers="type" class="gt_row gt_center">No</td></tr>
    <tr><td headers="npreg" class="gt_row gt_right">0</td>
<td headers="glu" class="gt_row gt_right">107</td>
<td headers="bp" class="gt_row gt_right">60</td>
<td headers="skin" class="gt_row gt_right">25</td>
<td headers="bmi" class="gt_row gt_right">26.4</td>
<td headers="ped" class="gt_row gt_right">0.133</td>
<td headers="age" class="gt_row gt_right">23</td>
<td headers="type" class="gt_row gt_center">No</td></tr>
    <tr><td headers="npreg" class="gt_row gt_right">5</td>
<td headers="glu" class="gt_row gt_right">97</td>
<td headers="bp" class="gt_row gt_right">76</td>
<td headers="skin" class="gt_row gt_right">27</td>
<td headers="bmi" class="gt_row gt_right">35.6</td>
<td headers="ped" class="gt_row gt_right">0.378</td>
<td headers="age" class="gt_row gt_right">52</td>
<td headers="type" class="gt_row gt_center">Yes</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>diabetes_ent<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(diabetes_ent)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>diabetes_pr<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(diabetes_pr)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Aunque no es necesario, podemos normalizar:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>receta_diabetes <span class="ot">&lt;-</span> <span class="fu">recipe</span>(type <span class="sc">~</span> ., diabetes_ent) <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id_variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric</span>()) </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>diabetes_ent_s <span class="ot">&lt;-</span> receta_diabetes <span class="sc">|&gt;</span> <span class="fu">prep</span>() <span class="sc">|&gt;</span> <span class="fu">juice</span>() </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>diabetes_pr_s <span class="ot">&lt;-</span> receta_diabetes <span class="sc">|&gt;</span> <span class="fu">prep</span>() <span class="sc">|&gt;</span> <span class="fu">bake</span>(diabetes_pr)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>modelo_lineal <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>(<span class="at">mode =</span> <span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glm"</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>flujo_diabetes <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(modelo_lineal) <span class="sc">|&gt;</span> </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(receta_diabetes)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>flujo_ajustado <span class="ot">&lt;-</span> <span class="fu">fit</span>(flujo_diabetes, diabetes_ent)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(flujo_ajustado, <span class="st">"cache/flujo_ajustado_diabetes.rds"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>flujo_ajustado</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: logistic_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
1 Recipe Step

• step_normalize()

── Model ───────────────────────────────────────────────────────────────────────

Call:  stats::glm(formula = ..y ~ ., family = stats::binomial, data = data)

Coefficients:
(Intercept)        npreg          glu           bp         skin          bmi  
   -0.95583      0.34734      1.01705     -0.05473     -0.02247      0.51263  
        ped          age  
    0.55928      0.45201  

Degrees of Freedom: 199 Total (i.e. Null);  192 Residual
Null Deviance:      256.4 
Residual Deviance: 178.4    AIC: 194.4</code></pre>
</div>
</div>
<p>Ahora calculamos devianza de prueba y error de clasificación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>preds_prueba <span class="ot">&lt;-</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(flujo_ajustado, diabetes_pr, <span class="at">type=</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(flujo_ajustado, diabetes_pr)) <span class="sc">|&gt;</span> </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(diabetes_pr <span class="sc">|&gt;</span> <span class="fu">select</span>(type))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>preds_prueba</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 332 × 4
   .pred_No .pred_Yes .pred_class type 
      &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;       &lt;fct&gt;
 1    0.232    0.768  Yes         Yes  
 2    0.960    0.0403 No          No   
 3    0.975    0.0253 No          No   
 4    0.959    0.0413 No          Yes  
 5    0.204    0.796  Yes         Yes  
 6    0.265    0.735  Yes         Yes  
 7    0.590    0.410  No          Yes  
 8    0.780    0.220  No          No   
 9    0.558    0.442  No          No   
10    0.798    0.202  No          Yes  
# ℹ 322 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(preds_prueba<span class="sc">$</span>type)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "No"  "Yes"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ponemos event_level si "positivo" no es el primer factor</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>metricas <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(accuracy, mn_log_loss)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metricas</span>(preds_prueba, <span class="at">truth =</span> type, .pred_Yes, <span class="at">estimate =</span> .pred_class, </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">event_level =</span> <span class="st">"second"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary         0.801
2 mn_log_loss binary         0.441</code></pre>
</div>
</div>
<p>Vamos a repetir usando keras.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>x_ent <span class="ot">&lt;-</span> diabetes_ent_s <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>type, <span class="sc">-</span>id) <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>()</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>y_ent <span class="ot">&lt;-</span> diabetes_ent_s<span class="sc">$</span>type <span class="sc">==</span> <span class="st">"Yes"</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>x_prueba <span class="ot">&lt;-</span> diabetes_pr_s <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>type, <span class="sc">-</span>id) <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>()</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>y_prueba <span class="ot">&lt;-</span> diabetes_pr_s<span class="sc">$</span>type <span class="sc">==</span> <span class="st">'Yes'</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># definición de estructura del modelo (regresión logística)</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># es posible hacerlo con workflows como vimos arriba, </span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># pero aquí usamos directamente la interfaz de keras en R</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>n_entrena <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x_ent)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>modelo_diabetes <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">|&gt;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>,        <span class="co">#una sola respuesta,</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">activation =</span> <span class="st">"sigmoid"</span>,    <span class="co"># combinar variables linealmente y aplicar función logística</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">kernel_initializer =</span> <span class="fu">initializer_constant</span>(<span class="dv">0</span>), <span class="co">#inicializamos coeficientes en 0</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">bias_initializer =</span> <span class="fu">initializer_constant</span>(<span class="dv">0</span>))   <span class="co">#inicializamos ordenada en 0</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="co"># compilar seleccionando cantidad a minimizar, optimizador y métricas</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>modelo_diabetes <span class="sc">|&gt;</span> <span class="fu">compile</span>(</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">loss =</span> <span class="st">"binary_crossentropy"</span>,  <span class="co"># devianza es entropía cruzada</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">learning_rate =</span> <span class="fl">0.75</span>), <span class="co"># descenso en gradiente</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">metrics =</span> <span class="fu">list</span>(<span class="st">"binary_crossentropy"</span>))</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Ahora iteramos</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Primero probamos con un número bajo de iteraciones</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>historia <span class="ot">&lt;-</span> modelo_diabetes <span class="sc">|&gt;</span> <span class="fu">fit</span>(</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(x_ent), <span class="co"># x entradas</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>  y_ent,            <span class="co"># y salida o target</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="fu">nrow</span>(x_ent), <span class="co"># para descenso en gradiente</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">10</span> <span class="co"># número de iteraciones</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(historia)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>Y ahora podemos correr más iteraciones <em>adicionales</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>historia <span class="ot">&lt;-</span> modelo_diabetes <span class="sc">|&gt;</span> <span class="fu">fit</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(x_ent), <span class="co"># x entradas</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  y_ent,            <span class="co"># y salida o target</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="fu">nrow</span>(x_ent), <span class="co"># para descenso en gradiente</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">1000</span>, <span class="co"># número de iteraciones</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="dv">0</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Los errores de entrenamiento y prueba son:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">evaluate</span>(modelo_diabetes, x_ent, y_ent)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               loss binary_crossentropy 
          0.4459766           0.4459766 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">evaluate</span>(modelo_diabetes, x_prueba, y_prueba)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               loss binary_crossentropy 
          0.4406986           0.4406986 </code></pre>
</div>
</div>
<p>Veamos que coeficientes obtuvimos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_weights</span>(modelo_diabetes)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
            [,1]
[1,]  0.34734303
[2,]  1.01705003
[3,] -0.05472932
[4,] -0.02247143
[5,]  0.51263177
[6,]  0.55927491
[7,]  0.45200703

[[2]]
[1] -0.9558301</code></pre>
</div>
</div>
<p>que coinciden con los valores que obtuvimos usando regresión logística de <em>glm</em>. La única diferencia es que el algoritmo de optimización que se usa en cada caso es diferente: con <em>keras</em> utilizamos descenso en gradiente, mientras que <em>glm</em> usa Newton-Raphson.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>flujo_ajustado <span class="sc">|&gt;</span> <span class="fu">extract_fit_parsnip</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parsnip model object


Call:  stats::glm(formula = ..y ~ ., family = stats::binomial, data = data)

Coefficients:
(Intercept)        npreg          glu           bp         skin          bmi  
   -0.95583      0.34734      1.01705     -0.05473     -0.02247      0.51263  
        ped          age  
    0.55928      0.45201  

Degrees of Freedom: 199 Total (i.e. Null);  192 Residual
Null Deviance:      256.4 
Residual Deviance: 178.4    AIC: 194.4</code></pre>
</div>
</div>
</section>
<section id="probabilidades-y-pérdida-0-1" class="level2" data-number="8.9">
<h2 data-number="8.9" class="anchored" data-anchor-id="probabilidades-y-pérdida-0-1"><span class="header-section-number">8.9</span> Probabilidades y pérdida 0-1</h2>
<p>Otra medida común para medir el error de un clasificador es el <em>error de clasificación</em>, que también llamamos <em>probabilidad de clasificación incorrecta</em>, o error bajo pérdida 0-1.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Probabilidades de clase y pérdida 0-1
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sean <span class="math inline">\(\hat{p}_g(x)\)</span> probabilidades de clase estimadas. El clasificador bajo pérdida 0-1 asociado está dado por <span class="math display">\[\hat{g} (x) = \arg\max_g \hat{p}_g(x)\]</span> Podemos estimar su error de clasificación <span class="math inline">\(P(\hat{g}(x) \neq g)\)</span> con una muestra de prueba <span class="math display">\[{\mathcal T}=\{ (\mathbf{x}^{(1)},\mathbf{g}^{(1)}),(\mathbf{x}^{(2)},\mathbf{g}^{(2)}), \ldots, (\mathbf{x}^{(m)}, \mathbf{g}^{(m)})\]</span> mediante <span class="math display">\[\hat{Err} = \frac{1}{m} \sum_{j=i}^m I(\hat{g}(\mathbf{x}^{(i)}) \neq \mathbf{g}^{(i)}),\]</span> es decir, la proporción de casos de prueba que son clasificados incorrectamente.</p>
</div>
</div>
<p><strong>Observación</strong>: Muy generalmente, esta manera de construir un clasificador <strong>es deficiente</strong>:</p>
<ul>
<li>Rara vez queremos clasificar simplemente a la clase con mayor probabilidad. Por ejemplo, podría ser mucho más razonable que basta investigar una operación si su probabilidad de ser fraude está por arriba de 10%, y no necesariamente por arriba de 50%. Esto se debe a que los costos de los distintos errores no son simétricos.</li>
<li>La tasa de clasificación incorrecta por lo tanto es un resumen poco relevante para muchos problemas.</li>
<li>Para la mayoría de problemas de clasificación, es un error ignorar las probabilidades de clase estimadas. No es lo mismo que un cliente tenga 99% de probabilidad de mantenerse al corriente que otro que tiene 55%. Ambos son clasificados de la misma manera por el clasificador de máxima probabilidad.</li>
<li>Puede haber dos predictores con tasas similares de clasificación incorrecta, pero distintos en cuanto a score de Brier o pérdida logarítmica, y mejor score de Brier y pérdida logarítmica indican muchas veces mejor separación de clases.</li>
</ul>
<p>Más adelante veremos cómo construir reglas de clasificación a partir de probabilidades, pero por el momento notamos que tomar decisiones de cómo clasificar en el proceso de construcción de predictores es mala idea, pues confundimos el desempeño predictivo con los costos de tomar cada decisión de clasificación. Esos costos muchas veces no están perfectamente planteados, de forma que es mejor usar probabilidades para presentar a tomadores de decisiones o calcular simulaciones de costo-beneficio.</p>
<section id="ejemplo-5" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-5">Ejemplo</h4>
<p>Veamos cómo se comporta en términos de error de clasificación nuestro último modelo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>dat_log_loss <span class="sc">|&gt;</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(ajuste_vmc, dat_ent)) <span class="sc">|&gt;</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">correcto =</span> .pred_class <span class="sc">==</span> g)  <span class="sc">|&gt;</span>  </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span>  <span class="fu">summarise</span>(<span class="at">p_correctos =</span> <span class="fu">mean</span>(correcto))  <span class="sc">|&gt;</span> </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">error_clasif =</span> <span class="dv">1</span> <span class="sc">-</span> p_correctos)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  p_correctos error_clasif
        &lt;dbl&gt;        &lt;dbl&gt;
1       0.794        0.206</code></pre>
</div>
</div>
<p>Y calculamos el error de clasificación de prueba:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dat_log_loss_prueba <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(ajuste_vmc, dat_prueba)) <span class="sc">|&gt;</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">correcto =</span> .pred_class <span class="sc">==</span> g)  <span class="sc">|&gt;</span>  </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span>  <span class="fu">summarise</span>(<span class="at">p_correctos =</span> <span class="fu">mean</span>(correcto))  <span class="sc">|&gt;</span> </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">error_clasif =</span> <span class="dv">1</span> <span class="sc">-</span> p_correctos)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  p_correctos error_clasif
        &lt;dbl&gt;        &lt;dbl&gt;
1       0.802        0.198</code></pre>
</div>
</div>
</section>
</section>
<section id="regresión-logística-multinomial" class="level2" data-number="8.10">
<h2 data-number="8.10" class="anchored" data-anchor-id="regresión-logística-multinomial"><span class="header-section-number">8.10</span> Regresión logística multinomial</h2>
<p>Para estimar <span class="math inline">\(K\)</span> probabilidades de clase, consideramos <span class="math inline">\(k\)</span> predictores lineales individuales</p>
<p><span class="math display">\[f_k(x) = \beta_{0, k} + \beta_{1,k} x_1 + \cdots + \beta_{p,k} x_p\]</span></p>
<p>y la probabilidad de clase la calculamos haciendo <em>softmax</em> sobre estas:</p>
<p><span class="math display">\[p_k(x) = \frac{e^{f_k(x)}}{\sum_i e^{f_i(x)}}\]</span></p>
<p>que necesariamente suman uno. Nótese si embargo que este modelo está sobreparametrizado, pues solamente es necesario escribir <span class="math inline">\(K-1\)</span> de estas probabilidades, y la última tiene que ser el complemento para que sumen uno. Podemos ver esto, por ejemplo, si sumamos <span class="math inline">\(h(x) = \gamma_0 + \gamma_1x_1 + \cdots \gamma_p x_p\)</span> a todas las funciones:</p>
<p><span class="math display">\[p_k(x) = \frac{e^{f_k(x) + h(x)}}{\sum_i e^{f_i(x) + h(x)}} = \frac{e^{f_k(x)}}{\sum_i e^{f_i(x)}}\]</span></p>
<p>En regresión logística, por ejemplo, si tenemos <span class="math inline">\(f_1(x)\)</span> y <span class="math inline">\(f_0(x)\)</span> podemos tomar <span class="math inline">\(f_0(x) = 0\)</span>, de forma que <span class="math display">\[p_1(x) = \frac{e^{f_1(x)}}{1+ e^{f_1(x)}}\]</span> que es justamente el modelo de regresión logística como lo escribimos arriba. Siempre es posible entonces crear una clase de <em>referencia</em>, con coeficientes igual a 0, aunque esto <strong>no es necesario si usamos regularización</strong>, que generalmente es el caso.</p>
</section>
<section id="ejemplo-clasificación-de-ropa" class="level2" data-number="8.11">
<h2 data-number="8.11" class="anchored" data-anchor-id="ejemplo-clasificación-de-ropa"><span class="header-section-number">8.11</span> Ejemplo: clasificación de ropa</h2>
<p>Para el siguiente problema tenemos imágenes en blanco y negro de artículos de ropa</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(imager)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>ropa_datos <span class="ot">&lt;-</span> <span class="fu">dataset_fashion_mnist</span>()</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>ropa_entrena <span class="ot">&lt;-</span> ropa_datos<span class="sc">$</span>train </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>ropa_prueba <span class="ot">&lt;-</span> ropa_datos<span class="sc">$</span>test</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co"># estas son las categorias:</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>articulos <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"playera/top"</span>, <span class="st">"pantalón"</span>, <span class="st">"suéter"</span>, <span class="st">"vestido"</span>, <span class="st">"abrigo"</span>, <span class="st">"sandalia"</span>, </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"camisa"</span>, <span class="st">"tenis"</span>, <span class="st">"bolsa"</span>, <span class="st">"bota"</span>)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>etiquetas_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">codigo =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, </span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">articulo =</span> <span class="fu">c</span>(<span class="st">"playera"</span>, <span class="st">"pantalón"</span>, <span class="st">"suéter"</span>, <span class="st">"vestido"</span>, <span class="st">"abrigo"</span>, <span class="st">"sandalia"</span>, </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"camisa"</span>, <span class="st">"tenis"</span>, <span class="st">"bolsa"</span>, <span class="st">"bota"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> ropa_entrena<span class="sc">$</span>x</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> ropa_entrena<span class="sc">$</span>y</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Por ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">17</span>) <span class="fu">plot</span>(<span class="fu">as.cimg</span>(<span class="fu">t</span>(x[<span class="dv">2</span> <span class="sc">+</span> i, ,])), <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">main =</span> articulos[y[<span class="dv">2</span> <span class="sc">+</span> i] <span class="sc">+</span> <span class="dv">1</span>])</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>Utilizaremos regresión logistica multinomial con keras y regularización L2:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>num_classes <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>input_shape <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co"># normalizar</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>x_entrena <span class="ot">&lt;-</span> ropa_entrena<span class="sc">$</span>x <span class="sc">/</span> <span class="dv">255</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>x_prueba <span class="ot">&lt;-</span> ropa_prueba<span class="sc">$</span>x <span class="sc">/</span> <span class="dv">255</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>y_entrena <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(ropa_entrena<span class="sc">$</span>y, num_classes)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>y_prueba <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(ropa_prueba<span class="sc">$</span>y, num_classes)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="cn">FALSE</span>){</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' Model definition</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' (architecture taken from </span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' https://keras.rstudio.com/articles/examples/mnist_cnn.html )</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>modelo_ropa <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>modelo_ropa <span class="sc">|&gt;</span> </span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_flatten</span>() <span class="sc">|&gt;</span> </span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>,</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">activity_regularizer =</span> <span class="fu">regularizer_l2</span>(<span class="at">l =</span> <span class="fl">0.0005</span>), </span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">activation =</span> <span class="st">'softmax'</span>) </span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="co"># compile model</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>modelo_ropa <span class="sc">|&gt;</span>  <span class="fu">compile</span>(</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_adam</span>(<span class="at">learning_rate =</span> <span class="fl">0.0005</span>),</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>)</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="co"># train and evaluate</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>modelo_ropa <span class="sc">|&gt;</span> <span class="fu">fit</span>(</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>  x_entrena, y_entrena,</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">40</span>,</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="dv">1</span>,</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_data =</span> <span class="fu">list</span>(x_prueba, y_prueba)</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a><span class="fu">save_model_tf</span>(modelo_ropa, <span class="st">"cache/red_ropa_1"</span>)</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>modelo_ropa <span class="ot">&lt;-</span> <span class="fu">load_model_tf</span>(<span class="st">"cache/red_ropa_1"</span>)</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>scores <span class="ot">&lt;-</span> modelo_ropa <span class="sc">|&gt;</span> <span class="fu">evaluate</span>(</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>  x_prueba, y_prueba, <span class="at">verbose =</span> <span class="dv">0</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">'Test pérdida:'</span>, scores[[<span class="dv">1</span>]], <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test pérdida: 0.4358351 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">'Test clasificación correcta:'</span>, scores[[<span class="dv">2</span>]], <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test clasificación correcta: 0.8478 </code></pre>
</div>
</div>
<p>Ahora podemos hacer predicciones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>preds_mat <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_ropa, x_prueba)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(preds_mat)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10000    10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> <span class="fu">round</span>(preds_mat[<span class="dv">1</span>,], <span class="dv">3</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">articulo =</span> articulos, <span class="at">prob =</span> probs) <span class="sc">|&gt;</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(probs)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   articulo     prob
   &lt;chr&gt;       &lt;dbl&gt;
 1 playera/top 0    
 2 pantalón    0    
 3 suéter      0    
 4 vestido     0    
 5 abrigo      0    
 6 camisa      0    
 7 bolsa       0.005
 8 tenis       0.051
 9 sandalia    0.117
10 bota        0.827</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.cimg</span>(<span class="fu">t</span>(ropa_prueba<span class="sc">$</span>x[<span class="dv">1</span>,,])), <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">main =</span> articulos[ropa_prueba<span class="sc">$</span>y[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>])</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08-clasificacion-1_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="384"></p>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./07-intervalos-predictivos.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Incertidumbre en las predicciones</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./09-clasificacion-2.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Decisiones de clasificación</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>