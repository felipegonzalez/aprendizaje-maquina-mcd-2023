<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Aprendizaje Máquina - 17&nbsp; Validación de modelos: problemas comunes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./81-apendice-descenso.html" rel="next">
<link href="./16-recom-factorizacion.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./17-validacion-problemas.html"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Validación de modelos: problemas comunes</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Buscar" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Aprendizaje Máquina</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Buscar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temario y referencias</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduccion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-principios-supervisado.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Principios de aprendizaje supervisado</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-metodos-locales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Métodos locales no estructurados</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-lineales-ingenieria.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Métodos lineales e ingenería de entradas</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-regularizacion-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Regularización y variabilidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-redes-neuronales-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Redes neuronales (intro)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-intervalos-predictivos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Incertidumbre en las predicciones</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-clasificacion-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Clasificación y probabilidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-clasificacion-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Decisiones de clasificación</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-clasificacion-calibracion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Calibración de probabilidades</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-val-cruzada.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Entrenamiento, Validación y Prueba</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-arboles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Métodos basados en árboles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-arboles-boosting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Métodos basados en árboles: boosting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-interpretacion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Interpretación de modelos</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-reduccion-dim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Aprendizaje no supervisado: reducción de dimensionalidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-recom-factorizacion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Dimensiones latentes: embeddings</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-validacion-problemas.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Validación de modelos: problemas comunes</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./81-apendice-descenso.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Apéndice 1: descenso en gradiente</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./82-apendice-descenso-estocastico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Apéndice 2: Descenso estocástico</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-referencias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referencias</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#filtración-de-datos" id="toc-filtración-de-datos" class="nav-link active" data-scroll-target="#filtración-de-datos"><span class="header-section-number">17.1</span> Filtración de datos</a>
  <ul class="collapse">
  <li><a href="#series-de-tiempo" id="toc-series-de-tiempo" class="nav-link" data-scroll-target="#series-de-tiempo"><span class="header-section-number">17.1.1</span> Series de tiempo</a></li>
  </ul></li>
  <li><a href="#filtración-en-el-preprocesamiento" id="toc-filtración-en-el-preprocesamiento" class="nav-link" data-scroll-target="#filtración-en-el-preprocesamiento"><span class="header-section-number">17.2</span> Filtración en el preprocesamiento</a>
  <ul class="collapse">
  <li><a href="#uso-de-variables-fuera-de-rango-temporal" id="toc-uso-de-variables-fuera-de-rango-temporal" class="nav-link" data-scroll-target="#uso-de-variables-fuera-de-rango-temporal"><span class="header-section-number">17.2.1</span> Uso de variables fuera de rango temporal</a></li>
  </ul></li>
  <li><a href="#muestras-de-validación-de-poblaciones-distintas" id="toc-muestras-de-validación-de-poblaciones-distintas" class="nav-link" data-scroll-target="#muestras-de-validación-de-poblaciones-distintas"><span class="header-section-number">17.3</span> Muestras de validación de poblaciones distintas</a></li>
  <li><a href="#datos-en-conglomerados-y-muestreo-complejo" id="toc-datos-en-conglomerados-y-muestreo-complejo" class="nav-link" data-scroll-target="#datos-en-conglomerados-y-muestreo-complejo"><span class="header-section-number">17.4</span> Datos en conglomerados y muestreo complejo</a>
  <ul class="collapse">
  <li><a href="#ejemplo" id="toc-ejemplo" class="nav-link" data-scroll-target="#ejemplo">Ejemplo</a></li>
  </ul></li>
  <li><a href="#censura-y-evaluación-incompleta" id="toc-censura-y-evaluación-incompleta" class="nav-link" data-scroll-target="#censura-y-evaluación-incompleta"><span class="header-section-number">17.5</span> Censura y evaluación incompleta</a>
  <ul class="collapse">
  <li><a href="#ejemplo-tiendas-cerradas" id="toc-ejemplo-tiendas-cerradas" class="nav-link" data-scroll-target="#ejemplo-tiendas-cerradas"><span class="header-section-number">17.5.1</span> Ejemplo: tiendas cerradas</a></li>
  </ul></li>
  <li><a href="#muestras-de-validación-chicas" id="toc-muestras-de-validación-chicas" class="nav-link" data-scroll-target="#muestras-de-validación-chicas"><span class="header-section-number">17.6</span> Muestras de validación chicas</a>
  <ul class="collapse">
  <li><a href="#ejercicio" id="toc-ejercicio" class="nav-link" data-scroll-target="#ejercicio">Ejercicio</a></li>
  </ul></li>
  <li><a href="#otros-ejemplos" id="toc-otros-ejemplos" class="nav-link" data-scroll-target="#otros-ejemplos"><span class="header-section-number">17.7</span> Otros ejemplos</a></li>
  <li><a href="#resumen" id="toc-resumen" class="nav-link" data-scroll-target="#resumen"><span class="header-section-number">17.8</span> Resumen</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Validación de modelos: problemas comunes</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>En aprendizaje de máquina, el ajuste y afinación de parámetros es tan importante como la evaluación de desempeño o validación de los modelos resultantes. Ninguna funciona bien sin que la otra sea correctamente ejecutada. Hemos visto que ambas partes tienen dificultades algunas veces sutiles (tanto el ajuste y optimización como la evaluación de las predicciones) que pueden hacer fracasar nuestro ejercicio de modelación.</p>
<p>En esta parte hablaremos de la evaluación de modelos. En aprendizaje automático, considerando que utilizamos relativamente pocos supuestos teóricos, dependemos de esa evaluación para asegurarnos que estamos capturando patrones reales y útiles en los datos.</p>
<p>Todo lo que veremos aplica tanto a separación de muestras de validación como a uso de algún tipo de validación cruzada (validación cruzada, estimación OOB en árboles, validación bootstrap, etc.)</p>
<section id="filtración-de-datos" class="level2" data-number="17.1">
<h2 data-number="17.1" class="anchored" data-anchor-id="filtración-de-datos"><span class="header-section-number">17.1</span> Filtración de datos</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Nota
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>La <em>filtración de datos</em> ocurre cuando nuestras muestras de entrenamiento contienen información de los datos de validación, de una forma que no ocurre en la tarea real de predicción En consecuencia, nuestras estimaciones de desempeño del modelo (validación) son optimistas en relación al desempeño verdadero.</li>
<li>También podemos pensar en <em>filtraciones</em> tanto al conjunto de entrenamiento y validación, cuando ambos están contaminados con información que no estará disponible al momento de hacer las predicciones. Esto produce modelos que no es posible poner en producción.</li>
</ul>
</div>
</div>
<p>El primer tipo de filtraciones es más difícil de detectar antes de la puesta en producción de los modelos. El segundo tipo puede descubrirse cuando nos damos cuenta de que no es posible implementar en producción nuestro modelo porque no hay información disponible que usamos para construirlo (o peor, cuando cometemos un error en la implementación y el modelo se desempeña mal posterioremente).</p>
<p>Veamos el primer caso: filtración de datos de validación al conjunto de entrenamiento.</p>
<p>La filtración de datos puede ocurrir de muchas maneras, muchas veces inesperadas. Quizá uno de los ejemplos más típicos es el validación de modelos de series de tiempo.</p>
<section id="series-de-tiempo" class="level3" data-number="17.1.1">
<h3 data-number="17.1.1" class="anchored" data-anchor-id="series-de-tiempo"><span class="header-section-number">17.1.1</span> Series de tiempo</h3>
<p>Comenzamos con un ejemplo simulado. Haremos varias simulaciones para incorporar la variación producida en los modelos por la muestra de entrenamineto</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>simular_datos <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">500</span>,...){</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  datos <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">t=</span><span class="dv">1</span><span class="sc">:</span>n, <span class="at">x =</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="dv">1</span>)) </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#nivel &lt;- numeric(n)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#nivel[1] &lt;- 10</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  y[<span class="dv">1</span>] <span class="ot">&lt;-</span> datos<span class="sc">$</span>x[<span class="dv">1</span>] <span class="co">#+ nivel[1]</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n){</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#nivel[i] &lt;-  nivel[i-1] + rnorm(1, 0, 0.1)</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#y[i] &lt;- 0.01*i + datos$x[i] + nivel[i] + rnorm(1,0,0.05)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    y[i] <span class="ot">&lt;-</span> <span class="fl">0.01</span><span class="sc">*</span>i <span class="sc">+</span> datos<span class="sc">$</span>x[i] <span class="sc">+</span> <span class="fl">0.9</span><span class="sc">*</span>y[i<span class="dv">-1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.05</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  datos<span class="sc">$</span>y <span class="ot">&lt;-</span> y</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  datos</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>separar <span class="ot">&lt;-</span> <span class="cf">function</span>(df, prop){</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="fu">ifelse</span>(t <span class="sc">&gt;</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(df)<span class="sc">*</span>(prop[<span class="dv">1</span>]<span class="sc">+</span>prop[<span class="dv">2</span>])), <span class="st">'prueba'</span>, </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">'entrena'</span>,<span class="st">'valida'</span>),<span class="dv">1</span>)))</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(df, df<span class="sc">$</span>tipo)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>ajustar_evaluar <span class="ot">&lt;-</span> <span class="cf">function</span>(df_split){</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  mod_1 <span class="ot">&lt;-</span> <span class="fu">ranger</span>(y <span class="sc">~</span> x <span class="sc">+</span> t, <span class="at">data =</span> df_split[[<span class="st">'entrena'</span>]])</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  error_valida <span class="ot">&lt;-</span> <span class="fu">sd</span>(<span class="fu">predict</span>(mod_1, df_split[[<span class="st">'valida'</span>]])<span class="sc">$</span>predictions <span class="sc">-</span> </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                              df_split[[<span class="st">'valida'</span>]]<span class="sc">$</span>y)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  error_prueba <span class="ot">&lt;-</span> <span class="fu">sd</span>(<span class="fu">predict</span>(mod_1, df_split[[<span class="st">'prueba'</span>]])<span class="sc">$</span>predictions <span class="sc">-</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                              df_split[[<span class="st">'prueba'</span>]]<span class="sc">$</span>y)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">error_valida  =</span> error_valida, <span class="at">error_prueba =</span> error_prueba)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Por ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">simular_datos</span>(), <span class="fu">aes</span>(<span class="at">x=</span>t, <span class="at">y=</span>y)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Separamos ingenuamente (tomando casos al azar, sin tomar en cuenta la estructura temporal) entrenamiento y validación, y más tarde usamos unos datos de prueba que naturalmente ocurre en el futuro:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>errores <span class="ot">&lt;-</span> <span class="fu">simular_datos</span>(<span class="dv">500</span>) <span class="sc">|&gt;</span> <span class="fu">separar</span>(<span class="at">prop=</span> <span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">0.4</span>,<span class="fl">0.2</span>)) <span class="sc">|&gt;</span> <span class="fu">ajustar_evaluar</span>()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>errores</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>error_valida error_prueba 
    1.634534     4.532328 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>reps_1 <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, simular_datos, <span class="at">n =</span> <span class="dv">500</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map</span>(separar, <span class="at">prop=</span> <span class="fu">c</span>(<span class="fl">0.6</span>,<span class="fl">0.2</span>,<span class="fl">0.2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map</span>(ajustar_evaluar) <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">transpose</span>() <span class="sc">|&gt;</span> <span class="fu">map</span>(unlist) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>gr_reps_1 <span class="ot">&lt;-</span> reps_1 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">rep =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(tipo, valor, <span class="sc">-</span>rep)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(reps_1, <span class="fu">aes</span>(<span class="at">x=</span>error_valida, <span class="at">y=</span>error_prueba)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Y vemos que los errores de validación son consistentemente menores, y por margen alto, que los errores de prueba. Podemos ver que hay un desacuerdo entre el proceso de validación y de prueba:</p>
<ul>
<li>Los valores de validación y de entrenamiento están intercalados, pues fueron seleccionados al azar.</li>
<li>Pero el error de predicción se calcula para el futuro, y esos datos futuros no tienen traslape en tiempo con la muestra de entrenamiento.</li>
</ul>
<p>De esta manera, podríamos decir que cuando hacemos predicciones para el conjunto de validación, se nos <strong>filtran</strong> valores del futuro cercano, lo cual no tenemos disponible a la hora de probar el modelo.</p>
<p>Podríamos cambiar nuestra manera de probar el modelo, escogendo la muestra de validación al final del periodo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>separar_valid_futura <span class="ot">&lt;-</span> <span class="cf">function</span>(df, prop){</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="fu">ifelse</span>(t <span class="sc">&lt;</span> <span class="fu">nrow</span>(df)<span class="sc">*</span>prop[<span class="dv">1</span>], <span class="st">'entrena'</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="fu">ifelse</span>(t<span class="sc">&lt;</span><span class="fu">nrow</span>(df)<span class="sc">*</span>(prop[<span class="dv">1</span>]<span class="sc">+</span>prop[<span class="dv">2</span>]),<span class="st">'valida'</span>,<span class="st">'prueba'</span>)))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(df, df<span class="sc">$</span>tipo)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>reps_2 <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, simular_datos, <span class="at">n =</span> <span class="dv">500</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map</span>(separar_valid_futura, <span class="at">prop=</span> <span class="fu">c</span>(<span class="fl">0.6</span>,<span class="fl">0.2</span>,<span class="fl">0.2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map</span>(ajustar_evaluar) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">transpose</span>() <span class="sc">|&gt;</span> <span class="fu">map</span>(unlist) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>gr_reps_2 <span class="ot">&lt;-</span> reps_2 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">rep =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(tipo, valor, <span class="sc">-</span>rep)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(gr_reps_2, <span class="fu">aes</span>(<span class="at">x=</span>valor, <span class="at">group=</span>tipo, <span class="at">fill=</span>tipo)) <span class="sc">+</span> <span class="fu">geom_histogram</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="480"></p>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(reps_2, <span class="fu">aes</span>(<span class="at">x=</span>error_valida, <span class="at">y=</span>error_prueba)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="480"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nótese que la fuente más grande de error no proviene directamente del hecho de que el sistema que queremos predecir es dinámico (el primer modelo, por ejemplo, usa valores más cercanos a los del futuro que queremos predecir). El problema es la filtración de datos del pasado cercano y futuro desde el conjunto de validación al de prueba.</p>
</div>
</div>
</section>
</section>
<section id="filtración-en-el-preprocesamiento" class="level2" data-number="17.2">
<h2 data-number="17.2" class="anchored" data-anchor-id="filtración-en-el-preprocesamiento"><span class="header-section-number">17.2</span> Filtración en el preprocesamiento</h2>
<p>Cuando preprocesamos datos para incluir en el modelo, es importante asegurarnos de no filtrar información de los datos de validación hacia los datos de entrenamiento. Nos aseguramos de esto si nuestro procesamiento, por ejemplo, es caso por caso con parámetros preestablecidos (no calculamos agregados de todos los datos, por ejemplo), o para más seguridad, haciendo por separado el preprocesamiento de entrenamiento y validación y considerando qué valores pasamos de un conjunto de datos al otro.</p>
<p>Un ejemplo clásico es el de selección de variables. Supongamos que incorrectamente hacemos la selección de variables usando todos los datos, y luego hacemos la validación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>seleccion_ajuste <span class="ot">&lt;-</span> <span class="cf">function</span>(...){</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">50</span>, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">50</span><span class="sc">*</span><span class="dv">500</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="dv">50</span>, <span class="dv">500</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  correlaciones <span class="ot">&lt;-</span> <span class="fu">cor</span>(x, y)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Seleccionamos las 50 variables con mayor correlación</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  vars_selec <span class="ot">&lt;-</span> <span class="fu">order</span>(correlaciones, <span class="at">decreasing=</span><span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Hacemos la validación cruzada usual - que en este caso es errónea</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  est_val_cruzada <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cf">function</span>(i){</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    x_vc <span class="ot">&lt;-</span> x[<span class="sc">-</span>((<span class="dv">5</span><span class="sc">*</span>i <span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="dv">5</span><span class="sc">*</span>i)),]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    y_vc <span class="ot">&lt;-</span> y[<span class="sc">-</span>((<span class="dv">5</span><span class="sc">*</span>i <span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="dv">5</span><span class="sc">*</span>i))]</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">y=</span>y_vc, <span class="at">x=</span> x_vc[,vars_selec], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">family=</span><span class="st">'binomial'</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lambda =</span> <span class="fl">0.5</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    preds_p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newx =</span> x[((<span class="dv">5</span><span class="sc">*</span>i <span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="dv">5</span><span class="sc">*</span>i)),vars_selec])[,<span class="dv">1</span>]</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((preds_p <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">!=</span> y[((<span class="dv">5</span><span class="sc">*</span>i <span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="dv">5</span><span class="sc">*</span>i))])</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  error_validacion <span class="ot">&lt;-</span> <span class="fu">mean</span>(est_val_cruzada)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">y=</span>y, <span class="at">x=</span> x[,vars_selec], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">family=</span><span class="st">'binomial'</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lambda =</span> <span class="fl">0.5</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  y_p <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1000</span>, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  x_p <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span><span class="sc">*</span><span class="dv">500</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="dv">1000</span>, <span class="dv">500</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  preds_p <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newx =</span> x_p[, vars_selec])[,<span class="dv">1</span>]</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  error_prueba <span class="ot">&lt;-</span> <span class="fu">mean</span>((preds_p <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">!=</span> y_p)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'error_valida'</span><span class="ot">=</span>error_validacion, <span class="st">'error_prueba'</span><span class="ot">=</span>error_prueba)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="fu">seleccion_ajuste</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>error_valida error_prueba 
       0.160        0.501 </code></pre>
</div>
</div>
<p>El resultado es catastrófico otra vez:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>errores_selec <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, seleccion_ajuste) <span class="sc">|&gt;</span> <span class="fu">transpose</span>() <span class="sc">|&gt;</span> <span class="fu">map</span>(unlist) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(errores_selec, <span class="fu">aes</span>(<span class="at">x=</span>error_prueba, <span class="at">y=</span>error_valida)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_abline</span>(<span class="at">colour=</span><span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Esto lo podemos arreglar haciendo la selección de variables dentro de cada corte de validación cruzada, y así no permitimos que la información de validación se filtre al conjunto de entrenamiento</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>seleccion_ajuste_correcto <span class="ot">&lt;-</span> <span class="cf">function</span>(...){</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">50</span>, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">50</span><span class="sc">*</span><span class="dv">500</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="dv">50</span>, <span class="dv">500</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  est_val_cruzada <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cf">function</span>(i){</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    x_vc <span class="ot">&lt;-</span> x[<span class="sc">-</span>((<span class="dv">5</span><span class="sc">*</span>i <span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="dv">5</span><span class="sc">*</span>i)),]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    y_vc <span class="ot">&lt;-</span> y[<span class="sc">-</span>((<span class="dv">5</span><span class="sc">*</span>i <span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="dv">5</span><span class="sc">*</span>i))]</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    correlaciones_vc <span class="ot">&lt;-</span> <span class="fu">cor</span>(x_vc, y_vc)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    vars_selec <span class="ot">&lt;-</span> <span class="fu">order</span>(correlaciones_vc, <span class="at">decreasing=</span><span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">y=</span>y_vc, <span class="at">x=</span> x_vc[,vars_selec], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">family=</span><span class="st">'binomial'</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lambda =</span> <span class="fl">0.5</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    preds_p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newx =</span> x[((<span class="dv">5</span><span class="sc">*</span>i <span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="dv">5</span><span class="sc">*</span>i)),vars_selec])[,<span class="dv">1</span>]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((preds_p <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">!=</span> y[((<span class="dv">5</span><span class="sc">*</span>i <span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="dv">5</span><span class="sc">*</span>i))])</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  error_validacion <span class="ot">&lt;-</span> <span class="fu">mean</span>(est_val_cruzada)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  y_p <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1000</span>, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  x_p <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span><span class="sc">*</span><span class="dv">500</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="dv">1000</span>, <span class="dv">500</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  correlaciones <span class="ot">&lt;-</span> <span class="fu">cor</span>(x, y)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  vars_selec <span class="ot">&lt;-</span> <span class="fu">order</span>(correlaciones, <span class="at">decreasing=</span><span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">y=</span>y, <span class="at">x=</span> x[,vars_selec], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">family=</span><span class="st">'binomial'</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lambda =</span> <span class="fl">0.5</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  preds_p <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newx =</span> x_p[, vars_selec])[,<span class="dv">1</span>]</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  error_prueba <span class="ot">&lt;-</span> <span class="fu">mean</span>((preds_p <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">!=</span> y_p)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'error_valida'</span><span class="ot">=</span>error_validacion, <span class="st">'error_prueba'</span><span class="ot">=</span>error_prueba)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>errores_selec <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, seleccion_ajuste_correcto) <span class="sc">|&gt;</span> <span class="fu">transpose</span>() <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(unlist) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(errores_selec, <span class="fu">aes</span>(<span class="at">x=</span>error_prueba, <span class="at">y=</span>error_valida)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_abline</span>(<span class="at">colour=</span><span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<section id="uso-de-variables-fuera-de-rango-temporal" class="level3" data-number="17.2.1">
<h3 data-number="17.2.1" class="anchored" data-anchor-id="uso-de-variables-fuera-de-rango-temporal"><span class="header-section-number">17.2.1</span> Uso de variables fuera de rango temporal</h3>
<p>Otra razón por la que nuestro proceso de validación puede estar contaminado es porque usamos agregados que no están disponibles al momento de la predicción, y están relacionados con la variable que queremos predecir. La contaminación puede ser del conjunto de validación al de entrenamiento, o puede incluir tanto entrenamiento como validación.</p>
<p>Imaginemos que queremos predecir los clientes que se van a quedar y los que se van a ir en función de las visitas que hacen a un sitio.</p>
<ul>
<li><p>Vamos a simular el tiempo que se queda cada cliente <strong>independiente</strong> de otras variables (en realidad ninguna variable nos debe ayudar a predecir mejor), y construimos una variable de entrada, el número de visitas, que depende del tiempo que un cliente permanece. Por simplicidad, suponemos que todos los clientes empiezan en el tiempo 0.</p></li>
<li><p>Vamos a suponer durante el tiempo 0.5 y 1.5, hubo una campaña de ventas para intentar recuperar a clientes abandonadores. Una fracción los clientes que abandonaron entre el tiempo 0.5 y 1.5 recibieron una llamada de servicio a cliente. Esto está registrado en la base de datos.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>simular_clientes <span class="ot">&lt;-</span> <span class="cf">function</span>(n,...){</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tiempo que permanece cada cliente</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    tiempo_cliente <span class="ot">&lt;-</span> <span class="fu">rexp</span>(n, <span class="fl">0.25</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># si se hizo un contacto, en los tiempos de la campaña</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    llamada <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tiempo_cliente <span class="sc">&gt;</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> tiempo_cliente <span class="sc">&lt;</span> <span class="fl">1.5</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.98</span>), <span class="dv">0</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cuántas visitas, dependen del tiempo (proceso de poisson)</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    num_visitas <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">rpois</span>(n, <span class="dv">5</span> <span class="sc">*</span> tiempo_cliente)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># simulamos los tiempos cuando ocurrieron esos eventos</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    tiempos <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(i){</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">runif</span>(num_visitas[i] <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">0</span>, tiempo_cliente[i])}) </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id_cliente=</span><span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">visitas =</span> tiempos, </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">tiempo_cliente =</span> tiempo_cliente,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">llamada =</span> llamada) </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>ejemplo <span class="ot">&lt;-</span> <span class="fu">simular_clientes</span>(<span class="dv">1</span>) </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>ejemplo</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  id_cliente visitas    tiempo_cliente llamada
       &lt;int&gt; &lt;list&gt;              &lt;dbl&gt;   &lt;dbl&gt;
1          1 &lt;dbl [12]&gt;           1.96       0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ejemplo <span class="sc">|&gt;</span> <span class="fu">unnest</span>(<span class="at">cols =</span> visitas)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 4
   id_cliente visitas tiempo_cliente llamada
        &lt;int&gt;   &lt;dbl&gt;          &lt;dbl&gt;   &lt;dbl&gt;
 1          1  0.0394           1.96       0
 2          1  1.52             1.96       0
 3          1  0.131            1.96       0
 4          1  1.27             1.96       0
 5          1  1.83             1.96       0
 6          1  1.41             1.96       0
 7          1  1.82             1.96       0
 8          1  0.559            1.96       0
 9          1  1.09             1.96       0
10          1  1.08             1.96       0
11          1  1.15             1.96       0
12          1  1.15             1.96       0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>clientes_futura <span class="ot">&lt;-</span> <span class="fu">simular_clientes</span>(<span class="dv">50000</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ahora supongamos que hoy estamos en el tiempo t=2, así que los datos que tenemos son los siguientes (también calculamos cuántas visitas ha tendido cada cliente hoy:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filtrar la tabla a datos de hoy</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>clientes_hoy <span class="ot">&lt;-</span> <span class="fu">mutate</span>(clientes_futura, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">visitas =</span> <span class="fu">map</span>(visitas, <span class="sc">~</span> <span class="fu">keep</span>(.x, <span class="sc">~</span> .x <span class="sc">&lt;</span> <span class="dv">2</span>)))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># calcular numero de visitas hoy</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>num_visitas_hoy <span class="ot">&lt;-</span> clientes_hoy <span class="sc">|&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id_cliente, visitas) <span class="sc">|&gt;</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">num_visitas =</span> <span class="fu">map_int</span>(visitas, length)) <span class="sc">|&gt;</span> </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>visitas)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>num_visitas_hoy <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  id_cliente num_visitas
       &lt;int&gt;       &lt;int&gt;
1          1           6
2          2          16
3          3           6
4          4           4
5          5           3
6          6           8</code></pre>
</div>
</div>
<p>Queremos calificar a nuestros clientes actuales con probabilidad de que se vaya, y queremos también evaluar esta predicción. Para hacer esto, usamos los datos con tiempo &lt; 1. ¿Quienes no se han ido? Filtramos clientes activos al tiempo t=1 y vemos quiénes abandonaron al mes t=2 (próximo mes):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>clientes_1 <span class="ot">&lt;-</span> <span class="fu">filter</span>(clientes_hoy, tiempo_cliente <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">abandona =</span> tiempo_cliente <span class="sc">&lt;</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para hacer nuestro modelo, ahora usamos el número de visitas de hoy:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>datos_mod <span class="ot">&lt;-</span> clientes_1 <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(num_visitas_hoy)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(id_cliente)`</code></pre>
</div>
</div>
<p>Y ahora dividimos entre entrenamiento y prueba:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">72427</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>datos_mod <span class="ot">&lt;-</span> datos_mod <span class="sc">|&gt;</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">u =</span> <span class="fu">runif</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>entrena <span class="ot">&lt;-</span> <span class="fu">filter</span>(datos_mod, u <span class="sc">&lt;</span> <span class="fl">0.5</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>valida <span class="ot">&lt;-</span> <span class="fu">filter</span>(datos_mod, u <span class="sc">&gt;=</span> <span class="fl">0.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ajustamos nuestro modelo</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>mod_1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(abandona <span class="sc">~</span> num_visitas <span class="sc">+</span> llamada, entrena, <span class="at">family =</span> <span class="st">'binomial'</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(mod_1)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  term        estimate std.error statistic  p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)   -0.664   0.0749     -8.86  7.89e-19
2 num_visitas   -0.141   0.00802   -17.5   7.32e-69
3 llamada       20.1   135.          0.149 8.82e- 1</code></pre>
</div>
</div>
<p>Esto parece tener sentido: cuantas más visitas, menor probabilidad de abandonar. Probamos (con pérdida logarítmica)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_1, valida, <span class="at">type =</span> <span class="st">'response'</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> <span class="fu">mean</span>(valida<span class="sc">$</span>abandona<span class="sc">*</span><span class="fu">log</span>(preds) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>valida<span class="sc">$</span>abandona)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>preds))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3068094</code></pre>
</div>
</div>
<p>Así que parece ser que nuestro modelo está haciendo una predicción razonablemente buena.</p>
<p>Ahora calificamos a los clientes corrientes del día de hoy (t=2)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>prueba <span class="ot">&lt;-</span> clientes_hoy <span class="sc">|&gt;</span> <span class="fu">filter</span>(tiempo_cliente<span class="sc">&gt;=</span><span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">num_visitas =</span> <span class="fu">map_int</span>(visitas, length))</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>prueba<span class="sc">$</span>abandona <span class="ot">&lt;-</span> prueba<span class="sc">$</span>tiempo_cliente <span class="sc">&lt;</span> <span class="dv">3</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_1, prueba, <span class="at">type =</span> <span class="st">'response'</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="fu">mean</span>(prueba<span class="sc">$</span>abandona<span class="sc">*</span><span class="fu">log</span>(preds) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>prueba<span class="sc">$</span>abandona)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>preds))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5919505</code></pre>
</div>
</div>
<p>Y nuestro modelo se degrada considerablemente - no supimos predecir los abandonadores en el próximo mes. ¿Qué está mal?</p>
<p>En primer lugar, tenemos filtración de datos porque la variable <em>llamada</em> contiene información futura del abandono de los clientes - aquellos clientes que abandonaron entre t=1 y t=1.5 es probable que tengan una llamada, y esto contamina nuestra muestra de entrenamiento con una variable que indica directamente abandono entre t=1 y t=2. <em>No podemos usar esta variable</em>, porque cuando queramos hacer predicciones no vamos a saber que se le llamó en el futuro a una persona porque había abandonado.</p>
<p>Ajustamos nuestro modelo sin <em>llamada</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mod_1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(abandona <span class="sc">~</span> num_visitas , entrena, <span class="at">family =</span> <span class="st">'binomial'</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(mod_1)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term        estimate std.error statistic   p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)    1.25    0.0560       22.3 8.31e-110
2 num_visitas   -0.288   0.00661     -43.6 0        </code></pre>
</div>
</div>
<p>y probamos en validación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_1, valida, <span class="at">type =</span> <span class="st">'response'</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="fu">mean</span>(valida<span class="sc">$</span>abandona<span class="sc">*</span><span class="fu">log</span>(preds) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>valida<span class="sc">$</span>abandona)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>preds))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4673784</code></pre>
</div>
</div>
<p>Y como esperábamos, el error subió.</p>
<p>Ahora calificamos a los clientes corrientes del día de hoy (t=2)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>prueba <span class="ot">&lt;-</span> clientes_hoy <span class="sc">|&gt;</span> <span class="fu">filter</span>(tiempo_cliente<span class="sc">&gt;=</span><span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(id_cliente) <span class="sc">|&gt;</span> <span class="fu">summarise</span>(<span class="at">num_visitas =</span> <span class="fu">length</span>(visitas), </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">tiempo_cliente =</span> <span class="fu">first</span>(tiempo_cliente), </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">llamada =</span> <span class="fu">first</span>(llamada))</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>prueba<span class="sc">$</span>abandona <span class="ot">&lt;-</span> prueba<span class="sc">$</span>tiempo_cliente <span class="sc">&lt;</span> <span class="dv">3</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_1, prueba, <span class="at">type =</span> <span class="st">'response'</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="fu">mean</span>(prueba<span class="sc">$</span>abandona<span class="sc">*</span><span class="fu">log</span>(preds) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>prueba<span class="sc">$</span>abandona)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>preds))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.068606</code></pre>
</div>
</div>
<p>y vemos que todavía tenemos problemas. ¿Qué está pasando?</p>
<p>Tenemos filtración adicional de datos porque usamos <em>las visitas totales hasta hoy</em>. Cuando este número es grande, quiere decir que es probable que el cliente no abandonó en el futuro. Así en el modelo usamos el hecho de que no había abandonado para predecir que no abandonó (!!)</p>
<p>Podemos corregir nuestro modelo corrigiendo nuestra variable de visitas, calculando sólo hasta el horizonte de modelación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>num_visitas_hoy <span class="ot">&lt;-</span> clientes_hoy <span class="sc">|&gt;</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">num_visitas =</span> <span class="fu">map_int</span>(visitas, length)) <span class="sc">|&gt;</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(num_visitas <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>num_visitas_1 <span class="ot">&lt;-</span> clientes_hoy <span class="sc">|&gt;</span> </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visitas =</span> <span class="fu">map</span>(visitas, <span class="sc">~</span> <span class="fu">keep</span>(.x, <span class="sc">~</span> .x <span class="sc">&lt;</span> <span class="dv">1</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">num_visitas =</span> <span class="fu">map_int</span>(visitas, length))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>datos_mod_2 <span class="ot">&lt;-</span> clientes_1 <span class="sc">|&gt;</span> <span class="fu">left_join</span>(num_visitas_1)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(id_cliente, visitas, tiempo_cliente, llamada)`</code></pre>
</div>
</div>
<p>Y ahora dividimos entre entrenamiento y prueba:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">72427</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>datos_mod_2 <span class="ot">&lt;-</span> datos_mod_2 <span class="sc">|&gt;</span> <span class="fu">group_by</span>(id_cliente) <span class="sc">|&gt;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="at">u =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">abandona =</span> <span class="fu">first</span>(abandona), <span class="at">num_visitas=</span><span class="fu">first</span>(num_visitas),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">llamada=</span><span class="fu">first</span>(llamada))</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>entrena_2 <span class="ot">&lt;-</span> <span class="fu">filter</span>(datos_mod_2, u <span class="sc">&lt;</span> <span class="fl">0.5</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>valida_2 <span class="ot">&lt;-</span> <span class="fu">filter</span>(datos_mod_2, u <span class="sc">&gt;=</span> <span class="fl">0.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ajustamos nuestro modelo</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>mod_2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(abandona <span class="sc">~</span>num_visitas, entrena_2, <span class="at">family =</span> <span class="st">'binomial'</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(mod_2)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term        estimate std.error statistic  p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)  2.32       0.264     8.79   1.49e-18
2 num_visitas  0.00330    0.0475    0.0695 9.45e- 1</code></pre>
</div>
</div>
<p>Nótese que el coeficiente de <em>num_visitas</em> es mucho más chico esta vez. Probamos con validación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_2, valida, <span class="at">type =</span> <span class="st">'response'</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="fu">mean</span>(valida<span class="sc">$</span>abandona<span class="sc">*</span><span class="fu">log</span>(preds) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>valida<span class="sc">$</span>abandona)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>preds))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.933531</code></pre>
</div>
</div>
<p>Ahora calificamos a los clientes corrientes del día de hoy (t=2) y vemos qué pasa:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>prueba <span class="ot">&lt;-</span> clientes_hoy <span class="sc">|&gt;</span> <span class="fu">filter</span>(tiempo_cliente<span class="sc">&gt;=</span><span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(id_cliente) <span class="sc">|&gt;</span> <span class="fu">summarise</span>(<span class="at">num_visitas =</span> <span class="fu">length</span>(visitas), </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">tiempo_cliente =</span> <span class="fu">first</span>(tiempo_cliente),</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">llamada =</span> <span class="fu">first</span>(llamada))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>prueba<span class="sc">$</span>abandona <span class="ot">&lt;-</span> prueba<span class="sc">$</span>tiempo_cliente <span class="sc">&lt;</span> <span class="dv">3</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_2, prueba, <span class="at">type =</span> <span class="st">'response'</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="fu">mean</span>(prueba<span class="sc">$</span>abandona<span class="sc">*</span><span class="fu">log</span>(preds) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>prueba<span class="sc">$</span>abandona)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>preds))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.896188</code></pre>
</div>
</div>
<p>Y vemos que nuestra validación y desempeño real coinciden, pues nuestro ejercicio de validación ya coincide con la tarea de predicción que nos interesa. En este caso, incluso nuestro proceso de entrenamiento está contaminado con datos que no tendremos cuando hacemos predicciones: al poner en producción nos podríamos dar cuenta de que no estamos usando la variable correcta.</p>
<ul>
<li>Desgraciadamente, en este ejemplo simulado no pudimos hacer nada para predecir abandono (por construcción). Pero una validación incorrecta parecía indicar que nuestro modelo podría aportar algo.</li>
</ul>
</section>
</section>
<section id="muestras-de-validación-de-poblaciones-distintas" class="level2" data-number="17.3">
<h2 data-number="17.3" class="anchored" data-anchor-id="muestras-de-validación-de-poblaciones-distintas"><span class="header-section-number">17.3</span> Muestras de validación de poblaciones distintas</h2>
<p>Otro problema común es que los datos que tenemos para validar nuestros modelos no son de la misma población para la que haremos predicciones. Este problema es común y sucede en mayor o menor medida en todos los casos. Cuando esta diferencia es grande, la validación que hacemos puede ser un mal indicador del desempeño del modelo una vez en producción.</p>
<p>Este tipo de problema es el que generalmente cuidamos en un estudio de muestreo, y nos preocupa principalmente con la muestra de validación:</p>
<ul>
<li>Si no conocemos la población y probabilidades de selección de nuestra muestra (se trata de una muestra de conveniencia), es difícil conocer las propiedades estadísticas de nuestras inferencias.</li>
<li>Si las mediciones con las que hacemos inferencia son diferentes a las que se usarán en producción con el modelo, es difícil conocer las propiedades estadísticas de nuestras inferencias.</li>
</ul>
<p>Por ejemplo:</p>
<ul>
<li>Entrenar modelos de tendencia a cometer crímenes usando fotos de la policía (criminales) contra fotos de identificaciones oficiales (no criminales). En la práctica, utilizaríamos en todos los casos fotos de identificaciones para clasificar caras. La muestra no coincide con la población.</li>
<li>Entrenar modelos de detección de enfermedades con fotografías de rayos x por ejemplo: podemos tener buen desempeño si lo utilizamos con fotografías de buena calidad, pero el desempeño puede ser muy distinto si lo usamos con fotografías tomadas en campo con un teléfono en condiciones variadas.</li>
<li>Si entrenamos un modelo en función de datos anónimos recopilados con voluntarios que instalan una <em>app</em>, por ejemplo, puede ser que nuestro modelo se desempeñe mal al aplicarlo de forma masiva.</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nótese que la gravedad del problema no es necesariamente entrenar con datos que son diferentes. El verdadero problema es intentar validar con datos muy diferentes de los que vamos a observar en la realidad, y en este caso nuestra validación es defectuosa y es difícil saber qué tanto nuestro modelo se puede degradar al ser utilizado.</p>
</div>
</div>
</section>
<section id="datos-en-conglomerados-y-muestreo-complejo" class="level2" data-number="17.4">
<h2 data-number="17.4" class="anchored" data-anchor-id="datos-en-conglomerados-y-muestreo-complejo"><span class="header-section-number">17.4</span> Datos en conglomerados y muestreo complejo</h2>
<p>En muestras complejas, con el fin de reducir costos, muchas veces se muestrean casos dentro de lo que se llama comunmente <em>unidades primarias de muestreo</em>. Por ejemplo, las unidades primarias de muestreo pueden ser manzanas, y se muestrean varios hogares dentro de cada manzana. Es más simple técnicamente y mejor desde punto de vista del error tomar hogares al azar (no agrupados), pero los costos generalmente aumentan mucho si no usamos alguna agrupación - en este ejemplo, el encuestador tendría que transportarse continuamente para levantar encuestas que fueran seleccionadas sin agrupaciones.</p>
<p>Como casos dentro de unidades primarias de muestreo son similares, y la mayor parte de las unidades primarias de muestreo no son muestreadas, tenemos un riesgo en nuestra validación: si hacemos conjuntos de validación al azar, podemos incluir casos de las mismas unidades primarias dentro de entremiento y validación. La homogeneidad de casos dentro de unidades primarias hace fácil predecir casos de validación, o dicho de otra manera: se nos está filtrando información desde el conjunto de validación al de entrenamiento (a través del comportamiento común dentro de unidades primarias de muestreo).</p>
<p>En la realidad, observaremos probablemente casos para los que no tenemos ejemplos de unidades primarias. Así que tenemos que construir nuestra validación para que refleje esta tarea.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>upms <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">100</span>,<span class="dv">1</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>simular_upms <span class="ot">&lt;-</span> <span class="cf">function</span>(n){</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="fu">seq</span>(<span class="dv">1</span>, n, <span class="dv">1</span>), <span class="cf">function</span>(upm){</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>      num_upm <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">100</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>      a <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>      b <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>      x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(num_upm, <span class="dv">0</span>, <span class="fl">0.2</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(<span class="at">upm =</span> upm, <span class="at">x =</span> x, <span class="at">z=</span> z, <span class="at">y =</span> a <span class="sc">+</span> b<span class="sc">*</span>x <span class="sc">+</span> <span class="fu">rnorm</span>(num_upm, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">simular_upms</span>(<span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>prueba <span class="ot">&lt;-</span> <span class="fu">simular_upms</span>(<span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">u =</span> <span class="fu">runif</span>(<span class="fu">nrow</span>(dat), <span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>entrena <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(u <span class="sc">&lt;</span> <span class="fl">0.5</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>valida <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(u <span class="sc">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>mod_1 <span class="ot">&lt;-</span> <span class="fu">ranger</span>(y <span class="sc">~</span> x <span class="sc">+</span> z, <span class="at">data =</span> entrena)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(<span class="fu">predict</span>(mod_1, valida)<span class="sc">$</span>predictions <span class="sc">-</span> valida<span class="sc">$</span>y)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 13.5608</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(<span class="fu">predict</span>(mod_1, prueba)<span class="sc">$</span>predictions <span class="sc">-</span> prueba<span class="sc">$</span>y)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 33.68263</code></pre>
</div>
</div>
<p>La diferencia es considerable. Podemos arreglar haciendo la validación separando distintos upms.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">u=</span><span class="fu">runif</span>(<span class="fu">nrow</span>(dat), <span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>entrena <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(upm <span class="sc">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>valida <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(upm <span class="sc">&gt;=</span> <span class="dv">50</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>mod_1 <span class="ot">&lt;-</span> <span class="fu">ranger</span>(y <span class="sc">~</span> x <span class="sc">+</span> z, <span class="at">data =</span> entrena)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(<span class="fu">predict</span>(mod_1, valida)<span class="sc">$</span>predictions <span class="sc">-</span> valida<span class="sc">$</span>y)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 39.28569</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(<span class="fu">predict</span>(mod_1, prueba)<span class="sc">$</span>predictions <span class="sc">-</span> prueba<span class="sc">$</span>y)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 37.16008</code></pre>
</div>
</div>
<p>En encuestas reales, este efecto puede variar dependiendo de la capacidad del modelo, el diseño de la encuesta (por ejemplo, si las unidades primarias de muestreo son más homogéneas o menos homogéneas, etc), y puede ir desde un efecto prácticamente ignorable hasta uno muy grande.</p>
<section id="ejemplo" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo">Ejemplo</h3>
<p>Otro ejemplo de datos en conglomerados está en nuestro ejemplo de reconocimiento de dígitos. Considera por qué es importante separar a las personas que escribieron los dígitos en entrenamiento y validación, y no los dígitos particulares.</p>
</section>
</section>
<section id="censura-y-evaluación-incompleta" class="level2" data-number="17.5">
<h2 data-number="17.5" class="anchored" data-anchor-id="censura-y-evaluación-incompleta"><span class="header-section-number">17.5</span> Censura y evaluación incompleta</h2>
<p>Algunas veces, no todos los datos que quisiéramos tener están disponibles para construir nuestros modelos: algunos clientes o casos, por ejemplo, no están en nuestros datos (son datos censurados). Sin embargo, al poner los modelos en producción, hacemos predicciones para <em>todos</em> los datos, y nuestras predicciones malas para aquellos casos antes censurados pueden dañar severamente el desempeño de nuestros modelos.</p>
<p>Este es un ejemplo de datos faltantes, pero más serio: todos las variables de algunos casos están faltantes, y algunas veces ni siquiera sabemos esto.</p>
<section id="ejemplo-tiendas-cerradas" class="level3" data-number="17.5.1">
<h3 data-number="17.5.1" class="anchored" data-anchor-id="ejemplo-tiendas-cerradas"><span class="header-section-number">17.5.1</span> Ejemplo: tiendas cerradas</h3>
<p>Supongamos que queremos predecir las ventas de tiendas según las características del un local potencial después de un año de ser abiertas. Este modelo tiene el propósito de dedicir si abrir o uno una tienda en un local posible.</p>
<p>Vamos a hacer este ejemplo con datos simulados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="cf">function</span>(z) <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>z))</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>simular_tiendas <span class="ot">&lt;-</span> <span class="cf">function</span>(n){</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Variables de entrada</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># respuesta en ventas después de un año</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span>  <span class="dv">2</span><span class="sc">*</span>x <span class="sc">+</span> a<span class="sc">+</span> w <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="fl">0.1</span>)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  ventas <span class="ot">&lt;-</span> <span class="fu">exp</span>(z)<span class="sc">*</span><span class="fl">1e5</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prob de cerrar es alta cuando las ventas son más bajas</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>  p_cerrar <span class="ot">&lt;-</span> <span class="fu">h</span>(<span class="sc">-</span><span class="dv">3</span> <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>z)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Algunas tiendas quebraron (dependiendo del nivel de ventas)</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  cerrada <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> p_cerrar)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">id_tienda=</span><span class="dv">1</span><span class="sc">:</span>n, <span class="at">x=</span>x, <span class="at">w=</span>w, <span class="at">a=</span>a, <span class="at">ventas=</span>ventas, <span class="at">cerrada =</span> cerrada)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="fu">simular_tiendas</span>(<span class="dv">10</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 6
   id_tienda       x     w       a   ventas cerrada
       &lt;int&gt;   &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;int&gt;
 1         1 -0.502      0 -0.430    23204.       1
 2         2  0.114      1 -0.702   180167.       0
 3         3 -0.470      0 -1.23     10528.       0
 4         4  0.0469     1 -1.33     87674.       0
 5         5  0.190      1 -0.0485  327119.       0
 6         6  1.01       0  0.375  1122281.       0
 7         7 -0.937      1  0.0404   40155.       0
 8         8 -0.855      1  0.156    47021.       0
 9         9 -0.680      1  1.96    477961.       0
10        10 -1.30       0 -1.18      2255.       1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">923</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>tiendas_entrena_valida <span class="ot">&lt;-</span> <span class="fu">simular_tiendas</span>(<span class="dv">2000</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>tiendas_prueba <span class="ot">&lt;-</span> <span class="fu">simular_tiendas</span>(<span class="dv">2000</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(tiendas_entrena_valida<span class="sc">$</span>cerrada)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   0    1 
1571  429 </code></pre>
</div>
</div>
<p>Ahora supongamos que el sistema borró los datos históricos de las tiendas que cerraron. Nuestros datos para trabajar son</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>entrena_valida <span class="ot">&lt;-</span> <span class="fu">filter</span>(tiendas_entrena_valida, cerrada <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(entrena_valida)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1571</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">72427</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>datos <span class="ot">&lt;-</span> entrena_valida <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">u =</span> <span class="fu">runif</span>(<span class="fu">nrow</span>(entrena_valida),<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>entrena <span class="ot">&lt;-</span> <span class="fu">filter</span>(datos, u <span class="sc">&lt;</span> <span class="fl">0.5</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>u)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>valida <span class="ot">&lt;-</span> <span class="fu">filter</span>(datos, u <span class="sc">&gt;=</span> <span class="fl">0.5</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>u)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(entrena)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 805</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(valida)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 766</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>mod_log <span class="ot">&lt;-</span> <span class="fu">ranger</span>(<span class="fu">log</span>(ventas) <span class="sc">~</span> x <span class="sc">+</span> w <span class="sc">+</span> a, <span class="at">data =</span> entrena, <span class="at">mtry=</span><span class="dv">3</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co">#mod_log &lt;- lm(log(ventas)~x+w+a, data=entrena)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>preds_log <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_log, valida)<span class="sc">$</span>predictions</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>valida<span class="sc">$</span>preds_valida <span class="ot">&lt;-</span> preds_log</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(preds_log<span class="sc">-</span><span class="fu">log</span>(valida<span class="sc">$</span>ventas))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3007202</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(valida, <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">log</span>(ventas), <span class="at">x =</span> preds_valida)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">colour=</span><span class="st">'red'</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Cuando lo aplicamos a nuevas tiendas, desgraciadamente, observamos</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>preds_log <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_log, tiendas_prueba)<span class="sc">$</span>predictions</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(preds_log <span class="sc">-</span> <span class="fu">log</span>(tiendas_prueba<span class="sc">$</span>ventas))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5729254</code></pre>
</div>
</div>
<p>El error es más alto de lo que esperábamos, y nuestra predicción para las tiendas malas es especialmente malo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>tiendas_prueba<span class="sc">$</span>pred_prueba <span class="ot">&lt;-</span> preds_log</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(tiendas_prueba, <span class="fu">aes</span>(<span class="at">y=</span><span class="fu">log</span>(ventas), </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x=</span> pred_prueba, <span class="at">colour =</span> cerrada)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">colour=</span><span class="st">'red'</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Veamos la cadena que produjo este error:</p>
<ul>
<li>La variable cerrar está naturalmente relacionada con ventas: cuanto más bajas son las ventas al año, mayor la probabilidad de cerrar.</li>
<li>En los datos de entrenamiento no tenemos las tiendas que cerraron (que tienen ventas más bajas) - estos datos están censurados</li>
<li>Nuestro modelo se desempeña bien para tiendas que tienen ventas relativamente altas.</li>
<li>Pero falla cuando intentamos predecir tiendas con ventas relativamente bajas.</li>
</ul>
<p>Soluciones para este problema son analizar cuidadosamente que datos han sido censurados de las bases de datos. En caso de que haya ocurrido, rara vez <em>todos</em> los datos fueron borrados: por ejemplo, quizá la variable respuesta se puede conseguir, y existen algunas de las variables explicativas - en este caso podríamos intentar imputación de datos.</p>
</section>
</section>
<section id="muestras-de-validación-chicas" class="level2" data-number="17.6">
<h2 data-number="17.6" class="anchored" data-anchor-id="muestras-de-validación-chicas"><span class="header-section-number">17.6</span> Muestras de validación chicas</h2>
<p>Una muestra de validación chica es casi tan malo como una muestra de entrenamiento chica. Una muestra de entrenamiento grande nos permite intentar modelos más complejos y flexible. Pero con una muestra de validación demasiado chica, no es posible discriminar entre los que se desempeñan bien y mal, desaprovechando las ganancias que podríamos tener por tener una buena muestra de entrenamiento.</p>
<p>Podemos ver la situación con el ejemplo de spam</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>spam <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'../datos/spam-entrena.csv'</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>spam_prueba <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'../datos/spam-prueba.csv'</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(spam)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3067</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(spam_prueba)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1534</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>spam <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(spam, <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="fu">nrow</span>(spam)<span class="sc">*</span><span class="dv">100</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="fu">nrow</span>(spam), <span class="dv">100</span>)))</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>spam_prueba <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(spam_prueba, <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="fu">nrow</span>(spam_prueba)<span class="sc">*</span><span class="dv">100</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="fu">nrow</span>(spam_prueba), <span class="dv">100</span>)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Haremos cortes de distinto tamaño entrenamiento/validación y veremos qué desempeño resulta de escoger nuestro modelo final (lasso) usando una muestra de validación.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>separar <span class="ot">&lt;-</span> <span class="cf">function</span>(datos, prop_entrena){</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(datos)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  datos <span class="ot">&lt;-</span> datos <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">u =</span> <span class="fu">runif</span>(n, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="fu">ifelse</span>(u <span class="sc">&lt;</span> prop_entrena, <span class="st">'entrena'</span>, <span class="st">'validación'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>u)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">table</span>(datos<span class="sc">$</span>tipo))</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  datos</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>devianza <span class="ot">&lt;-</span> <span class="cf">function</span>(z, y){</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>(y<span class="sc">*</span>z <span class="sc">-</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(z))),<span class="dv">2</span>,mean)</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>ajusta_valida <span class="ot">&lt;-</span> <span class="cf">function</span>(datos, spam_prueba){</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>  entrena <span class="ot">&lt;-</span> datos <span class="sc">|&gt;</span> <span class="fu">filter</span>(tipo <span class="sc">==</span><span class="st">'entrena'</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>tipo)</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>  validación <span class="ot">&lt;-</span> datos <span class="sc">|&gt;</span> <span class="fu">filter</span>(tipo<span class="sc">==</span><span class="st">'validación'</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>tipo)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(entrena <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>spam))</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> entrena<span class="sc">$</span>spam</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">alpha =</span> <span class="fl">0.0</span>, <span class="at">family =</span><span class="st">'binomial'</span>,</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">lambda =</span> <span class="fu">exp</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">20</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="fl">0.25</span>) ))</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>  x_val <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(validación <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>spam))</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>  y_val <span class="ot">&lt;-</span> validación<span class="sc">$</span>spam</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>  x_prueba <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(spam_prueba <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>spam))</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>  y_prueba <span class="ot">&lt;-</span> spam_prueba<span class="sc">$</span>spam</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>  val_error <span class="ot">&lt;-</span> <span class="fu">devianza</span>(<span class="fu">predict</span>(mod, x_val, <span class="at">type=</span><span class="st">'response'</span>), y_val)</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>  prueba_error <span class="ot">&lt;-</span> <span class="fu">devianza</span>(<span class="fu">predict</span>(mod, x_prueba, <span class="at">type=</span><span class="st">'response'</span>), y_prueba)</span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">lambda =</span> mod<span class="sc">$</span>lambda, <span class="at">val_error=</span>val_error, <span class="at">prueba_error =</span> prueba_error)</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Si la muestra de validación es chica, podemos escoger un modelo subóptimo, además que la estimación del error es mala</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">923</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">separar</span>(spam, <span class="fl">0.98</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   entrena validación 
      3011         56 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>df_1 <span class="ot">&lt;-</span> <span class="fu">ajusta_valida</span>(dat, spam_prueba) <span class="sc">|&gt;</span> <span class="fu">gather</span>(tipo, valor, <span class="sc">-</span>lambda)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_1, <span class="fu">aes</span>(<span class="at">x =</span> lambda, <span class="at">y =</span> valor, <span class="at">group =</span> tipo, <span class="at">colour =</span> tipo)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">scale_x_log10</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>En este caso escogemos un modelo bueno, pero la estimación es mala. Hacemos otra corrida:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">911223</span>)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">separar</span>(spam, <span class="fl">0.98</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   entrena validación 
      3000         67 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>df_1 <span class="ot">&lt;-</span> <span class="fu">ajusta_valida</span>(dat, spam_prueba) <span class="sc">|&gt;</span> <span class="fu">gather</span>(tipo, valor, <span class="sc">-</span>lambda)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_1, <span class="fu">aes</span>(<span class="at">x =</span> lambda, <span class="at">y =</span> valor, <span class="at">group =</span> tipo, <span class="at">colour =</span> tipo)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span> <span class="fu">scale_x_log10</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Por otro lado, más datos de validación nos dan una mejor estimación el error y nos permite elegir el modelo óptimo. Pero el modelo no es tan bueno porque usamos menos datos de entrenamiento.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">9113</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">separar</span>(spam, <span class="fl">0.2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   entrena validación 
       609       2458 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>df_1 <span class="ot">&lt;-</span> <span class="fu">ajusta_valida</span>(dat, spam_prueba) <span class="sc">|&gt;</span> <span class="fu">gather</span>(tipo, valor, <span class="sc">-</span>lambda)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_1, <span class="fu">aes</span>(<span class="at">x=</span>lambda, <span class="at">y=</span>valor, <span class="at">group=</span>tipo, <span class="at">colour=</span>tipo))<span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span> <span class="fu">scale_x_log10</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="17-validacion-problemas_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Cuando tenemos una muestra de validación chica, es posible obtener rangos de error para el error. El error de validación es un promedio sobre una muestra (<span class="math inline">\(\overline{x}\)</span>), así que podemos estimar su desviación estándar mediante el error estándar <span class="math inline">\(\frac{s}{\sqrt{n}}\)</span>, donde <span class="math inline">\(s\)</span> es la desviación estándar de los errores individuales de la muestra de entrenamiento.</p>
<section id="ejemplo-1" class="level4" data-number="17.6.0.1">
<h4 data-number="17.6.0.1" class="anchored" data-anchor-id="ejemplo-1"><span class="header-section-number">17.6.0.1</span> Ejemplo</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">91123</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">separar</span>(spam, <span class="fl">0.98</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   entrena validación 
      3004         63 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>devianza_valor <span class="ot">&lt;-</span> <span class="cf">function</span>(z, y){</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>(y<span class="sc">*</span>z <span class="sc">-</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(z)))</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a> entrena <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(tipo <span class="sc">==</span><span class="st">'entrena'</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>tipo)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>  validación <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(tipo<span class="sc">==</span><span class="st">'validación'</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>tipo)</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(entrena <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>spam))</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> entrena<span class="sc">$</span>spam</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">alpha =</span> <span class="fl">0.0</span>, <span class="at">family =</span><span class="st">'binomial'</span>,</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">lambda =</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">10</span> ))</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>  x_val <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(validación <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>spam))</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>  y_val <span class="ot">&lt;-</span> validación<span class="sc">$</span>spam</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>  validacion <span class="ot">&lt;-</span> <span class="fu">devianza_valor</span>(<span class="fu">predict</span>(mod, x_val, <span class="at">type=</span><span class="st">'response'</span>), y_val)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Y ahora podemos calcular el estimador puntual y el error estándar:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>media <span class="ot">&lt;-</span> <span class="fu">mean</span>(validacion)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>ee <span class="ot">&lt;-</span> <span class="fu">sd</span>(validacion)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">length</span>(validacion))</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>media</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.132495</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>ee</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.05493065</code></pre>
</div>
</div>
<p>Un intervalo del 95% para esta estimación es entonces</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(media<span class="dv">-2</span><span class="sc">*</span>ee, media<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>ee)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.022634 1.242357</code></pre>
</div>
</div>
<p>Si hacemos más grande la muestra de validación</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">separar</span>(spam, <span class="fl">0.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   entrena validación 
      1555       1512 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a> entrena <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(tipo <span class="sc">==</span><span class="st">'entrena'</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>tipo)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  validación <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(tipo<span class="sc">==</span><span class="st">'validación'</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>tipo)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(entrena <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>spam))</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> entrena<span class="sc">$</span>spam</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">alpha =</span> <span class="fl">0.0</span>, <span class="at">family =</span><span class="st">'binomial'</span>,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">lambda =</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">10</span> ))</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>  x_val <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(validación <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>spam))</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>  y_val <span class="ot">&lt;-</span> validación<span class="sc">$</span>spam</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>  validacion <span class="ot">&lt;-</span> <span class="fu">devianza_valor</span>(<span class="fu">predict</span>(mod, x_val, <span class="at">type=</span><span class="st">'response'</span>), y_val)</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>  media <span class="ot">&lt;-</span> <span class="fu">mean</span>(validacion)</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>ee <span class="ot">&lt;-</span> <span class="fu">sd</span>(validacion)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">length</span>(validacion))</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>media</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.212088</code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>ee</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01206126</code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(media<span class="dv">-2</span><span class="sc">*</span>ee, media<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>ee)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.187965 1.236210</code></pre>
</div>
</div>
</section>
<section id="ejercicio" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejercicio">Ejercicio</h3>
<ul>
<li>Repite el ejercicio anterior para la tasa de clasificación incorrecta (ajusta un modelo y calcula el estimador de validación del error junto a su error estándar)</li>
<li>Repite el ejercicio anterior para un problema de regresión: en este caso, considera que el error cuadrático medio es el promedio de los errores cuadráticos de cada caso de validación.</li>
<li>¿Cómo harías un intervalo para la raíz del error cuadrático medio? ¿Para el error absoluto promedio?</li>
</ul>
</section>
</section>
<section id="otros-ejemplos" class="level2" data-number="17.7">
<h2 data-number="17.7" class="anchored" data-anchor-id="otros-ejemplos"><span class="header-section-number">17.7</span> Otros ejemplos</h2>
<ul>
<li><p>En kaggle: un concurso para detectar cáncer de próstata contenía una variable que indicaba si el paciente había tenido una operación de próstata o no. Claramente esta variable contiene información acerca de la respuesta, pero un modelo que contiene esta variable no es útil (ve al futuro para la mayoría de los pacientes). En este caso es una filtración de la respuesta a conjunto de entrenamiento y validación.</p></li>
<li><p>E-commerce: si intentamos predecir quién va a hacer grandes compras, variables como iva (impuesto) incurrido o uso de envío gratis (que solo aplica a compras grandes) son variables que filtran información de lo que queremos predecir y no son útiles en el modelo final. Estas variables también ven al futuro.</p></li>
<li><p>En kaggle: en el proceso de recolección de los datos, el tamaño de archivos de grabaciones que contenían llamadas de ballenas era diferente de los que no contenían llamadas. Esta es una filtración, pues en la tarea real de predicción no tendremos a alguien que prepare estos archivos de la misma manera.</p></li>
<li><p>Recientemente se publicó un artículo donde se argumentaba que era posible distinguir (usando redes neuronales convolucionales) caras de criminales y no criminales. Las fotos se obtuvieron de fotos de la policía (criminales) y fotos de identificaciones (no criminales). ¿Qué crees que podría fallar aquí en términos de filtración de datos?</p></li>
</ul>
</section>
<section id="resumen" class="level2" data-number="17.8">
<h2 data-number="17.8" class="anchored" data-anchor-id="resumen"><span class="header-section-number">17.8</span> Resumen</h2>
<ul>
<li>El procesamiento de datos para modelo predictivos es difícil.</li>
<li>Cuando hay una dimensión temporal, es bueno usarla a lo largo de todo el proceso para poner una barrera entre entrenamiento y validación.</li>
<li>Cuando los datos están organizados en grupos dentro de los que hacemos predicciones, preguntarnos si queremos predecir para nuevos grupos o los mismo grupos existentes (ejemplo de las unidades primarias de muestreo).</li>
<li>Investigar cuando hay casos faltantes, y evaluar qué tan peligroso es construir un modelo para hacer predicciones</li>
<li>Muchas filtraciones son muy sutiles y dificiles de detectar. Puede tener que ver con cómo funcionan los sistemas que registran los datos, decisiones de diseños de base de datos, decisiones de limpieza de datos.</li>
<li>Siempre es bueno proponer un piloto para verificar que nuestros modelos funcionan como se espera - y considerar que una degradación del desempeño puede deberse a una filtración.</li>
<li>Finalmente, recordamos que la mejor división es entrenamiento-validación-prueba, con separaciones claras entre ellos. Usamos validación para ajustar hiperparámetros, y con prueba sólo evaluamos unos cuantos modelos.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./16-recom-factorizacion.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Dimensiones latentes: embeddings</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./81-apendice-descenso.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Apéndice 1: descenso en gradiente</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>