<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Aprendizaje Máquina - 12&nbsp; Métodos basados en árboles</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./13-arboles-boosting.html" rel="next">
<link href="./11-val-cruzada.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./12-arboles.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Métodos basados en árboles</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Buscar" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Aprendizaje Máquina</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Buscar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temario y referencias</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduccion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-principios-supervisado.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Principios de aprendizaje supervisado</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-metodos-locales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Métodos locales no estructurados</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-lineales-ingenieria.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Métodos lineales e ingenería de entradas</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-regularizacion-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Regularización y variabilidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-redes-neuronales-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Redes neuronales (intro)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-intervalos-predictivos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Incertidumbre en las predicciones</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-clasificacion-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Clasificación y probabilidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-clasificacion-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Decisiones de clasificación</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-clasificacion-calibracion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Calibración de probabilidades</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-val-cruzada.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Entrenamiento, Validación y Prueba</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-arboles.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Métodos basados en árboles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-arboles-boosting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Métodos basados en árboles: boosting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-interpretacion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Interpretación de modelos</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-reduccion-dim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Aprendizaje no supervisado: reducción de dimensionalidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Alternar sección">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./81-apendice-descenso.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Apéndice 1: descenso en gradiente</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./82-apendice-descenso-estocastico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Apéndice 2: Descenso estocástico</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-referencias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referencias</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#árboles-para-regresión-y-clasificación." id="toc-árboles-para-regresión-y-clasificación." class="nav-link active" data-scroll-target="#árboles-para-regresión-y-clasificación."><span class="header-section-number">12.1</span> Árboles para regresión y clasificación.</a>
  <ul class="collapse">
  <li><a href="#árboles-para-clasificación" id="toc-árboles-para-clasificación" class="nav-link" data-scroll-target="#árboles-para-clasificación"><span class="header-section-number">12.1.1</span> Árboles para clasificación</a></li>
  <li><a href="#tipos-de-partición" id="toc-tipos-de-partición" class="nav-link" data-scroll-target="#tipos-de-partición"><span class="header-section-number">12.1.2</span> Tipos de partición</a></li>
  <li><a href="#medidas-de-impureza" id="toc-medidas-de-impureza" class="nav-link" data-scroll-target="#medidas-de-impureza"><span class="header-section-number">12.1.3</span> Medidas de impureza</a></li>
  <li><a href="#reglas-de-partición-y-tamaño-del-árobl" id="toc-reglas-de-partición-y-tamaño-del-árobl" class="nav-link" data-scroll-target="#reglas-de-partición-y-tamaño-del-árobl"><span class="header-section-number">12.1.4</span> Reglas de partición y tamaño del árobl</a></li>
  <li><a href="#costo---complejidad-breiman" id="toc-costo---complejidad-breiman" class="nav-link" data-scroll-target="#costo---complejidad-breiman"><span class="header-section-number">12.1.5</span> Costo - Complejidad (Breiman)</a></li>
  <li><a href="#predicciones-con-cart" id="toc-predicciones-con-cart" class="nav-link" data-scroll-target="#predicciones-con-cart"><span class="header-section-number">12.1.6</span> Predicciones con CART</a></li>
  <li><a href="#árboles-para-regresión" id="toc-árboles-para-regresión" class="nav-link" data-scroll-target="#árboles-para-regresión"><span class="header-section-number">12.1.7</span> Árboles para regresión</a></li>
  <li><a href="#variabilidad-en-el-proceso-de-construcción" id="toc-variabilidad-en-el-proceso-de-construcción" class="nav-link" data-scroll-target="#variabilidad-en-el-proceso-de-construcción"><span class="header-section-number">12.1.8</span> Variabilidad en el proceso de construcción</a></li>
  <li><a href="#relaciones-lineales" id="toc-relaciones-lineales" class="nav-link" data-scroll-target="#relaciones-lineales"><span class="header-section-number">12.1.9</span> Relaciones lineales</a></li>
  <li><a href="#ventajas-y-desventajas-de-árboles" id="toc-ventajas-y-desventajas-de-árboles" class="nav-link" data-scroll-target="#ventajas-y-desventajas-de-árboles"><span class="header-section-number">12.1.10</span> Ventajas y desventajas de árboles</a></li>
  </ul></li>
  <li><a href="#bagging-de-árboles" id="toc-bagging-de-árboles" class="nav-link" data-scroll-target="#bagging-de-árboles"><span class="header-section-number">12.2</span> Bagging de árboles</a>
  <ul class="collapse">
  <li><a href="#ejemplo-5" id="toc-ejemplo-5" class="nav-link" data-scroll-target="#ejemplo-5"><span class="header-section-number">12.2.1</span> Ejemplo</a></li>
  <li><a href="#mejorando-bagging" id="toc-mejorando-bagging" class="nav-link" data-scroll-target="#mejorando-bagging"><span class="header-section-number">12.2.2</span> Mejorando bagging</a></li>
  </ul></li>
  <li><a href="#bosques-aleatorios" id="toc-bosques-aleatorios" class="nav-link" data-scroll-target="#bosques-aleatorios"><span class="header-section-number">12.3</span> Bosques aleatorios</a>
  <ul class="collapse">
  <li><a href="#sabiduría-de-las-masas" id="toc-sabiduría-de-las-masas" class="nav-link" data-scroll-target="#sabiduría-de-las-masas"><span class="header-section-number">12.3.1</span> Sabiduría de las masas</a></li>
  <li><a href="#ejemplo-6" id="toc-ejemplo-6" class="nav-link" data-scroll-target="#ejemplo-6">Ejemplo</a></li>
  <li><a href="#más-detalles-de-bosques-aleatorios" id="toc-más-detalles-de-bosques-aleatorios" class="nav-link" data-scroll-target="#más-detalles-de-bosques-aleatorios">Más detalles de bosques aleatorios</a></li>
  </ul></li>
  <li><a href="#calibración-de-probabilidades" id="toc-calibración-de-probabilidades" class="nav-link" data-scroll-target="#calibración-de-probabilidades"><span class="header-section-number">12.4</span> Calibración de probabilidades</a></li>
  <li><a href="#intervalos-y-su-calibración-para-bosques" id="toc-intervalos-y-su-calibración-para-bosques" class="nav-link" data-scroll-target="#intervalos-y-su-calibración-para-bosques"><span class="header-section-number">12.5</span> Intervalos y su calibración para bosques</a></li>
  <li><a href="#importancia-de-variables" id="toc-importancia-de-variables" class="nav-link" data-scroll-target="#importancia-de-variables"><span class="header-section-number">12.6</span> Importancia de variables</a>
  <ul class="collapse">
  <li><a href="#ajustando-árboles-aleatorios." id="toc-ajustando-árboles-aleatorios." class="nav-link" data-scroll-target="#ajustando-árboles-aleatorios."><span class="header-section-number">12.6.1</span> Ajustando árboles aleatorios.</a></li>
  <li><a href="#ventajas-y-desventajas-de-bosques-aleatorios" id="toc-ventajas-y-desventajas-de-bosques-aleatorios" class="nav-link" data-scroll-target="#ventajas-y-desventajas-de-bosques-aleatorios"><span class="header-section-number">12.6.2</span> Ventajas y desventajas de bosques aleatorios</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Métodos basados en árboles</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Los métodos basados en árboles son de un distinto tipo a redes neuronales y regresión. En redes neuronales y regresión, los modelos que usamos son <em>paramétricos</em>, en el sentido de que están definidos por un número fijo de parámetros (cuyo número lo definimos con la estructura del modelo e hiperparámetros).</p>
<p>Los árboles y métodos derivados (bosques aleatorios, boosting de árboles) son <em>no-paramétricos</em>: el número de parámetros que los definen dependen del tamaño y forma del conjunto de entrenamiento. Estos métodos tienen menos supuestos acerca de la estructura de las funciones de predicción que podemos ajustar, incluyendo qué interacciones son útiles para hacer predicciones.</p>
<p>Otro método no paramétrico que consideramos anteriormente es k-vecinos más cercanos. Vimos la deficiencias que métodos locales como este pueden tener en dimensión alta. Los métodos basados en árboles, sin embargo, están diseñados para buscar subconjuntos chicos de variables con las que se puedan hacer buenas predicciones, y en consecuencia, para muchos problemas usuales, lidian apropiadamente con el problema de dimensión alta.</p>
<section id="árboles-para-regresión-y-clasificación." class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="árboles-para-regresión-y-clasificación."><span class="header-section-number">12.1</span> Árboles para regresión y clasificación.</h2>
<p>La idea básica de los árboles es buscar puntos de cortes en las variables de entrada para hacer predicciones, ir dividiendo la muestra, y encontrar cortes sucesivos para refinar las predicciones.</p>
<section id="ejemplo" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo">Ejemplo</h4>
<p>Buscamos clasificar hogares según su ingreso, usando como entradas características de los hogares. Podríamos tener, por ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"vip"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>cbbPalette <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#000000"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">'./figuras/arboles_1.png'</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="./figuras/arboles_1.png" class="img-fluid" width="496"></p>
</div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(c("baguette", "rpart.plot", "doParallel", "doFuture"))</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Con este árbol podemos clasificar nuevos hogares.</li>
<li>Nótese que los árboles pueden capturar interacciones entre las variables de entradas. En nuestro ejemplo ficticio, “automóvil” nos da información acerca del ingreso, pero solo caundo el nivel de educación del jefe de familia es bajo. (Ejercicio: si el ingreso fuera una cantidad numérica, ¿cómo escribirías este modelo con una suma de términos que involucren las variables mostradas en el diagrama?)</li>
<li>Los árboles también pueden aproximar relaciones no lineales entre entradas y variable de salida (es similar a los ejemplos donde haciamos categorización de variables de entrada).</li>
<li>Igual que en redes neuronales, en lugar de buscar puntos de corte o interacciones a mano, con los árboles intentamos encontrarlos de manera automática.</li>
</ul>
</section>
<section id="árboles-para-clasificación" class="level3" data-number="12.1.1">
<h3 data-number="12.1.1" class="anchored" data-anchor-id="árboles-para-clasificación"><span class="header-section-number">12.1.1</span> Árboles para clasificación</h3>
<p>Un árbol particiona el espacio de entradas en rectángulos paralelos a los ejes, y hace predicciones basadas en un modelo simple dentro de cada una de esas particiones.</p>
<p>Por ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">'./figuras/arboles_2.png'</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="./figuras/arboles_2.png" class="img-fluid" width="540"></p>
</div>
</div>
<ul>
<li>El proceso de partición binaria recursiva (con una entrada a la vez) puede representarse mediante árboles binarios.</li>
<li>Los nodos terminales representan a la partición obtenida.</li>
</ul>
<p>Para definir el proceso de construcción de los árboles, debemos definir:</p>
<ol type="1">
<li>¿Cómo escoger las particiones? Idea: buscar hacer los nodos sucesivamente más puros (que una sola clase domine).</li>
<li>¿Cuándo declarar a un nodo como terminal? ¿Cuándo particionar más profundamente? Idea: dependiendo de la aplicación, buscamos hacer árboles chicos, o en otras árboles grandes que después podamos para no sobreajustar.</li>
<li>¿Cómo hacer predicciones en nodos terminales? Idea: escoger la clase más común en cada nodo terminal (la de máxima probabilidad).</li>
</ol>
</section>
<section id="tipos-de-partición" class="level3" data-number="12.1.2">
<h3 data-number="12.1.2" class="anchored" data-anchor-id="tipos-de-partición"><span class="header-section-number">12.1.2</span> Tipos de partición</h3>
<p>Supongamos que tenemos variables de entrada <span class="math inline">\((X_1,\ldots, X_p)\)</span>. Recursivamente particionamos cada nodo escogiendo entre particiones tales que:</p>
<ul>
<li>Dependen de una sola variable de entrada <span class="math inline">\(X_i\)</span></li>
<li>Si <span class="math inline">\(X_i\)</span> es continua, la partición es de la forma <span class="math inline">\(\{X_i\leq c\},\{X_i&gt; c\}\)</span>, para alguna <span class="math inline">\(c\)</span> (punto de corte)</li>
<li>Si <span class="math inline">\(X_i\)</span> es categórica, la partición es de la forma <span class="math inline">\(\{X_i\in S\},\{X_i\notin S\}\)</span>, para algún subconjunto <span class="math inline">\(S\)</span> de categorías de <span class="math inline">\(X_i\)</span>.</li>
<li>En cada nodo candidato, escogemos uno de estos cortes para particionar.</li>
</ul>
<p>¿Cómo escogemos la partición en cada nodo? En cada nodo, la partición se escoge de una manera miope o local, intentando separar las clases lo mejor que se pueda (sin considerar qué pasa en cortes hechos más adelante). En un nodo dado, escogemos la partición que <strong>reduce lo más posible su impureza</strong>.</p>
</section>
<section id="medidas-de-impureza" class="level3" data-number="12.1.3">
<h3 data-number="12.1.3" class="anchored" data-anchor-id="medidas-de-impureza"><span class="header-section-number">12.1.3</span> Medidas de impureza</h3>
<p>Consideramos un nodo <span class="math inline">\(t\)</span> de un árbol <span class="math inline">\(T\)</span>, y sean <span class="math inline">\(p_1(t),\ldots, p_K(t)\)</span> las proporciones de casos de <span class="math inline">\(t\)</span> que caen en cada categoría.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Nota
</div>
</div>
<div class="callout-body-container callout-body">
<p>La <strong>impureza</strong> de un nodo <span class="math inline">\(t\)</span> está dada por <span class="math display">\[i(t) = -\sum_{j=1}^K p_j(t)\log p_j(t)\]</span> Este medida se llama entropía. Hay otras posibilidades como medida de impureza (por ejemplo, coeficiente de Gini).</p>
</div>
</div>
<section id="ejemplo-1" class="level4" data-number="12.1.3.1">
<h4 data-number="12.1.3.1" class="anchored" data-anchor-id="ejemplo-1"><span class="header-section-number">12.1.3.1</span> Ejemplo</h4>
<p>Graficamos la medida de impureza para dos clases:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>impureza <span class="ot">&lt;-</span> <span class="cf">function</span>(p){</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span>(p<span class="sc">*</span><span class="fu">log</span>(p) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>p)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>p))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(impureza, <span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Donde vemos que la máxima impureza se alcanza cuando las proporciones de clase en un nodo son 50-50, y la mínima impureza (máxima pureza) se alcanza cuando en el nodo solo hay casos de una clase. Nótese que esta cantidad es proporcional a la devianza del nodo, donde tenemos porbabilidad constante de clase 1 igual a <span class="math inline">\(p\)</span>.</p>
</section>
</section>
<section id="reglas-de-partición-y-tamaño-del-árobl" class="level3" data-number="12.1.4">
<h3 data-number="12.1.4" class="anchored" data-anchor-id="reglas-de-partición-y-tamaño-del-árobl"><span class="header-section-number">12.1.4</span> Reglas de partición y tamaño del árobl</h3>
<p>Podemos escribir la regla de partición, que se aplica a cada nodo de un árbol</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Regla de partición
</div>
</div>
<div class="callout-body-container callout-body">
<p>En cada nodo, buscamos entre <strong>todas</strong> las variables <span class="math inline">\(X_i\)</span> y <strong>todos</strong> los puntos de corte <span class="math inline">\(c\)</span> la que da la mayor reducción de impureza posible (donde la impureza de un corte es el promedio ponderado por casos de las impurezas de los nodos resultantes).</p>
</div>
</div>
<section id="ejemplo-2" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-2">Ejemplo</h4>
<p>Consideremos un nodo <span class="math inline">\(t\)</span>, cuyos casos de entrenamiento son:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>n_t <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">200</span>,<span class="dv">100</span>, <span class="dv">150</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>impureza <span class="ot">&lt;-</span> <span class="cf">function</span>(p){</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(p<span class="sc">*</span><span class="fu">log</span>(p))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">impureza</span>(n_t<span class="sc">/</span><span class="fu">sum</span>(n_t))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.060857</code></pre>
</div>
</div>
<p>Y comparamos con</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>n_t <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">300</span>,<span class="dv">10</span>, <span class="dv">140</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>impureza <span class="ot">&lt;-</span> <span class="cf">function</span>(p){</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> p[p<span class="sc">&gt;</span><span class="dv">0</span>]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(p<span class="sc">*</span><span class="fu">log</span>(p))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">impureza</span>(n_t<span class="sc">/</span><span class="fu">sum</span>(n_t))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7181575</code></pre>
</div>
</div>
<p>Ahora supongamos que tenemos un posible corte, el primero resulta en</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>n_t <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">300</span>,<span class="dv">10</span>, <span class="dv">140</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>n_1 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">300</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>n_2 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>,<span class="dv">140</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(n_1)<span class="sc">/</span><span class="fu">sum</span>(n_t))<span class="sc">*</span><span class="fu">impureza</span>(n_1<span class="sc">/</span><span class="fu">sum</span>(n_1)) <span class="sc">+</span> (<span class="fu">sum</span>(n_2)<span class="sc">/</span><span class="fu">sum</span>(n_t))<span class="sc">*</span><span class="fu">impureza</span>(n_2<span class="sc">/</span><span class="fu">sum</span>(n_2))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.08164334</code></pre>
</div>
</div>
<p>Un peor corte es:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>n_t <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">300</span>,<span class="dv">10</span>, <span class="dv">140</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>n_1 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">200</span>,<span class="dv">0</span>,<span class="dv">40</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>n_2 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">10</span>,<span class="dv">100</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(n_1)<span class="sc">/</span><span class="fu">sum</span>(n_t))<span class="sc">*</span><span class="fu">impureza</span>(n_1<span class="sc">/</span><span class="fu">sum</span>(n_1)) <span class="sc">+</span> (<span class="fu">sum</span>(n_2)<span class="sc">/</span><span class="fu">sum</span>(n_t))<span class="sc">*</span><span class="fu">impureza</span>(n_2<span class="sc">/</span><span class="fu">sum</span>(n_2))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6377053</code></pre>
</div>
</div>
<p>Lo que resta explicar es qué criterio de paro utilizamos para dejar de particionar.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Regla de paro
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cuando usemos árboles en ótros métodos, generalmente hay dos opciones:</p>
<ul>
<li>Particionar hasta cierta profundidad fija (por ejemplo, máximo 8 nodos terminales). Este enfoque generalmente usa árboles relativamente chicos (se usa en boosting de árboles).</li>
<li>Dejar de particionar cuando encontramos un número mínimo de casos en un nodo (por ejemplo, 5 o 10 casos). Este enfoque resulta en árboles grandes, probablemente sobreajustados (se usa en bosques aleatorios).</li>
</ul>
<p>Y cuando utilizamos los árboles por sí solos para hacer predicciones:</p>
<ul>
<li>Podemos probar distintos valores de tamaño de árbol, y escogemos por validación (muestra o cruzada) el tamaño final.</li>
<li>Podemos usar el método CART de Breiman, que consiste en construir un árbol grande y luego podar al tamaño correcto.</li>
</ul>
</div>
</div>
</section>
<section id="ejemplo-3" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-3">Ejemplo</h4>
<p>Construímos algunos árboles con los datos de spam:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)                 </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>spam_entrena <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'../datos/spam-entrena.csv'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spam =</span> <span class="fu">ifelse</span>(spam <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"no_spam"</span>, <span class="st">"spam"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spam =</span> <span class="fu">factor</span>(spam))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>spam_prueba <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'../datos/spam-prueba.csv'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spam =</span> <span class="fu">ifelse</span>(spam <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"no_spam"</span>, <span class="st">"spam"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spam =</span> <span class="fu">factor</span>(spam)) </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(spam_entrena)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 59
   ...1 wfmake wfaddress wfall  wf3d wfour wfover wfremove wfinternet wforder
  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;
1     1   0         0.57  0        0  0         0        0          0    0   
2     2   1.24      0.41  1.24     0  0         0        0          0    0   
3     3   0         0     0        0  0         0        0          0    0   
4     4   0         0     0.48     0  0.96      0        0          0    0.48
5     5   0.54      0     0.54     0  1.63      0        0          0    0   
6     6   0         0     0        0  0         0        0          0    0   
# ℹ 49 more variables: wfmail &lt;dbl&gt;, wfreceive &lt;dbl&gt;, wfwill &lt;dbl&gt;,
#   wfpeople &lt;dbl&gt;, wfreport &lt;dbl&gt;, wfaddresses &lt;dbl&gt;, wffree &lt;dbl&gt;,
#   wfbusiness &lt;dbl&gt;, wfemail &lt;dbl&gt;, wfyou &lt;dbl&gt;, wfcredit &lt;dbl&gt;, wfyour &lt;dbl&gt;,
#   wffont &lt;dbl&gt;, wf000 &lt;dbl&gt;, wfmoney &lt;dbl&gt;, wfhp &lt;dbl&gt;, wfhpl &lt;dbl&gt;,
#   wfgeorge &lt;dbl&gt;, wf650 &lt;dbl&gt;, wflab &lt;dbl&gt;, wflabs &lt;dbl&gt;, wftelnet &lt;dbl&gt;,
#   wf857 &lt;dbl&gt;, wfdata &lt;dbl&gt;, wf415 &lt;dbl&gt;, wf85 &lt;dbl&gt;, wftechnology &lt;dbl&gt;,
#   wf1999 &lt;dbl&gt;, wfparts &lt;dbl&gt;, wfpm &lt;dbl&gt;, wfdirect &lt;dbl&gt;, wfcs &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Podemos construir un árbol grande:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>spam_arbol <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(<span class="at">cost_complexity =</span> <span class="dv">0</span>, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min_n =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_args</span>(<span class="at">model =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># receta</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>spam_receta <span class="ot">&lt;-</span> <span class="fu">recipe</span>(spam <span class="sc">~</span> ., spam_entrena) <span class="sc">|&gt;</span> </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_relevel</span>(spam, <span class="at">ref_level =</span> <span class="st">"no_spam"</span>, <span class="at">skip =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># flujo</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>spam_flujo_1 <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(spam_receta) <span class="sc">|&gt;</span> </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(spam_arbol) </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>arbol_grande <span class="ot">&lt;-</span> <span class="fu">fit</span>(spam_flujo_1, spam_entrena)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>arbol_grande_1 <span class="ot">&lt;-</span> <span class="fu">extract_fit_parsnip</span>(arbol_grande)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(arbol_grande_1<span class="sc">$</span>fit, <span class="at">type=</span><span class="dv">4</span>, <span class="at">extra=</span><span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: labs do not fit even at cex 0.15, there may be some overplotting</code></pre>
</div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos examinar la parte de arriba del árbol:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>arbol_chico_1 <span class="ot">&lt;-</span> <span class="fu">prune</span>(arbol_grande_1<span class="sc">$</span>fit, <span class="at">cp =</span> <span class="fl">0.07</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(arbol_chico_1, <span class="at">type =</span> <span class="dv">4</span>, <span class="at">extra =</span> <span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos hacer predicciones con este árbol grande. Por ejemplo, en entrenamiento tenemos las predicciones de clase dan:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>metricas_spam <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(roc_auc, accuracy, sens, spec)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>preds_entrena <span class="ot">&lt;-</span> <span class="fu">predict</span>(arbol_grande, spam_entrena, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(arbol_grande, spam_entrena)) <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(spam_entrena <span class="sc">|&gt;</span> <span class="fu">select</span>(spam))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>preds_entrena <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">metricas_spam</span>(spam, .pred_no_spam, <span class="at">estimate =</span> .pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(is_double, round, <span class="dv">2</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 2 warnings in `mutate()`.
The first warning was:
ℹ In argument: `across(is_double, round, 2)`.
Caused by warning:
! Use of bare predicate functions was deprecated in tidyselect 1.1.0.
ℹ Please use wrap predicates in `where()` instead.
  # Was:
  data %&gt;% select(is_double)

  # Now:
  data %&gt;% select(where(is_double))
ℹ Run `dplyr::last_dplyr_warnings()` to see the 1 remaining warning.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary             1
2 sens     binary             1
3 spec     binary             1
4 roc_auc  binary             1</code></pre>
</div>
</div>
<p>y en prueba:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>preds_prueba <span class="ot">&lt;-</span> <span class="fu">predict</span>(arbol_grande, spam_prueba, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(arbol_grande, spam_prueba)) <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(spam_prueba <span class="sc">|&gt;</span> <span class="fu">select</span>(spam))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>preds_prueba <span class="sc">|&gt;</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">metricas_spam</span>(spam, .pred_no_spam, <span class="at">estimate =</span> .pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(is_double, round, <span class="dv">2</span>)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary          0.9 
2 sens     binary          0.92
3 spec     binary          0.88
4 roc_auc  binary          0.9 </code></pre>
</div>
</div>
<p>Y notamos la brecha grande entre prueba y entrenamiento, lo que sugiere sobreajuste. Este árbol es demasiado grande.</p>
</section>
</section>
<section id="costo---complejidad-breiman" class="level3" data-number="12.1.5">
<h3 data-number="12.1.5" class="anchored" data-anchor-id="costo---complejidad-breiman"><span class="header-section-number">12.1.5</span> Costo - Complejidad (Breiman)</h3>
<p>Una manera de escoger árboles del tamaño correcto es utilizando una medida inventada por Breiman para medir la calidad de un árbol. La complejidad de un árbol <span class="math inline">\(T\)</span> está dada por (para <span class="math inline">\(\alpha\)</span> fija):</p>
<p><span class="math display">\[C_\alpha (T) = \overline{err}(T) + \alpha \vert T\vert\]</span> donde</p>
<ul>
<li><span class="math inline">\(\overline{err}(T)\)</span> es el error de clasificación de <span class="math inline">\(T\)</span></li>
<li><span class="math inline">\(\vert T\vert\)</span> es el número de nodos terminales del árbol</li>
<li><span class="math inline">\(\alpha&gt;0\)</span> es un parámetro de penalización del tamaño del árbol.</li>
</ul>
<p>Esta medida de complejidad incluye qué tan bien clasifica el árbol en la muestra de entrenamiento, pero penaliza por el tamaño del árbol.</p>
<p>Para escoger el tamaño del árbol correcto, definimos <span class="math inline">\(T_\alpha \subset T\)</span> como el subárbol de <span class="math inline">\(T\)</span> que minimiza la medida <span class="math inline">\(C_\alpha (T_\alpha)\)</span>.</p>
<p>Para entender esta decisión, obsérvese que:</p>
<ul>
<li>Un subárbol grande de <span class="math inline">\(T\)</span> tiene menor valor de <span class="math inline">\(\overline{err}(T)\)</span> (pues usa más cortes)</li>
<li>Pero un subárbol grande de <span class="math inline">\(T\)</span> tiene más penalización por complejidad <span class="math inline">\(\alpha\vert T\vert\)</span>.</li>
</ul>
<p>De modo que para <span class="math inline">\(\alpha\)</span> fija, el árbol <span class="math inline">\(T_\alpha\)</span> hace un balance entre error de entrenamiento y penalización por complejidad.</p>
<section id="ejemplo-4" class="level4" data-number="12.1.5.1">
<h4 data-number="12.1.5.1" class="anchored" data-anchor-id="ejemplo-4"><span class="header-section-number">12.1.5.1</span> Ejemplo</h4>
<p>Podemos ver subárboles más chicos creados durante el procedimiento de división de nodos (prp está el paquete rpart.plot). En este caso pondemos <span class="math inline">\(\alpha = 0.2\)</span> (cp = <span class="math inline">\(\alpha\)</span> = complexity parameter):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>arbol_chico_1 <span class="ot">&lt;-</span> <span class="fu">prune</span>(arbol_grande_1<span class="sc">$</span>fit, <span class="at">cp =</span> <span class="fl">0.2</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(arbol_chico_1, <span class="at">type =</span> <span class="dv">4</span>, <span class="at">extra =</span> <span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Si disminuimos el coeficiente <span class="math inline">\(\alpha\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>arbol_chico_1 <span class="ot">&lt;-</span> <span class="fu">prune</span>(arbol_grande_1<span class="sc">$</span>fit, <span class="at">cp =</span> <span class="fl">0.07</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(arbol_chico_1, <span class="at">type =</span> <span class="dv">4</span>, <span class="at">extra =</span> <span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>y vemos que en efecto el árbol <span class="math inline">\(T_{0.07}\)</span> contiene al árbol <span class="math inline">\(T_{0.2}\)</span>, y ambos son subárboles del árbol gigante que construimos al principio.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Para podar un árbol con costo-complejidad, encontramos para cada <span class="math inline">\(\alpha&gt;0\)</span> (coeficiente de complejidad) un árbol <span class="math inline">\(T_\alpha\subset T\)</span> que minimiza el costo-complejidad. Esto resulta en una sucesión de árboles <span class="math inline">\(T_0\subset T_1\subset T_2\subset \cdots T_m\subset T\)</span>, de donde podemos escoger con validación el árbol óptimo.</p>
</div>
</div>
<p><em>Nota</em>: Esto es un teorema que hace falta demostrar: el resultado principal es que conforme aumentamos <span class="math inline">\(\alpha\)</span>, vamos eliminiando ramas del árbol, de manera que los árboles más chicos siempre sin subárboles de los más grandes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'../R/fancyRpartPlot.R'</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fancyRpartPlot</span>(arbol_chico_1, <span class="at">sub=</span><span class="st">''</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Nota</strong>: Enfoques de predicción basados en un solo árbol para clasificación y regresión son típicamente superados en predicción por otros métodos. ¿Cuál crees que sea la razón? ¿Es un problema de varianza o sesgo?</p>
</section>
</section>
<section id="predicciones-con-cart" class="level3" data-number="12.1.6">
<h3 data-number="12.1.6" class="anchored" data-anchor-id="predicciones-con-cart"><span class="header-section-number">12.1.6</span> Predicciones con CART</h3>
<p>En el método de poda usual y selección de complejidad seleccionamos la complejidad que minimiza el error de clasificación.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># esta es una manera de que la validación cruzada</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># corra en paralelo.</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("doParallel")</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("doFuture")</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="dv">5</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(cluster, <span class="at">workers =</span> cl)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="12-arboles_cache/html/unnamed-chunk-19_baf7dea82818c99b9c48d2b1162e8d7e">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">993</span>) <span class="co"># para hacer reproducible la validación cruzada</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>cortes_vc <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(spam_entrena, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># afinamos dos parámetros</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>spam_arbol <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(<span class="at">cost_complexity =</span> <span class="fu">tune</span>(), </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min_n =</span> <span class="fu">tune</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>spam_receta <span class="ot">&lt;-</span> <span class="fu">recipe</span>(spam <span class="sc">~</span> ., spam_entrena)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>spam_flujo <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(spam_receta) <span class="sc">|&gt;</span> </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(spam_arbol) </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co"># validación cruzada</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>valores_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">cost_complexity =</span> <span class="fu">c</span>(<span class="fu">exp</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">8</span>, <span class="sc">-</span><span class="dv">4</span>, <span class="fl">0.25</span>))),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min_n =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">40</span>))</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>evaluacion_vc <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(spam_flujo, </span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>                           <span class="at">resamples =</span> cortes_vc,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>                           <span class="at">grid =</span> valores_grid)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>metricas_vc <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(evaluacion_vc)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>metricas_vc</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 136 × 8
   cost_complexity min_n .metric  .estimator  mean     n std_err .config        
             &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;          
 1        0.000335     5 accuracy binary     0.919    10 0.00538 Preprocessor1_…
 2        0.000335     5 roc_auc  binary     0.922    10 0.00801 Preprocessor1_…
 3        0.000335    10 accuracy binary     0.918    10 0.00599 Preprocessor1_…
 4        0.000335    10 roc_auc  binary     0.941    10 0.00626 Preprocessor1_…
 5        0.000335    20 accuracy binary     0.910    10 0.00537 Preprocessor1_…
 6        0.000335    20 roc_auc  binary     0.946    10 0.00433 Preprocessor1_…
 7        0.000335    40 accuracy binary     0.895    10 0.00514 Preprocessor1_…
 8        0.000335    40 roc_auc  binary     0.936    10 0.00572 Preprocessor1_…
 9        0.000431     5 accuracy binary     0.920    10 0.00546 Preprocessor1_…
10        0.000431     5 roc_auc  binary     0.923    10 0.00807 Preprocessor1_…
# ℹ 126 more rows</code></pre>
</div>
</div>
<p>Y vemos los resultados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(metricas_vc <span class="sc">|&gt;</span> <span class="fu">filter</span>(.metric <span class="sc">==</span><span class="st">"roc_auc"</span>), </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> cost_complexity, <span class="at">y =</span> mean, </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err, <span class="at">group =</span> <span class="fu">factor</span>(min_n), </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> <span class="fu">factor</span>(min_n))) <span class="sc">+</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>() <span class="sc">+</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"AUC estimado vc-10"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y usamos la regla de mínimo error o a una desviación estándar del error mínimo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>mejor_arbol <span class="ot">&lt;-</span> <span class="fu">select_by_one_std_err</span>(evaluacion_vc, </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">metric =</span> <span class="st">"roc_auc"</span>, <span class="fu">desc</span>(cost_complexity))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>mejor_arbol</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  cost_complexity min_n .metric .estimator  mean     n std_err .config     .best
            &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;
1         0.00150    20 roc_auc binary     0.944    10 0.00335 Preprocess… 0.947
# ℹ 1 more variable: .bound &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Y ajustamos el modelo final y lo evaluamos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>arbol_podado_vc <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(spam_flujo, mejor_arbol) <span class="sc">|&gt;</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(spam_entrena)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(arbol_podado_vc, spam_prueba, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(arbol_podado_vc, spam_prueba)) <span class="sc">|&gt;</span> </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(spam_prueba <span class="sc">|&gt;</span> <span class="fu">select</span>(spam)) <span class="sc">|&gt;</span> </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">metricas_spam</span>(spam, .pred_no_spam, <span class="at">estimate =</span> .pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(is_double, round, <span class="dv">2</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary          0.91
2 sens     binary          0.94
3 spec     binary          0.87
4 roc_auc  binary          0.93</code></pre>
</div>
</div>
</section>
<section id="árboles-para-regresión" class="level3" data-number="12.1.7">
<h3 data-number="12.1.7" class="anchored" data-anchor-id="árboles-para-regresión"><span class="header-section-number">12.1.7</span> Árboles para regresión</h3>
<p>Para problemas de regresión, el criterio de pureza y la predicción en cada nodo terminal es diferente:</p>
<ul>
<li>En los nodos terminales usamos el promedio los casos de entrenamiento que caen en tal nodo (en lugar de la clase más común)</li>
<li>La impureza de define como varianza: si <span class="math inline">\(t\)</span> es un nodo, su impureza está dada por <span class="math inline">\(\frac{1}{n(t)}\sum (y - m)^2\)</span>, donde la suma es sobre los casos que están en el nodo y <span class="math inline">\(m\)</span> es la media de las <span class="math inline">\(y\)</span>’s del nodo.</li>
</ul>
</section>
<section id="variabilidad-en-el-proceso-de-construcción" class="level3" data-number="12.1.8">
<h3 data-number="12.1.8" class="anchored" data-anchor-id="variabilidad-en-el-proceso-de-construcción"><span class="header-section-number">12.1.8</span> Variabilidad en el proceso de construcción</h3>
<p>Existe variabilidad considerable en el proceso de división, lo cual es una debilidad de los árboles. Por ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># muestra bootstrap</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">91923</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>muestra_1 <span class="ot">&lt;-</span> <span class="fu">sample_frac</span>(spam_entrena, <span class="dv">1</span> , <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>spam_1 <span class="ot">&lt;-</span><span class="fu">rpart</span>(spam <span class="sc">~</span> ., <span class="at">data =</span>  muestra_1, <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>arbol_podado <span class="ot">&lt;-</span> <span class="fu">prune</span>(spam_1, <span class="at">cp=</span><span class="fl">0.03</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(arbol_podado, <span class="at">type =</span> <span class="dv">4</span>, <span class="at">extra =</span> <span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># muestra bootstrap</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>muestra_1 <span class="ot">&lt;-</span> <span class="fu">sample_frac</span>(spam_entrena, <span class="dv">1</span> , <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>spam_1 <span class="ot">&lt;-</span><span class="fu">rpart</span>(spam <span class="sc">~</span> ., <span class="at">data =</span>  muestra_1, <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>arbol_podado <span class="ot">&lt;-</span> <span class="fu">prune</span>(spam_1, <span class="at">cp=</span><span class="fl">0.03</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(arbol_podado, <span class="at">type =</span> <span class="dv">4</span>, <span class="at">extra =</span> <span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Pequeñas diferencias en la muestra de entrenamiento produce distintas selecciones de variables y puntos de corte, y estructuras de árboles muchas veces distintas. Esto introduce varianza considerable en las predicciones.</p>
</section>
<section id="relaciones-lineales" class="level3" data-number="12.1.9">
<h3 data-number="12.1.9" class="anchored" data-anchor-id="relaciones-lineales"><span class="header-section-number">12.1.9</span> Relaciones lineales</h3>
<p>Los árboles pueden requerir ser muy grandes para estimar apropiadamente relaciones lineales.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">200</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>x <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">200</span>, <span class="dv">0</span>, <span class="fl">0.1</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>arbol <span class="ot">&lt;-</span> <span class="fu">rpart</span>(y <span class="sc">~</span> x, <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">x =</span> x, <span class="at">y =</span> y), <span class="at">method =</span> <span class="st">'anova'</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.05</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>y_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(arbol, <span class="at">newdata =</span> <span class="fu">tibble</span>(<span class="at">x =</span> x_pred))</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>y_verdadera <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> x_pred</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x_pred =</span> x_pred, <span class="at">y_pred =</span> y_pred, <span class="at">y_verdadera =</span> y_verdadera) <span class="sc">|&gt;</span> </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> y_pred<span class="sc">:</span>y_verdadera)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> x_pred, <span class="at">y =</span> value, <span class="at">colour =</span> name)) <span class="sc">+</span> <span class="fu">geom_line</span>() </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
<section id="ventajas-y-desventajas-de-árboles" class="level3" data-number="12.1.10">
<h3 data-number="12.1.10" class="anchored" data-anchor-id="ventajas-y-desventajas-de-árboles"><span class="header-section-number">12.1.10</span> Ventajas y desventajas de árboles</h3>
<p>Ventajas:</p>
<ol type="1">
<li>Árboles chicos son relativamente fáciles de explicar</li>
<li>Capturan interacciones entre las variables de entrada</li>
<li>Son robustos en el sentido de que</li>
</ol>
<ul>
<li>valores numéricos atípicos no hacen fallar al método</li>
<li>no es necesario transformar (monótonamente) variables de entrada</li>
<li>hay formas fáciles de lidiar con datos faltantes (cortes sucedáneos)</li>
</ul>
<ol start="4" type="1">
<li>Se ajustan rápidamente y son relativamente fáciles de interpretar (por ejemplo, son útiles para clasificar en campo)</li>
<li>Árboles grandes generalmente no sufren de sesgo.</li>
</ol>
<p>Desventajas:</p>
<ol type="1">
<li>Tienen dificultades en capturar estructuras lineales.</li>
<li>En la interpretación, tienen la dificultad de que muchas veces algunas variables de entrada “enmascaran” a otras. Que una variable de entrada no esté en el árbol no quiere decir que no sea “importante” para predecir (regresión ridge lidia mejor con esto).</li>
<li>Son inestables (varianza alta) por construcción: es local/miope, basada en cortes duros si/no. Esto produce desempeño predictivo relativamente malo. (p ej: una pequeña diferencia en cortes iniciales puede resultar en estructuras de árbol totalmente distintas).</li>
<li>Adicionalmente, no son apropiados cuando hay variables categóricas con muchas niveles: en estos casos, el árbol sobreajusta desde los primeros cortes, y las predicciones son malas.</li>
</ol>
</section>
</section>
<section id="bagging-de-árboles" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="bagging-de-árboles"><span class="header-section-number">12.2</span> Bagging de árboles</h2>
<p>Bosques aleatorios es un método de predicción que utiliza familias de árboles para hacer predicciones.</p>
<p>Los árboles grandes tienen la ventaja de tener sesgo bajo, pero sufren de varianza alta. Podemos explotar el sesgo bajo si logramos controlar la varianza. Una idea primera para lograr esto es es hacer <strong>bagging</strong> de árboles:</p>
<ul>
<li>Perturbar la muestra de entrenamiento de distintas maneras y producir árboles distintos (grandes). La perturbación más usada es tomar muestras bootstrap de los datos y ajustar un árbol a cada muestra bootstrap</li>
<li>Promediar el resultado de todos estos árboles para hacer predicciones. El proceso de promediar reduce la varianza, sin tener pérdidas en sesgo.</li>
</ul>
<p>La idea básica de bagging (<em>bootstrap aggregation</em>) es la siguiente:</p>
<p>Consideramos el proceso <span class="math inline">\({\mathcal L} \to T_{\mathcal L}\)</span>, que representa el proceso de ajuste de un árbol <span class="math inline">\(T_{\mathcal L}\)</span> a partir de la muestra de entrenamiento <span class="math inline">\({\mathcal L}\)</span>. Si pudiéramos obtener distintas muestras de entrenamiento <span class="math display">\[{\mathcal L}_1, {\mathcal L}_2, \ldots, {\mathcal L}_B,\]</span> y supongamos que construimos los árboles (que suponemos de regresión) <span class="math display">\[T_1, T_2, \ldots, T_B,\]</span> Podríamos mejorar nuestras predicciones construyendo el árbol promedio <span class="math display">\[T(x) = \frac{1}{B}\sum_{i=b}^B  T_b (x)\]</span> ¿Por qué es mejor este árbol promedio que cualquiera de sus componentes? Veamos primero el sesgo. El valor esperado del árbol promedio es <span class="math display">\[E[T(x)] = \frac{1}{B}\sum_{i=b}^B  E[T_b (x)]\]</span> y como cada <span class="math inline">\(T_b(x)\)</span> se construye de la misma manera a partir de <span class="math inline">\({\mathcal L}_b\)</span>, y todas las muestras <span class="math inline">\({\mathcal L}_b\)</span> se extraen de la misma forma, todos los términos de la suma de la derecha son iguales: <span class="math display">\[E[T(x)] =  E[T_1 (x)],\]</span> lo que implica que el sesgo del promedio es igual al sesgo de un solo árbol (que es bajo, pues suponemos que los árboles son grandes).</p>
<p>Ahora veamos la varianza. Como las muestras <span class="math inline">\({\mathcal L}_b\)</span> se extraen <em>de manera independiente</em>, entonces</p>
<p><span class="math display">\[Var[T(x)] = Var\left( \frac{1}{B}\sum_{i=b}^B  T_b (x)\right) = \frac{1}{B^2}\sum_{i=b}^B  Var[T_b (x)],\]</span> pues los distintos <span class="math inline">\(T_b(x)\)</span> no están correlacionados (en ese caso, varianza de la suma es la suma de las varianzas), y las constantes salen de la varianza al cuadrado. Por las mismas razones que arriba, todos los términos de la derecha son iguales, y <span class="math display">\[Var[T(x)] = \frac{1}{B}\ Var[T_1 (x)]\]</span> de modo que la varianza del árbol promedio es mucho más chica que la varianza de un árbol dado (si <span class="math inline">\(B\)</span> es grande).</p>
<p>Sin embargo, no podemos tomar muestras de entrenamiento repetidamente para ajustar estos árboles. ¿Cómo podemos simular extraer distintas muestras de entrenamiento?</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Nota
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sabemos que si tenemos una muestra de entrenamiento fija <span class="math inline">\({\mathcal L}\)</span>, podemos evaluar la variación de esta muestra tomando <strong>muestras bootstrap</strong> de <span class="math inline">\({\mathcal L}\)</span>, que denotamos por</p>
<p><span class="math display">\[{\mathcal L}_1^*, {\mathcal L}_2^*, \ldots, {\mathcal L}_B^*,\]</span></p>
<p>Recordatorio: una muestra bootstrap de <span class="math inline">\(\mathcal L\)</span> es una muestra con con reemplazo de <span class="math inline">\({\mathcal L}\)</span> del mismo tamaño que <span class="math inline">\({\mathcal L}\)</span>.</p>
</div>
</div>
<p>Entonces la idea es que construimos los árboles (que suponemos de regresión) <span class="math display">\[T_1^*, T_2^*, \ldots, T_B^*,\]</span> podríamos mejorar nuestras predicciones construyendo el árbol promedio <span class="math display">\[T^*(x) = \frac{1}{B}\sum_{i=b}^B  T_b^* (x)\]</span> para suavizar la variación de cada árbol individual.</p>
<p>El argumento del sesgo aplica en este caso, pero el de la varianza no exactamente, pues las muestras bootstrap no son independientes (están correlacionadas a través de la muestra de entrenamiento de donde se obtuvieron),a pesar de que las muestras bootstrap se extraen de manera independiente de <span class="math inline">\({\mathcal L}\)</span>. De esta forma, no esperamos una reducción de varianza tan grande como en el caso de muestras independientes.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bagging
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sea <span class="math inline">\({\mathcal L} =\{(x^{(i)}, y^{(i)})\}_{i=1}^n\)</span> una muestra de entrenamiento, y sean <span class="math display">\[{\mathcal L}_1^*, {\mathcal L}_2^*, \ldots, {\mathcal L}_B^*,\]</span> muestras bootstrap de <span class="math inline">\({\mathcal L}\)</span> (muestreamos con reemplazo los <strong>pares</strong> <span class="math inline">\((x^{(i)}, y^{(i)})\)</span>, para obtener una muestra de tamaño <span class="math inline">\(n\)</span>).</p>
<ol type="1">
<li>Para cada muestra bootstrap construimos un árbol <span class="math display">\[{\mathcal L}_b^* \to T_b^*\]</span>.</li>
<li>(Regresión) Promediamos árboles para reducir varianza <span class="math display">\[T^*(x) = \frac{1}{B}\sum_{i=b}^B  T_b^*(x)\]</span></li>
<li>(Clasificación) Tomamos votos sobre todos los árboles: <span class="math display">\[T^*(x) = argmax_g \{ \# \{i|T_b^*(x)=g\}\}.\]</span> Podemos también calcular probabilidades promedio sobre todos los árboles.</li>
</ol>
<p>Bagging muchas veces reduce el error de predicción gracias a una reducción modesta de varianza.</p>
</div>
</div>
<p><strong>Nota</strong>: No hay garantía de bagging reduzca el error de entrenamiento, especialmente si los árboles base son muy malos clasificadores ¿Puedes pensar en un ejemplo donde empeora?</p>
<section id="ejemplo-5" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1" class="anchored" data-anchor-id="ejemplo-5"><span class="header-section-number">12.2.1</span> Ejemplo</h3>
<p>Probemos con el ejemplo de spam. Construimos árboles con muestras bootstrap de los datos originales de entrenamiento:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>muestra_bootstrap <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">|&gt;</span> <span class="fu">sample_n</span>(<span class="fu">nrow</span>(df), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>modelo_spam <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(<span class="at">cost_complexity =</span> <span class="dv">0</span>, <span class="at">min_n =</span> <span class="dv">5</span>) <span class="sc">|&gt;</span> </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_args</span>(<span class="at">model =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># crear 30 árboles con muestras bootstrap</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>arboles_bagged <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="cf">function</span>(i){</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  muestra <span class="ot">&lt;-</span> <span class="fu">muestra_bootstrap</span>(spam_entrena)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  arbol <span class="ot">&lt;-</span> modelo_spam <span class="sc">|&gt;</span> <span class="fu">fit</span>(spam <span class="sc">~</span> ., <span class="at">data =</span> muestra)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  arbol<span class="sc">$</span>fit</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Examinemos la parte de arriba de algunos de estos árboles:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(<span class="fu">prune</span>(arboles_bagged[[<span class="dv">1</span>]], <span class="at">cp =</span><span class="fl">0.01</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(<span class="fu">prune</span>(arboles_bagged[[<span class="dv">2</span>]], <span class="at">cp =</span><span class="fl">0.01</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-27-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(<span class="fu">prune</span>(arboles_bagged[[<span class="dv">3</span>]], <span class="at">cp =</span><span class="fl">0.01</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-27-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Ahora probemos hacer predicciones con los 30 árboles. Haremos el bagging manualmente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>preds_clase_1 <span class="ot">&lt;-</span> <span class="fu">map</span>(arboles_bagged, <span class="cf">function</span>(arbol){</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(arbol, spam_prueba, <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> preds_clase_1 <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>(<span class="at">.name_repair =</span> <span class="st">"unique"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>())</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(preds)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1534   31</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>prob_bagging <span class="ot">&lt;-</span> preds <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>id, <span class="at">names_to =</span> <span class="st">"arbol"</span>, <span class="at">values_to =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">prob =</span> <span class="fu">mean</span>(prob)) <span class="sc">|&gt;</span> </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(spam_prueba <span class="sc">|&gt;</span> <span class="fu">select</span>(spam))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_auc</span>(prob_bagging, <span class="at">truth =</span> spam, prob, <span class="at">event_level =</span> <span class="st">"second"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 roc_auc binary         0.975</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(prob_bagging<span class="sc">$</span>prob <span class="sc">&gt;</span> <span class="fl">0.5</span>, prob_bagging<span class="sc">$</span>spam) <span class="sc">|&gt;</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prop.table</span>(<span class="dv">2</span>) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       
        no_spam spam
  FALSE    0.96 0.10
  TRUE     0.04 0.90</code></pre>
</div>
</div>
<p>Y vemos que tenemos una mejora inmediata con respecto un sólo árbol grande (tanto un árbol grande como uno podado con costo-complejidad). El único costo es el cómputo adicional para procesar las muestras bootstrap.</p>
<p>Podemos hacerlo automáticamente de las siguiente forma:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(baguette)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>arboles_bag <span class="ot">&lt;-</span> <span class="fu">bag_tree</span>(<span class="at">cost_complexity =</span> <span class="dv">0</span>, <span class="at">min_n =</span> <span class="dv">5</span>) <span class="sc">|&gt;</span> </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>, <span class="at">times =</span> <span class="dv">30</span>) <span class="sc">|&gt;</span> </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(spam <span class="sc">~</span> ., spam_entrena)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(arboles_bag, spam_prueba) <span class="sc">|&gt;</span> </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(arboles_bag, spam_prueba, <span class="at">type =</span> <span class="st">"prob"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(spam_prueba <span class="sc">|&gt;</span> <span class="fu">select</span>(spam)) <span class="sc">|&gt;</span> </span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">metricas_spam</span>(spam, .pred_no_spam, <span class="at">estimate =</span> .pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(is_double, round, <span class="dv">2</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary          0.94
2 sens     binary          0.96
3 spec     binary          0.9 
4 roc_auc  binary          0.98</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>¿Cuántas muestras bootstrap? Bagging generalmente funciona mejor cuando tomamos tantas muestras como sea posible - aunque también es un parámetro que se puede afinar.</li>
<li>Bagging por sí solo se usa rara vez. El método más poderoso es bosques aleatorios, donde el proceso básico es bagging de árboles, pero añadimos ruido adicional en la construcción de árboles.</li>
</ul>
</div>
</div>
</section>
<section id="mejorando-bagging" class="level3" data-number="12.2.2">
<h3 data-number="12.2.2" class="anchored" data-anchor-id="mejorando-bagging"><span class="header-section-number">12.2.2</span> Mejorando bagging</h3>
<p>El factor que limita la mejora de desempeño de bagging es que los árboles están correlacionados a través de la muestra de entrenamiento. Como vimos, si los árboles fueran independientes, entonces mejoramos por un factor de <span class="math inline">\(B\)</span> (número de muestras independientes). Veamos un argumento para entender cómo esa correlación limita las mejoras:</p>
<p>Quiséramos calcular (para una <span class="math inline">\(x\)</span> fija)</p>
<p><span class="math display">\[Var(T(x)) = Var\left(\frac{1}{B}\sum_{i=1}^B T^*_i\right)\]</span></p>
<p>donde cada <span class="math inline">\(T^*_i\)</span> se construye a partir de una muestra bootstrap de <span class="math inline">\({\mathcal L}\)</span>. Nótese que esta varianza es sobre la muestra de entrenamiento <span class="math inline">\({\mathcal L}\)</span>. Usando la fórmula de la varianza para sumas generales:</p>
<p><span id="eq-varianza-ensamble"><span class="math display">\[
Var(T(x)) = Var\left(\frac{1}{B}\sum_{i=1}^B T^*_i\right) =
\sum_{i=1}^B \frac{1}{B^2} Var(T^*_i(x)) + \frac{2}{B^2}\sum_{i &lt; j} Cov(T_i^* (x), T_j^* (x))
\tag{12.1}\]</span></span> Ponemos ahora</p>
<p><span class="math display">\[\sigma^2(x) = Var(T_i^* (x))\]</span> que son todas iguales porque los árboles bootstrap se extraen de la misma manera (<span class="math inline">\({\mathcal L}\to {\mathcal L}^*\to T^*\)</span>).</p>
<p>Escribimos ahora <span class="math display">\[\rho(x) = corr(T_i^* (x), T_j^* (x))\]</span> que es una correlación sobre <span class="math inline">\({\mathcal L}\)</span> (asegúrate que entiendes este término). Todas estas correlaciones son iguales pues cada par de árboles se construye de la misma forma.</p>
<p>Así que la fórmula (<a href="#eq-varianza-ensamble">Ecuación&nbsp;<span>12.1</span></a>) queda</p>
<span class="math display">\[\begin{equation}
Var(T(x)) =
\frac{1}{B} \sigma^2(x) + \frac{B-1}{B} \rho(x)\sigma^2(x) =
\sigma^2(x)\left(\frac{1}{B}  + \left(1-\frac{1}{B}\right )\rho(x)     \right)
\end{equation}\]</span>
<p>En el límite (cuando B es muy grande, es decir, promediamos muchos árboles):</p>
<span class="math display">\[\begin{equation}
Var(T(x)) = Var\left(\frac{1}{B}\sum_{i=1}^B T^*_i\right) \approx
\sigma^2(x)\rho(x)     
\end{equation}\]</span>
<p>Si <span class="math inline">\(\rho(x)=0\)</span> (árboles no correlacionados), la varianza del ensemble es la fracción <span class="math inline">\(1/B\)</span> de la varianza de un solo árbol, y obtenemos una mejora considerable en varianza. En el otro extremo, si la correlación es alta <span class="math inline">\(\rho(x)\approx 1\)</span>, entonces no obtenemos ganancias por promediar árboles y la varianza del ensamble es similar a la de un solo árbol.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Cuando hacemos bagging de árboles, la limitación de mejora cuando promediamos muchos árboles está dada por la correlación entre ellos: cuanto más grande es la correlación, menor beneficio en reducción de varianza obtenemos.</li>
<li>Si alteramos el proceso para producir árboles menos correlacionados (menor <span class="math inline">\(\rho(x)\)</span>), podemos mejorar el desempeño de bagging. Sin embargo, estas alteraciones generalmente están acompañadas de incrementos en la varianza (<span class="math inline">\(\sigma^x(x)\)</span>).</li>
</ul>
</div>
</div>
</section>
</section>
<section id="bosques-aleatorios" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="bosques-aleatorios"><span class="header-section-number">12.3</span> Bosques aleatorios</h2>
<p>Los bosques aleatorios son una versión de árboles de bagging decorrelacionados. Esto se logra <em>introduciendo variabilidad en la construcción de los árboles</em> (esto es paradójico - pero la explicación está arriba: aunque la varianza empeora (de cada árbol), la decorrelación de árboles puede valer la pena).</p>
<section id="sabiduría-de-las-masas" class="level3" data-number="12.3.1">
<h3 data-number="12.3.1" class="anchored" data-anchor-id="sabiduría-de-las-masas"><span class="header-section-number">12.3.1</span> Sabiduría de las masas</h3>
<p>Una explicación simple de este proceso que se cita frecuentemente es el fenómeno de la sabiduría de las masas: cuando promediamos estimaciones pobres de un gran número de personas (digamos ignorantes), obtenemos mejores estimaciones que cualquiera de las componentes individuales, o incluso mejores que estimaciones de expertos. Supongamos por ejemplo que <span class="math inline">\(G_1,G_2,\ldots, G_M\)</span> son clasificadores débiles, por ejemplo <span class="math display">\[P(correcto) = P(G_i=G)=0.6\]</span> para un problema con probabilidad base <span class="math inline">\(P(G=1)=0.5\)</span>. Supongamos que los predictores son independientes, y sea <span class="math inline">\(G^*\)</span> el clasificador que se construye por mayoría de votos a partir de <span class="math inline">\(G_1,G_2,\ldots, G_M\)</span>, es decir <span class="math inline">\(G^*=1\)</span> si y sólo si <span class="math inline">\(\#\{ G_i = 1\} &gt; M/2\)</span>.</p>
<p>Podemos ver que el número de aciertos (X) de <span class="math inline">\(G_1,G_2,\ldots, G_M\)</span>, por independencia, es binomial <span class="math inline">\(Bin(M, 0.6)\)</span>. Si <span class="math inline">\(M\)</span> es grande, podemos aproximar esta distribución con una normal con media <span class="math inline">\(M*0.6\)</span> y varianza <span class="math inline">\(0.6*0.4*M\)</span>. Esto implica que</p>
<p><span class="math display">\[P(G^* correcto)=P(X &gt; 0.5M) \approx
P\left( Z &gt; \frac{0.5M-0.6M}{\sqrt(0.24M)}\right) = P\left(Z &gt; -2.041 \sqrt{M}\right)\]</span></p>
<p>Y ahora observamos que cuando <span class="math inline">\(M\)</span> es grande, la cantidad de la derecha tiende a 1: la masa, en promedio, tiene la razón!</p>
<p>Nótese, sin embargo, que baja dependencia entre las “opiniones” es parte crucial del argumento, es decir, las opiniones deben estar decorrelacionadas.</p>
<hr>
<p>El proceso de decorrelación de bosques aleatorios consiste en que cada vez que tengamos que hacer un corte en un árbol de bagging, escoger al azar un número de variables y usar estas para buscar la mejor variable y el mejor punto de corte, como hicimos en la construcción de árboles.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bosques aleatorios
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sea <span class="math inline">\(m\)</span> fija. Sea <span class="math inline">\({\mathcal L} =\{(x^{(i)}, y^{(i)})\}_{i=1}^n\)</span> una muestra de entrenamiento, y sean <span class="math display">\[{\mathcal L}_1^*, {\mathcal L}_2^*, \ldots, {\mathcal L}_B^*,\]</span> muestras bootstrap de <span class="math inline">\({\mathcal L}\)</span> (muestreamos con reemplazo los <strong>pares</strong> <span class="math inline">\((x^{(i)}, y^{(i)})\)</span>, para obtener una muestra de tamaño <span class="math inline">\(n\)</span>).</p>
<ol type="1">
<li>Para cada muestra bootstrap construimos un árbol <span class="math display">\[{\mathcal L}_b^* \to T_b^*\]</span> de la siguiente forma:</li>
</ol>
<ul>
<li>En cada nodo candidato a particionar, escogemos al azar <span class="math inline">\(m\)</span> variables de las disponibles</li>
<li>Buscamos la mejor variable y punto de corte (como en un árbol normal) pero <em>solo entre las variables que seleccionamos al azar</em>.</li>
<li>Seguimos hasta construir un árbol grande.</li>
</ul>
<ol start="2" type="1">
<li>(Regresión) Promediamos árboles para reducir varianza <span class="math display">\[T^*(x) = \frac{1}{B}\sum_{i=b}^B  T_b^*(x)\]</span></li>
<li>(Clasificación) Tomamos votos sobre todos los árboles: <span class="math display">\[T^*(x) = argmax_g \{ \# \{i|T_b^*(x)=g\}\}.\]</span> Podemos también calcular probabilidades promediando sobre todos los árboles las proporciones de clase de cada árbol.</li>
</ol>
<p>Bosques aleatorios muchas veces reduce el error de predicción gracias a una reducción a veces considerable de varianza. El objetivo final es reducir la varianza alta que producen árboles normales debido a la forma tan agresiva de construir sus cortes.</p>
</div>
</div>
<p><strong>Observaciones</strong>:</p>
<ol type="1">
<li>El número de variables <span class="math inline">\(m\)</span> que se seleccionan en cada nodo es un parámetro que hay que escoger (usando validación, validación cruzada).</li>
<li>Ojo: no se selecciona un conjunto de <span class="math inline">\(m\)</span> variables para cada árbol. En la construcción de cada árbol, en cada nodo se seleccionan <span class="math inline">\(m\)</span> variables como candidatas para cortes.</li>
<li>Como inducimos aleatoriedad en la construcción de árboles, este proceso reduce la correlación entre árboles del bosque, aunque también incrementa su varianza. Los bosques aleatorios funcionan bien cuando la mejora en correlación es más grande que la pérdida en varianza.</li>
<li>Reducir <span class="math inline">\(m\)</span>, a grandes rasgos:</li>
</ol>
<ul>
<li>Aumenta el sesgo del bosque (pues es más restringido el proceso de construcción)</li>
<li>Disminuye la correlación entre árboles y aumenta la varianza de cada árbol</li>
</ul>
<ol start="5" type="1">
<li>Incrementar <span class="math inline">\(m\)</span></li>
</ol>
<ul>
<li>Disminuye el sesgo del bosque (menos restricción)</li>
<li>Aumenta la correlacción entre árobles y disminuye la varianza de cada árbol</li>
</ul>
<ol start="6" type="1">
<li>Cuando usamos bosques aleatorios para estimar probabilidades de clase, como siempre, es necesario checar la calibración de esas probabilidades (ver sección de regresión logística).</li>
</ol>
</section>
<section id="ejemplo-6" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-6">Ejemplo</h3>
<p>Regresamos a nuestro ejemplo de spam. Intentemos con 500 árboles, y 6 variables (de 58 variables) para escoger como candidatos en cada corte:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>spam_bosque <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="dv">6</span>, <span class="at">trees =</span> <span class="dv">1000</span>) <span class="sc">|&gt;</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"permutation"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># flujo</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>spam_flujo_2 <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(spam_receta) <span class="sc">|&gt;</span> </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(spam_bosque) </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>flujo_ajustado <span class="ot">&lt;-</span> <span class="fu">fit</span>(spam_flujo_2, spam_entrena)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>bosque <span class="ot">&lt;-</span> <span class="fu">extract_fit_parsnip</span>(flujo_ajustado)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Evaluamos desempeño, donde vemos que obtenemos una mejora inmediata con respecto a bagging:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(flujo_ajustado , spam_prueba, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(flujo_ajustado, spam_prueba)) <span class="sc">|&gt;</span> </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(spam_prueba <span class="sc">|&gt;</span> <span class="fu">select</span>(spam)) <span class="sc">|&gt;</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">metricas_spam</span>(spam, .pred_no_spam, <span class="at">estimate =</span> .pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(is_double, round, <span class="dv">2</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary          0.94
2 sens     binary          0.97
3 spec     binary          0.91
4 roc_auc  binary          0.98</code></pre>
</div>
</div>
<p>Comparemos las curvas ROC para:</p>
<ul>
<li>árbol grande sin podar</li>
<li>árbol podado con costo-complejidad</li>
<li>bagging de árboles</li>
<li>bosque aleatorio</li>
</ul>
<p>Las curvas de precision-recall:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>modelos <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">arbol_grande =</span> arbol_grande, </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">podado =</span> arbol_podado_vc, </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">bagging =</span> arboles_bag, </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">bosque =</span> bosque)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>prec_tbl <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">names</span>(modelos), <span class="cf">function</span>(mod_nombre){</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(modelos[[mod_nombre]], spam_prueba, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(spam_prueba <span class="sc">|&gt;</span> <span class="fu">select</span>(spam)) <span class="sc">|&gt;</span> </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pr_curve</span>(spam, .pred_no_spam) <span class="sc">|&gt;</span> </span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">modelo =</span> mod_nombre)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">|&gt;</span> </span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(prec_tbl, </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> recall, <span class="at">y =</span> precision, <span class="at">colour =</span> modelo)) <span class="sc">+</span> </span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_path</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">1</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>O las curvas ROC</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>roc_tbl <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">names</span>(modelos), <span class="cf">function</span>(mod_nombre){</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(modelos[[mod_nombre]], spam_prueba, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(spam_prueba <span class="sc">|&gt;</span> <span class="fu">select</span>(spam)) <span class="sc">|&gt;</span> </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">roc_curve</span>(spam, .pred_no_spam) <span class="sc">|&gt;</span> </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">modelo =</span> mod_nombre)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">|&gt;</span> </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(roc_tbl, </span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span> <span class="sc">-</span> specificity, <span class="at">y =</span> sensitivity, <span class="at">colour =</span> modelo)) <span class="sc">+</span> </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span> <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fu">geom_path</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="más-detalles-de-bosques-aleatorios" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="más-detalles-de-bosques-aleatorios">Más detalles de bosques aleatorios</h3>
<p>Los bosques aleatorios, por su proceso de construcción, tienen aspectos interesantes.</p>
<p>En primer lugar, tenemos la estimación de error de prueba <strong>Out-of-Bag</strong> (OOB), que es una estimación <em>honesta</em> del error de predicción basada en el proceso de bagging. Es similar a la estimación de <strong>validación cruzada</strong> (leave-one-out), pero aprovechamos el proceso para hacer un cálculo más simple y rápido.</p>
<p>Obsérvese en primer lugar, que cuando tomamos muestras con reemplazo para construir cada árbol, algunos casos de entrenamiento aparecen más de una vez, y otros casos no se usan en la construcción del árbol. La idea es entonces es usar esos casos excluidos para hacer una estimación honesta del error.</p>
<section id="ejemplo-7" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-7">Ejemplo</h4>
<p>Si tenemos una muestra de entrenamiento</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>entrena <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>entrena</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
       x      y
   &lt;int&gt;  &lt;dbl&gt;
 1     1 -6.92 
 2     2  0.742
 3     3 -2.23 
 4     4 -1.78 
 5     5  4.89 
 6     6  3.20 
 7     7  3.03 
 8     8 12.1  
 9     9  8.05 
10    10  5.25 </code></pre>
</div>
</div>
<p>Tomamos una muestra bootstrap:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>entrena_boot <span class="ot">&lt;-</span> <span class="fu">sample_n</span>(entrena, <span class="dv">10</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>entrena_boot</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
       x      y
   &lt;int&gt;  &lt;dbl&gt;
 1     7  3.03 
 2     5  4.89 
 3     6  3.20 
 4     2  0.742
 5     3 -2.23 
 6     4 -1.78 
 7    10  5.25 
 8     2  0.742
 9    10  5.25 
10     5  4.89 </code></pre>
</div>
</div>
<p>Construimos un predictor</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>mod_boot <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>x, <span class="at">data =</span> entrena_boot)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>y ahora obtenemos los datos que no se usaron:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>prueba_boot <span class="ot">&lt;-</span> <span class="fu">anti_join</span>(entrena, entrena_boot)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(x, y)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>prueba_boot</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
      x     y
  &lt;int&gt; &lt;dbl&gt;
1     1 -6.92
2     8 12.1 
3     9  8.05</code></pre>
</div>
</div>
<p>y usamos estos tres casos para estimar el error de predicción:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">abs</span>(<span class="fu">predict</span>(mod_boot, prueba_boot)<span class="sc">-</span>prueba_boot<span class="sc">$</span>y))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.722493</code></pre>
</div>
</div>
<p>Esta es la estimación OOB (out-of-bag) para este modelo particular.</p>
<hr>
<p>En un principio podemos pensar que quizá por mala suerte obtenemos pocos elementos OOB para evaluar el error, pero en realidad para muestras no tan chicas obtenemos una fracción considerable.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cuando el tamaño de muestra <span class="math inline">\(n\)</span> es grande, el porcentaje esperado de casos que no están en la muestra bootstrap es alrededor del 37%</p>
</div>
</div>
<p>Demuestra usando probabilidad y teoría de muestras con reemplazo.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Estimación OOB del error
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consideramos un bosque aleatorio <span class="math inline">\(T_{ba}\)</span>con árboles <span class="math inline">\(T_1^*, T_2^*, \ldots, T_B^*\)</span>, y conjunto de entrenamiento original <span class="math inline">\({\mathcal L} =\{(x^{(i)}, y^{(i)}\}_{i=1}^n\)</span>. Para cada caso de entrenamiento <span class="math inline">\((x^{(i)}, y^{(i)})\)</span> consideramos todos los árboles que <strong>no</strong> usaron este caso para construirse, y construimos un bosque <span class="math inline">\(T_{ba}^{(i)}\)</span> basado solamente en esos árboles. La predicción OOB de <span class="math inline">\(T_{ba}^{(i)}\)</span> para <span class="math inline">\((x^{(i)}, y^{(i)})\)</span> es <span class="math display">\[y_{oob}^{(i)} = T_{ba}^{(i)}(x^{(i)})\]</span> El error OOB del árbol <span class="math inline">\(T_{ba}\)</span> está dado por 1. Regresión (error cuadrático medio) <span class="math display">\[\hat{Err}_{oob} = \frac{1}{n} \sum_{i=1}^n (y^{(i)} - y_{oob}^{(i)})^2\]</span> 2. Clasificación (error de clasificación) <span class="math display">\[\hat{Err}_{oob} = \frac{1}{n}\sum_{i=1}^n I(y^{(i)} = y_{oob}^{(i)})\]</span></p>
<p>La estimación OOB del error es conceptualmente similar a la de validación cruzada.</p>
</div>
</div>
<p><strong>Observaciones</strong></p>
<ul>
<li>Para cada dato de entrenamiento, hacemos predicciones usando solamente los árboles que no consideraron ese dato en su construcción. Estas predicciones son las que evaluamos</li>
<li>Es una especie de validación cruzada (se puede demostrar que es similar a validacion cruzada leave-one-out), pero es barata en términos computacionales.</li>
<li>Como discutimos en validación cruzada, esto hace de OOB una buena medida de error para afinar los parámetros del modelo (principalmente el número <span class="math inline">\(m\)</span> de variables que se escogen en cada corte).</li>
</ul>
</section>
<section id="ejempo" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejempo">Ejempo</h4>
<p>Para el ejemplo de spam, podemos ver el error OOB:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>bosque</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parsnip model object

Ranger result

Call:
 ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~6,      x), num.trees = ~1000, importance = ~"permutation", num.threads = 1,      verbose = FALSE, seed = sample.int(10^5, 1), probability = TRUE) 

Type:                             Probability estimation 
Number of trees:                  1000 
Sample size:                      3067 
Number of independent variables:  58 
Mtry:                             6 
Target node size:                 10 
Variable importance mode:         permutation 
Splitrule:                        gini 
OOB prediction error (Brier s.):  0.04416379 </code></pre>
</div>
</div>
<p>Que comparamos con el score de brier y devianza de prueba:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>score_brier <span class="ot">&lt;-</span> <span class="cf">function</span>(y, p){</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((y <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>prob_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(bosque, spam_prueba, <span class="at">type =</span> <span class="st">"prob"</span>)[[<span class="st">".pred_spam"</span>]]</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">score_brier</span>(spam_prueba<span class="sc">$</span>spam <span class="sc">==</span> <span class="st">"spam"</span>, prob_pred)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04623398</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mn_log_loss_vec</span>(<span class="fu">factor</span>(spam_prueba<span class="sc">$</span>spam, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"spam"</span>, <span class="st">"no_spam"</span>)), prob_pred)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1755563</code></pre>
</div>
</div>
<p>Para calcular otras medidas OOB, podemos extraer directamente las predicciones OOB:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>preds_oob <span class="ot">&lt;-</span> bosque<span class="sc">$</span>fit<span class="sc">$</span>predictions</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(preds_oob)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        no_spam      spam
[1,] 0.62822837 0.3717716
[2,] 0.02521640 0.9747836
[3,] 0.60245576 0.3975442
[4,] 0.07318850 0.9268115
[5,] 0.02236467 0.9776353
[6,] 0.65321262 0.3467874</code></pre>
</div>
</div>
<p>La estimación OOB del error de clasificación cortando en 0.5 es entonces:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>tab_confusion_oob <span class="ot">&lt;-</span> <span class="fu">table</span>(preds_oob[, <span class="dv">2</span>] <span class="sc">&gt;</span> <span class="fl">0.5</span>, spam_entrena<span class="sc">$</span>spam)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(tab_confusion_oob))<span class="sc">/</span><span class="fu">sum</span>(tab_confusion_oob)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.05119009</code></pre>
</div>
</div>
<p>Que comparamos con el error de prueba:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">table</span>(prob_pred<span class="sc">&gt;</span> <span class="fl">0.5</span>, spam_prueba<span class="sc">$</span>spam) <span class="sc">|&gt;</span> <span class="fu">prop.table</span>() <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">3</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">-</span><span class="fu">sum</span>(<span class="fu">diag</span>(tab))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.055</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="calibración-de-probabilidades" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="calibración-de-probabilidades"><span class="header-section-number">12.4</span> Calibración de probabilidades</h2>
<p>Finalmente, podemos checar la calibración de nuestro bosque:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>calibracion_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">obs =</span> spam_prueba<span class="sc">$</span>spam,</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">proba =</span> prob_pred) <span class="sc">|&gt;</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">ifelse</span>(obs <span class="sc">==</span> <span class="st">"spam"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>calibracion_gpos <span class="ot">&lt;-</span> calibracion_tbl <span class="sc">|&gt;</span> </span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">proba_grupo =</span> <span class="fu">cut</span>(proba, </span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">quantile</span>(proba, <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)), <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(proba_grupo) <span class="sc">|&gt;</span> </span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">prob_media =</span> <span class="fu">mean</span>(proba), </span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">obs =</span> <span class="fu">sum</span>(y), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">obs_prop =</span> (obs <span class="sc">+</span> <span class="dv">2</span>) <span class="sc">/</span> (n <span class="sc">+</span> <span class="dv">4</span>), </span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">inferior =</span> <span class="fu">qbeta</span>(<span class="fl">0.05</span>, obs <span class="sc">+</span> <span class="dv">2</span>,  n <span class="sc">-</span> obs <span class="sc">+</span> <span class="dv">4</span>),</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">superior =</span> <span class="fu">qbeta</span>(<span class="fl">0.95</span>, obs <span class="sc">+</span> <span class="dv">2</span>,  n <span class="sc">-</span> obs <span class="sc">+</span> <span class="dv">4</span>))</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>calibracion_gpos</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 7
   proba_grupo     prob_media     n   obs obs_prop inferior superior
   &lt;fct&gt;                &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 [0,0.0105]         0.00405   154     1   0.0190  0.00516   0.0391
 2 (0.0105,0.0277]    0.0191    153     0   0.0127  0.00225   0.0297
 3 (0.0277,0.0567]    0.0410    153     1   0.0191  0.00519   0.0393
 4 (0.0567,0.1]       0.0743    154     3   0.0316  0.0125    0.0566
 5 (0.1,0.167]        0.129     153     6   0.0510  0.0254    0.0816
 6 (0.167,0.399]      0.259     153    26   0.178   0.129     0.228 
 7 (0.399,0.794]      0.610     154   119   0.766   0.699     0.810 
 8 (0.794,0.933]      0.879     153   148   0.955   0.910     0.970 
 9 (0.933,0.981]      0.960     154   150   0.962   0.919     0.975 
10 (0.981,1]          0.992     153   153   0.987   0.952     0.991 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibracion_gpos, <span class="fu">aes</span>(<span class="at">x =</span> prob_media, <span class="at">y =</span> obs_prop, <span class="at">ymin =</span> inferior, <span class="at">ymax =</span> superior)) <span class="sc">+</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>() <span class="sc">+</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"red"</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>y vemos que nuestro modelo no tiene una calibración no muy buena: las probabilidades obtenidas del bosque están algo encogidas hacia el centro: son algo “subconfiadas”.</p>
<ul>
<li>Podemos intentar un bosque con distintos parámetros: específicamente número mínimo de casos por nodo terminal, y distinto número de <em>mtry</em>.</li>
<li>Podemos calibrar las probabilidades de este modelo usando regresión isotónica o regresión logística con splines no decrecientes.</li>
</ul>
<p>Vamos a ver la segunda técnica. En primer lugar, tendremos que separar nuestra de muestra de prueba en dos partes: una de calibración, y otra de evaluación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12441</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>indice_calib <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(prob_pred), <span class="fu">length</span>(prob_pred)<span class="sc">*</span><span class="fl">0.5</span>)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>prop_bosque_calib <span class="ot">&lt;-</span> prob_pred[indice_calib]</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>prop_bosque_eval <span class="ot">&lt;-</span> prob_pred[<span class="sc">-</span>indice_calib]</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>y_calib <span class="ot">&lt;-</span> spam_prueba<span class="sc">$</span>spam[indice_calib]</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>y_eval <span class="ot">&lt;-</span> spam_prueba<span class="sc">$</span>spam[<span class="sc">-</span>indice_calib]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ahora construimos una base de splines no decrecientes usando la muestra de calibración:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines2)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span><span class="sc">-</span> p))</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co"># base de splines no decrecientes, en logit:</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>mediana <span class="ot">&lt;-</span> <span class="fu">median</span>(prop_bosque_calib)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>base_splines <span class="ot">&lt;-</span> <span class="fu">iSpline</span>(prop_bosque_calib, <span class="at">knots =</span> mediana,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Boundary.knots =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">degree =</span> <span class="dv">3</span>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="fu">matplot</span>(prop_bosque_calib, base_splines, <span class="at">cex =</span> <span class="fl">0.2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>Y hacemos una regresión de <span class="math inline">\(y\)</span> en función de la base de splines (que son derivados de <em>prop_bosque</em>). La función que transforma las probabilidades es:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>dat_calib <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(base_splines) <span class="sc">|&gt;</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_calib =</span> <span class="fu">ifelse</span>(y_calib <span class="sc">==</span> <span class="st">"spam"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="co"># con regresión logística obtendremos probabilidades:</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>modelo_calib <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_calib <span class="sc">~</span> <span class="sc">+</span>., dat_calib, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>prob_calib <span class="ot">&lt;-</span> <span class="fu">fitted</span>(modelo_calib)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="fu">qplot</span>(prop_bosque_calib, prob_calib)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `qplot()` was deprecated in ggplot2 3.4.0.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>Ahora evaluamos la calibración:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>base_splines_eval <span class="ot">&lt;-</span> <span class="fu">iSpline</span>(prop_bosque_eval, <span class="at">knots =</span> mediana, </span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Boundary.knots =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">degree =</span> <span class="dv">3</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co"># obtener probabilidades calibradas para evaluacion</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>probs_calibradas <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_calib, <span class="fu">as_tibble</span>(base_splines_eval), </span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>calib_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">proba =</span> probs_calibradas, </span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y =</span> <span class="fu">ifelse</span>(y_eval<span class="sc">==</span> <span class="st">"spam"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>calibracion_gpos <span class="ot">&lt;-</span> calib_tbl <span class="sc">|&gt;</span> </span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">proba_grupo =</span> <span class="fu">cut</span>(proba, </span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">quantile</span>(proba, <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)), <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(proba_grupo) <span class="sc">|&gt;</span> </span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">prob_media =</span> <span class="fu">mean</span>(proba), </span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">obs =</span> <span class="fu">sum</span>(y), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">obs_prop =</span> (obs <span class="sc">+</span> <span class="dv">2</span>) <span class="sc">/</span> (n <span class="sc">+</span> <span class="dv">4</span>), </span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">inferior =</span> <span class="fu">qbeta</span>(<span class="fl">0.05</span>, obs <span class="sc">+</span> <span class="dv">2</span>,  n <span class="sc">-</span> obs <span class="sc">+</span> <span class="dv">4</span>),</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">superior =</span> <span class="fu">qbeta</span>(<span class="fl">0.95</span>, obs <span class="sc">+</span> <span class="dv">2</span>,  n <span class="sc">-</span> obs <span class="sc">+</span> <span class="dv">4</span>))</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>calibracion_gpos</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 7
   proba_grupo       prob_media     n   obs obs_prop inferior superior
   &lt;fct&gt;                  &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 [0.00464,0.00529]    0.00485    77     0   0.0247  0.00435   0.0565
 2 (0.00529,0.00666]    0.00587    77     0   0.0247  0.00435   0.0565
 3 (0.00666,0.0103]     0.00813    76     1   0.0375  0.0102    0.0757
 4 (0.0103,0.0222]      0.0145     77     1   0.0370  0.0100    0.0748
 5 (0.0222,0.0661]      0.0395     77     1   0.0370  0.0100    0.0748
 6 (0.0661,0.399]       0.195      76     9   0.138   0.0781    0.200 
 7 (0.399,0.915]        0.691      77    55   0.704   0.601     0.767 
 8 (0.915,0.987]        0.964      76    73   0.938   0.859     0.959 
 9 (0.987,0.993]        0.991      77    75   0.951   0.876     0.968 
10 (0.993,0.995]        0.994      77    77   0.975   0.908     0.983 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibracion_gpos, <span class="fu">aes</span>(<span class="at">x =</span> prob_media, <span class="at">y =</span> obs_prop, <span class="at">ymin =</span> inferior, <span class="at">ymax =</span> superior)) <span class="sc">+</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>() <span class="sc">+</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"red"</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>El score de Brier y la log pérdida con las probabilidades calibradas es:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">score_brier</span>(y_eval <span class="sc">==</span> <span class="st">"spam"</span>, probs_calibradas)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03848623</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mn_log_loss_vec</span>(y_eval, <span class="at">estimate =</span> <span class="dv">1</span> <span class="sc">-</span> probs_calibradas)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1424386</code></pre>
</div>
</div>
<p><strong>Observaciones</strong>:</p>
<ol type="1">
<li>Una desventaja de esta técnica es que tenemos que separar conjuntos de calibración y evaluación.</li>
<li>Para el caso multiclase, se puede probar el siguiente procedimiento: calibrar cada una de las clases, y después normalizar las probabilidades obtenidas. Este procedimiento se puede iterar.</li>
</ol>
</section>
<section id="intervalos-y-su-calibración-para-bosques" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="intervalos-y-su-calibración-para-bosques"><span class="header-section-number">12.5</span> Intervalos y su calibración para bosques</h2>
<p>Construir intervalos de predicción es considerablemente más complicado que construir predicciones puntuales. Cuando esto es necesario, podemos hacer regresión cuantílica usando bosques.</p>
<ol type="1">
<li>En árboles de regresión usuales, cuando queremos hacer predicciones para <span class="math inline">\(x\)</span>, aplicamos cada árbol a <span class="math inline">\(x\)</span>, obtenemos los datos del nodo terminal donde cae, y calculamos el promedio de esas observaciones.. Esta es una estimación del valor esperado de la respuesta condicional a las covariables.</li>
<li>En árboles de regresión cuantílica, repetimos el mismo proceso, pero en lugar de calcular la media, calculamos el cuantil deseado.</li>
</ol>
<p>Como en <strong>cualquier método</strong>, es <strong>necesario verificar que los intervalos producidos por estos métodos tienen cobertura apropiada</strong>.</p>
<section id="ejemplo-8" class="level4" data-number="12.5.0.1">
<h4 data-number="12.5.0.1" class="anchored" data-anchor-id="ejemplo-8"><span class="header-section-number">12.5.0.1</span> Ejemplo:</h4>
<p>Consideramos el problema de predicción de precio normal de venta de casas. Los hiperparámetros del modelo pueden ser escogidos previamente mediante validación cruzada o una muestra de validación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co">#|include: false</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"rfinterval"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Installing package into '/usr/local/lib/R/site-library'
(as 'lib' is unspecified)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rfinterval)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/casas_traducir_geo.R"</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">934</span>)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>casas <span class="ot">&lt;-</span> casas <span class="sc">|&gt;</span> </span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(condicion_venta <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Family"</span>, <span class="st">"Partial"</span>, <span class="st">"Abnormal"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calidad_sotano =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(calidad_sotano), <span class="st">"sin_sotano"</span>, calidad_sotano)) <span class="sc">|&gt;</span> </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calidad_garage =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(calidad_garage), <span class="st">"sin_garage"</span>, calidad_sotano)) </span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>casas_entrena <span class="ot">&lt;-</span> <span class="fu">sample_frac</span>(casas, <span class="fl">0.85</span>)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>casas_prueba <span class="ot">&lt;-</span> <span class="fu">anti_join</span>(casas, casas_entrena) </span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>intervalos_casas <span class="ot">&lt;-</span> <span class="fu">rfinterval</span>(precio_miles <span class="sc">~</span> nombre_zona <span class="sc">+</span> </span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>            calidad_gral <span class="sc">+</span> condicion_gral <span class="sc">+</span> </span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>            año_construccion <span class="sc">+</span> area_hab_m2 <span class="sc">+</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>            calidad_sotano <span class="sc">+</span> </span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>            area_sotano_m2 <span class="sc">+</span> calidad_garage, </span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">method =</span> <span class="st">"quantreg"</span>, </span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">params_ranger =</span> <span class="fu">list</span>(<span class="at">mtry =</span> <span class="dv">5</span>, <span class="at">num.trees =</span> <span class="dv">1500</span>), </span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">alpha =</span> <span class="fl">0.05</span>, </span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">train_data =</span> casas_entrena, <span class="at">test_data =</span> casas_prueba)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>intervalos <span class="ot">&lt;-</span> intervalos_casas<span class="sc">$</span>quantreg_interval</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> intervalos_casas<span class="sc">$</span>testPred</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>intervalos<span class="sc">$</span>precio_miles <span class="ot">&lt;-</span> casas_prueba<span class="sc">$</span>precio_miles</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>intervalos<span class="sc">$</span>area <span class="ot">&lt;-</span> casas_prueba<span class="sc">$</span>area_hab_m2</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>intervalos<span class="sc">$</span>pred <span class="ot">&lt;-</span> preds</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(intervalos, <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper, <span class="at">y =</span> precio_miles)) <span class="sc">+</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_linerange</span>(<span class="at">colour =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>intervalos <span class="sc">|&gt;</span> </span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">cobertura =</span> <span class="fu">mean</span>(precio_miles <span class="sc">&lt;</span> upper <span class="sc">&amp;</span> precio_miles <span class="sc">&gt;</span> lower),</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">cobertura_sup =</span> <span class="fu">mean</span>(precio_miles <span class="sc">&lt;</span> upper),</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">cobertura_inf =</span> <span class="fu">mean</span>(precio_miles <span class="sc">&gt;</span> lower)) <span class="sc">|&gt;</span> </span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.numeric, <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">3</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  cobertura cobertura_sup cobertura_inf
1     0.944          0.98         0.964</code></pre>
</div>
</div>
<p>Los intervalos tienen cobertura razonablemente cercana a la nominal.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(intervalos, <span class="fu">aes</span>(<span class="at">x =</span> area, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper, <span class="at">y =</span> precio_miles)) <span class="sc">+</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_linerange</span>(<span class="at">colour =</span> <span class="st">"gray"</span>) <span class="sc">+</span> <span class="fu">scale_x_log10</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="importancia-de-variables" class="level2" data-number="12.6">
<h2 data-number="12.6" class="anchored" data-anchor-id="importancia-de-variables"><span class="header-section-number">12.6</span> Importancia de variables</h2>
<p>Usando muestras bootstrap y error OOB, es posible tener mediciones útiles de la importancia de una variable en el modelo en un bosque aleatorio (todo esto también fue inventado por Breiman).</p>
<p>En primer lugar, definir qué significa que una variable sea <em>importante</em> en un determinado problema no es trivial. El primer punto que consideramos es que intentaremos medir la importancia desde el punto de vista de un modelo: es decir, queremos saber qué tanto “influye” cada variable en las predicciones y su calidad.</p>
<p>Algunos primeros enfoques son (sólo discutiremos los primeros dos aquí):</p>
<ul>
<li>Si quitamos una variable, construimos un nuevo modelo, y el error de predicción se degrada, la variable es importante.</li>
<li>Una variable es importante cuando las predicciones del modelo se degradan cuando quitamos información de esta variable, o introducimos ruido en esa variable.</li>
<li>Si las predicciones cambian mucho cuando una variable cambia, entonces la variable es importante.</li>
</ul>
<p>El primer enfoque no se refiere específicamente al modelo dado. Tiene el defecto de que una variable puede tener información predictiva, que el modelo utiliza, y sin embargo, si quitamos la variable y ajustamos un nuevo modelo, otras variables podrían encargarse del trabajo que estaba haciendo en nuestro modelo original: por ejemplo, con variables correlacionadas.</p>
<p>Para evaluar un modelo dado, el segundo enfoque es mejor y se puede intentar de varias maneras. Para modelos basados en árboles, por ejemplo, podríamos ver qué pasa con las predicciones, por ejemplo, cuando cada vez que vemos la variable <span class="math inline">\(x\)</span> en un nodo escogemos una de las ramas al azar, en lugar de utilizar el valor real de <span class="math inline">\(x\)</span>.</p>
<p>Una manera de implementar esto es el siguiente:</p>
<ol type="1">
<li>Tenemos un conjunto de datos (incluyendo la respuesta) con el que queremos evaluar la importancia de la variable <span class="math inline">\(x\)</span>.</li>
<li>Ponemos los datos en el árbol, vemos sus predicciones, y evaluamos el error de predicción.</li>
<li>Ahora permutamos al azar la variable <span class="math inline">\(x\)</span> a lo largo de los casos. Ponemos los datos en el árbol, vemos sus predicciones, y evaluamos el error de predicción nuevamente.</li>
<li>El incremento en error de predicción del caso 2 al caso 3 es una medida de la importancia de la variable <span class="math inline">\(x\)</span>.</li>
<li>Podemos repetir este proceso con distintas permutaciones para construir intervalos o errores estándar que nos ayude a interpretar la variabilidad producida por las permutaciones seleccionadas.</li>
</ol>
<p>Veremos ejemplos de este procedimiento más adelante. Por el momento, utilizaremos la implementación clásica para bosques aleatorios, aprovechando los datos OOB. La idea de Breiman original de Breiman es como sigue:</p>
<p>Consideramos un árbol <span class="math inline">\(T^*_j\)</span> del bosque, con muestra bootstrap <span class="math inline">\({\mathcal L}^*_i\)</span>. Calculamos un tipo de error out-of-bag para el árbol, promediando sobre todos los elementos de <span class="math inline">\({\mathcal L}\)</span> que no están en <span class="math inline">\({\mathcal L}^*_i\)</span></p>
<p><span class="math display">\[\widehat{Err}_{oob}(T^*_j) = \frac{1}{A_j}\sum_{(x^{(i)}, y^{(i)}) \in {\mathcal L} -{\mathcal L}^*_i} L(y^{(i)}, T^*_j(x^{(i)}))\]</span> donde <span class="math inline">\(A_j\)</span> es el tamaño de <span class="math inline">\({\mathcal L} -{\mathcal L}^*_i\)</span>.</p>
<p>Ahora <em>permutamos</em> al azar la variable <span class="math inline">\(X_k\)</span> en la muestra OOB <span class="math inline">\({\mathcal L} -{\mathcal L}^*_i\)</span>. Describimos esta operación como <span class="math inline">\(x^{(i)} \to x^{(i)}_k\)</span>. Calculamos el error nuevamente:</p>
<p><span class="math display">\[\widehat{Err}_{k}(T^*_j) = \frac{1}{A_j}\sum_{(x^{(i)}, y^{(i)}) \in {\mathcal L} -{\mathcal L}^*_i} L(y^{(i)}, T^*_j(x_k^{(i)}))\]</span> Ahora calculamos la degradación del error out-of-bag debido a la permutación: <span class="math display">\[ D_k(T_j^*) = \widehat{Err}_{k}(T^*_j) - \widehat{Err}_{oob}(T^*_j) \]</span></p>
<p>Y promediamos sobre el bosque entero <span class="math display">\[I_k =\frac{1}{B} \sum_{j=1}^B D_k(T^*_j)\]</span> y a esta cantidad le llamamos la <strong>importancia</strong> (basada en permutaciones) de la variable <span class="math inline">\(k\)</span> en el bosque aleatorio. Es el decremento promedio de capacidad predictiva cuando “quitamos” la variable <span class="math inline">\(X_k\)</span>.</p>
<p><strong>Observaciones</strong></p>
<ul>
<li>No podemos “quitar” la variable durante el entrenamiento de los árboles, pues entonces otras variables pueden hacer su trabajo, subestimando su importancia.</li>
<li>No podemos “quitar” la variable al medir el error OOB, pues se necesitan todas las variables para poder clasificar con cada árbol (pues cada árbol usa esa variable, o tiene probabilidad de usarla).</li>
<li>Pero podemos permutar a la hora calcular el error OOB (y no durante el entrenamiento), rompiendo la relación que hay entre <span class="math inline">\(X_k\)</span> y la variable respuesta.</li>
<li>Aunque este método lo podemos aplicar para cualquier modelo, la interpretación es más interesante con <em>ensembles</em> como bosques aleatorios, pues en cada corte damos oportunidad a distintas variables de entrar en el modelo. Para un sólo arbol es menos útil, por el problema del “enmascaramiento”.</li>
</ul>
<p>Otra manera de medir importancia para árboles de regresión y clasificación es mediante el decremento de impureza promedio sobre el bosque, para cada variable.</p>
<ul>
<li>Cada vez que una variable aporta un corte en un árbol, la impureza del árbol disminuye.</li>
<li>Sumamos, en cada árbol, todos estos decrementos de impureza (cada vez que aparece la variable en un corte)</li>
<li>Finalmente, promediamos esta medida de importancia dentro de cada árbol sobre el bosque completo.</li>
<li>Repetimos para cada variable.</li>
</ul>
<p>Para árboles de clasificación, usualmente se toma la importancia de Gini, que está basada in la impureza de Gini en lugar de la entropía. La impureza de Gini está dada por <span class="math display">\[I_G(p_1, \ldots, p_K) = \sum_{k=1}^K p_k(1-p_k),\]</span> que es similar a la impureza de entropía que discutimos en la construcción de árboles: <span class="math display">\[I_G(p_1, \ldots, p_K) = \sum_{k=1}^K -p_k\log (p_k),\]</span> Nótese por ejemplo que ambas toman su valor máximo en <span class="math inline">\(p_k=1/K\)</span> (distribución más uniforme posible sobre las clases), y que son iguales a cero cuando <span class="math inline">\(p_k=1\)</span> para alguna <span class="math inline">\(k\)</span>.</p>
<section id="ejemplo-9" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-9">Ejemplo</h4>
<p>En nuestro ejemplo de spam</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>bosque <span class="sc">|&gt;</span> <span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">30</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="ejemplo-10" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="ejemplo-10">Ejemplo</h4>
<p>En el ejemplo de casas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/casas_traducir_geo.R"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1460 Columns: 81
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (43): MSZoning, Street, Alley, LotShape, LandContour, Utilities, LotConf...
dbl (38): Id, MSSubClass, LotFrontage, LotArea, OverallQual, OverallCond, Ye...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 27 Columns: 3
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): Neighborhood
dbl (2): lat, long

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">83</span>)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>casas_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(casas, <span class="at">prop =</span> <span class="fl">0.75</span>)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>casas_entrena <span class="ot">&lt;-</span> <span class="fu">training</span>(casas_split)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>receta_casas <span class="ot">&lt;-</span> <span class="fu">recipe</span>(precio_miles <span class="sc">~</span> </span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>           nombre_zona <span class="sc">+</span> </span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>           area_hab_m2 <span class="sc">+</span> area_garage_m2 <span class="sc">+</span> area_sotano_m2 <span class="sc">+</span> </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>           area_1er_piso_m2 <span class="sc">+</span> area_2o_piso_m2 <span class="sc">+</span> </span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>           area_lote_m2 <span class="sc">+</span> </span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>           año_construccion <span class="sc">+</span> año_venta <span class="sc">+</span> </span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>           calidad_gral <span class="sc">+</span> calidad_garage <span class="sc">+</span> calidad_sotano <span class="sc">+</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>           condicion_gral <span class="sc">+</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>           num_coches  <span class="sc">+</span> </span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>           aire_acondicionado <span class="sc">+</span> condicion_venta, </span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> casas_entrena) <span class="sc">|&gt;</span> </span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_filter</span>(condicion_venta <span class="sc">==</span> <span class="st">"Normal"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ratio</span>(area_2o_piso_m2, <span class="at">denom =</span> <span class="fu">denom_vars</span>(area_1er_piso_m2)) <span class="sc">|&gt;</span> </span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(nombre_zona, <span class="at">threshold =</span> <span class="fl">0.01</span>, <span class="at">other =</span> <span class="st">"otras"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_select</span>(<span class="sc">-</span>condicion_venta, <span class="at">skip =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_novel</span>(nombre_zona, calidad_sotano, calidad_garage) <span class="sc">|&gt;</span> </span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_unknown</span>(calidad_sotano, calidad_garage) <span class="sc">|&gt;</span> </span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">area_sotano_m2 =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(area_sotano_m2), <span class="dv">0</span>, area_sotano_m2)) <span class="sc">|&gt;</span> </span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">area_garage_m2 =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(area_garage_m2), <span class="dv">0</span>, area_garage_m2)) <span class="co">#|&gt; </span></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#step_dummy(nombre_zona, calidad_gral, calidad_garage, calidad_sotano, aire_acondicionado) </span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>modelo_bosque <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="dv">5</span>, <span class="at">trees =</span> <span class="dv">2000</span>) <span class="sc">|&gt;</span> </span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"permutation"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># usar el default "order" es más rápido, pero </span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># para baja cardinalidad se puede usar "partition"</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_args</span>(<span class="at">respect.unordered.factors =</span> <span class="st">"order"</span>) </span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>flujo_bosque <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(modelo_bosque) <span class="sc">|&gt;</span> </span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(receta_casas)</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>bosque_ajustado <span class="ot">&lt;-</span> <span class="fu">fit</span>(flujo_bosque, casas_entrena) <span class="sc">|&gt;</span> </span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>importancias_casas_tbl <span class="ot">&lt;-</span> ranger<span class="sc">::</span><span class="fu">importance</span>(bosque_ajustado) <span class="sc">|&gt;</span> <span class="fu">enframe</span>() <span class="sc">|&gt;</span> </span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">fct_reorder</span>(name, value)) <span class="sc">|&gt;</span> </span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">valor_porc =</span> <span class="dv">100</span> <span class="sc">*</span> value <span class="sc">/</span> bosque_ajustado<span class="sc">$</span>prediction.error)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(importancias_casas_tbl, <span class="fu">aes</span>(<span class="at">x =</span> name, <span class="at">y =</span> valor_porc)) <span class="sc">+</span> </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">coord_flip</span>() <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Incremento % de ecm"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="12-arboles_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Observaciones</strong>:</p>
<ul>
<li>Este análisis nos da una idea de cómo funciona el bosque construido y cómo depende de variables individuales.</li>
<li>Puede adaptarse a cualquier método de predicción. Un equivalente sería hacerlo con las predicciones de validación cruzada o con datos de validación, en lugar de usar los datos OOB.</li>
</ul>
<p>Sin embargo, cuando se usa <em>como método de selección de variables</em> hay que tener algunos cuidados:</p>
<ul>
<li>Cuando tenemos conjuntos de variables correlacionadas, estas medidas tienden a diluir su importancia entre ellas.</li>
<li>Variables de cardinalidad alta tienden a tener importancias más altas (especialmente cuando se usa la importancia de Gini (impureza)).</li>
<li>Algunas variables con importancia alta puede depender de interacciones con otras variables quizá menos importantes.</li>
</ul>
<hr>
</section>
<section id="ajustando-árboles-aleatorios." class="level3" data-number="12.6.1">
<h3 data-number="12.6.1" class="anchored" data-anchor-id="ajustando-árboles-aleatorios."><span class="header-section-number">12.6.1</span> Ajustando árboles aleatorios.</h3>
<ul>
<li>El parámetro más importante de afinar es usualmente <span class="math inline">\(m\)</span>, el número de variables que se escogen al azar en cada nodo.</li>
<li>A veces podemos obtener algunas ventajas de afinar el número mínimo de observaciones por nodo terminal y/o el número mínimo de observaciones por nodo para considerar hacer cortes adicionales</li>
<li>Usualmente corremos tantos árboles como podamos (cientos, miles), o hasta que se estabiliza el error. Aumentar más arboles rara vez producen sobreajuste adicional (aunque esto no quiere decir que los bosques aleatorios no puedan sobreajustar)</li>
</ul>
<p><strong>Implementaciones</strong>: hay distintas implementaciones con diferencias considerables. En nuestros ejemplos usamos el paquete <em>ranger</em>. En esta implementación, por ejemplo, las variables cualitativas se toman como ordenadas (alfabético si no es un factor, en el orden de los factores o, ordenadas según la variable respuesta si se usa la opción <em>respect.unordered.factors = TRUE</em>), ver documentación y referencias asociadas. Se puede usar esta última opción y el bosque resultante no necesariamente agrupa niveles de la variable.</p>
</section>
<section id="ventajas-y-desventajas-de-bosques-aleatorios" class="level3" data-number="12.6.2">
<h3 data-number="12.6.2" class="anchored" data-anchor-id="ventajas-y-desventajas-de-bosques-aleatorios"><span class="header-section-number">12.6.2</span> Ventajas y desventajas de bosques aleatorios</h3>
<p>Ventajas:</p>
<ul>
<li>Entre los métodos estándar, es en general uno de los métodos más competitivos: usualmente tienen tasas muy buenas de error de predicción.</li>
<li>Los bosques aleatorios son relativamente fáciles de entrenar (ajustar usualmente 1 o 2 parámetros) y rápidos de ajustar.</li>
<li>Heredan las ventajas de los árboles: no hay necesidad de transformar variables o construir interacciones (pues los árboles pueden descubrirlas en parte), son robustos a valores atípicos en las variables de entrada.</li>
<li>Igual que con los árboles, las predicciones de los bosques siempre están en el rango de las variables de predicción (no extrapolan)</li>
</ul>
<p>Desventajas:</p>
<ul>
<li>Pueden ser lentos en la predicción, pues muchas veces requieren evaluar grandes cantidades de árboles.</li>
<li>No es tan simple adaptarlos a distintos tipos de problemas (por ejemplo, como redes neuronales, que combinando capas podemos construir modelos ad-hoc a problemas particulares).</li>
<li>La falta de extrapolación puede ser también un defecto (por ejemplo, cuando una estructura lineal aproximada es apropiadas).</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./11-val-cruzada.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Entrenamiento, Validación y Prueba</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./13-arboles-boosting.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Métodos basados en árboles: boosting</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>